=== File gabungan dari: C:/xampp/htdocs/novak_upfloor/app ===
=== Dibuat pada: 2025-11-18 01:03:21 ===



=== START OF FILE: Console\Kernel.php ===
<?php

namespace App\Console;

use Illuminate\Console\Scheduling\Schedule;
use Illuminate\Foundation\Console\Kernel as ConsoleKernel;

class Kernel extends ConsoleKernel
{
    /**
     * Define the application's command schedule.
     *
     * @param  \Illuminate\Console\Scheduling\Schedule  $schedule
     * @return void
     */
    protected function schedule(Schedule $schedule)
    {
        // Clean expired sessions every hour
        $schedule->command('session:clean')->hourly();
    }

    /**
     * Register the commands for the application.
     *
     * @return void
     */
    protected function commands()
    {
        $this->load(__DIR__.'/Commands');

        require base_path('routes/console.php');
    }
}

=== END OF FILE: Console\Kernel.php ===


=== START OF FILE: Console\Commands\CleanExpiredSessions.php ===
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use App\Helpers\SessionHelper;

class CleanExpiredSessions extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'session:clean';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Clean expired sessions from database';

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $this->info('Starting session cleanup (Hard Delete)...');
        
        $cleanedCount = SessionHelper::cleanExpiredSessions();
        
        $this->info("Hard deleted {$cleanedCount} expired sessions from database.");
        
        // Since we're using hard delete, no need to clean old inactive sessions
        // All sessions are deleted when they expire or are logged out
        
        return Command::SUCCESS;
    }
}

=== END OF FILE: Console\Commands\CleanExpiredSessions.php ===


=== START OF FILE: Exceptions\Handler.php ===
<?php

namespace App\Exceptions;

use Illuminate\Foundation\Exceptions\Handler as ExceptionHandler;
use Throwable;

class Handler extends ExceptionHandler
{
    /**
     * A list of exception types with their corresponding custom log levels.
     *
     * @var array<class-string<\Throwable>, \Psr\Log\LogLevel::*>
     */
    protected $levels = [
        //
    ];

    /**
     * A list of the exception types that are not reported.
     *
     * @var array<int, class-string<\Throwable>>
     */
    protected $dontReport = [
        //
    ];

    /**
     * A list of the inputs that are never flashed to the session on validation exceptions.
     *
     * @var array<int, string>
     */
    protected $dontFlash = [
        'current_password',
        'password',
        'password_confirmation',
    ];

    /**
     * Register the exception handling callbacks for the application.
     *
     * @return void
     */
    public function register()
    {
        $this->reportable(function (Throwable $e) {
            //
        });
    }
}

=== END OF FILE: Exceptions\Handler.php ===


=== START OF FILE: Helpers\Tanggal.php ===
<?php
function tanggal($perintah,$tanggal)
{
	if($perintah=="hari") {
		$bulan 	= date('m',strtotime($tanggal));
		$hari 	= date('l',strtotime($tanggal));

		if($hari=='Sunday') {
			$nama_hari = 'Minggu';
		}elseif($hari=='Monday') {
			$nama_hari = 'Senin';
		}elseif($hari=='Tuesday') {
			$nama_hari = 'Selasa';
		}elseif($hari=='Wednesday') {
			$nama_hari = 'Rabu';
		}elseif($hari=='Thursday') {
			$nama_hari = 'Kamis';
		}elseif($hari=='Friday') {
			$nama_hari = 'Jumat';
		}elseif($hari=='Saturday') {
			$nama_hari = 'Sabtu';
		}

		if($bulan=='01') {
			$nama_bulan = 'Januari';
		}elseif($bulan=='02') {
			$nama_bulan = 'Februari';
		}elseif($bulan=='03') {
			$nama_bulan = 'Maret';
		}elseif($bulan=='04') {
			$nama_bulan = 'April';
		}elseif($bulan=='05') {
			$nama_bulan = 'Mei';
		}elseif($bulan=='06') {
			$nama_bulan = 'Juni';
		}elseif($bulan=='07') {
			$nama_bulan = 'Juli';
		}elseif($bulan=='08') {
			$nama_bulan = 'Agustus';
		}elseif($bulan=='09') {
			$nama_bulan = 'September';
		}elseif($bulan=='10') {
			$nama_bulan = 'Oktober';
		}elseif($bulan=='11') {
			$nama_bulan = 'November';
		}elseif($bulan=='12') {
			$nama_bulan = 'Desember';
		}

		$hasil = $nama_hari.', '.date('d',strtotime($tanggal)).' '.$nama_bulan.' '.date('Y',strtotime($tanggal));
		// Output
		return $hasil;
	}elseif($perintah=="tanggal_id") {
		if($tanggal=='' || $tanggal==NULL || $tanggal=='0000-00-00' || $tanggal=='1970-01-01') {
			return FALSE;
		}else{
			$hasil = date('d-m-Y',strtotime($tanggal));
			return $hasil;
		}
	}elseif($perintah=="tanggal_bulan") {
		if($tanggal=='' || $tanggal==NULL || $tanggal=='0000-00-00' || $tanggal=='1970-01-01') {
			return FALSE;
		}else{
			$hasil = date('Y-m-d',strtotime($tanggal));
			return $hasil;
		}
	}elseif($perintah=="tanggal_input") {
		if($tanggal=='' || $tanggal==NULL || $tanggal=='0000-00-00' || $tanggal == '1970-01-01') {
			$hasil = NULL;
			return $hasil;
		}else{
			
			$hasil = date('Y-m-d',strtotime($tanggal));
			return $hasil;
		}
	}elseif($perintah=="tanggal_bulan") {
		if($tanggal=='' || $tanggal==NULL || $tanggal=='0000-00-00' || $tanggal == '1970-01-01') {
			$hasil = '';
			return $hasil;
		}else{
			$bulan 	= date('m',strtotime($tanggal));
			$hari 	= date('l',strtotime($tanggal));
			if($hari=='Sunday') {
				$nama_hari = 'Minggu';
			}elseif($hari=='Monday') {
				$nama_hari = 'Senin';
			}elseif($hari=='Tuesday') {
				$nama_hari = 'Selasa';
			}elseif($hari=='Wednesday') {
				$nama_hari = 'Rabu';
			}elseif($hari=='Thursday') {
				$nama_hari = 'Kamis';
			}elseif($hari=='Friday') {
				$nama_hari = 'Jumat';
			}elseif($hari=='Saturday') {
				$nama_hari = 'Sabtu';
			}
			if($bulan=='01') {
				$nama_bulan = 'Januari';
			}elseif($bulan=='02') {
				$nama_bulan = 'Februari';
			}elseif($bulan=='03') {
				$nama_bulan = 'Maret';
			}elseif($bulan=='04') {
				$nama_bulan = 'April';
			}elseif($bulan=='05') {
				$nama_bulan = 'Mei';
			}elseif($bulan=='06') {
				$nama_bulan = 'Juni';
			}elseif($bulan=='07') {
				$nama_bulan = 'Juli';
			}elseif($bulan=='08') {
				$nama_bulan = 'Agustus';
			}elseif($bulan=='09') {
				$nama_bulan = 'September';
			}elseif($bulan=='10') {
				$nama_bulan = 'Oktober';
			}elseif($bulan=='11') {
				$nama_bulan = 'November';
			}elseif($bulan=='12') {
				$nama_bulan = 'Desember';
			}
			$hasil = date('d',strtotime($tanggal)).' '.$nama_bulan.' '.date('Y',strtotime($tanggal));
			return $hasil;
		}
	}
	
}

=== END OF FILE: Helpers\Tanggal.php ===


=== START OF FILE: Helpers\Website.php ===
<?php
use Illuminate\Support\Facades\DB;

function website($perintah='')
{
	// Load model
	$site = DB::table('konfigurasi')->first();
	// User
	if($perintah=='lengkap') {
		$hasil = $site->namaweb.' | '.$site->tagline;
	}elseif($perintah=="tagline") {
		$hasil = $site->tagline;
	}elseif($perintah=="logo") {
		$hasil = $site->logo;
	}elseif($perintah=="icon") {
		$hasil = $site->icon;
	}else{
		$hasil = $site->namaweb;
	}
	// Output
	return $hasil;
}

=== END OF FILE: Helpers\Website.php ===


=== START OF FILE: Http\Kernel.php ===
<?php

namespace App\Http;

use Illuminate\Foundation\Http\Kernel as HttpKernel;

class Kernel extends HttpKernel
{
    /**
     * The application's global HTTP middleware stack.
     *
     * These middleware are run during every request to your application.
     *
     * @var array<int, class-string|string>
     */
    protected $middleware = [
        // \App\Http\Middleware\TrustHosts::class,
        \App\Http\Middleware\TrustProxies::class,
        \Illuminate\Http\Middleware\HandleCors::class,
        \App\Http\Middleware\PreventRequestsDuringMaintenance::class,
        \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,
        \App\Http\Middleware\TrimStrings::class,
        \Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class,
    ];

    /**
     * The application's route middleware groups.
     *
     * @var array<string, array<int, class-string|string>>
     */
    protected $middlewareGroups = [
        'web' => [
            \App\Http\Middleware\EncryptCookies::class,
            \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
            \Illuminate\Session\Middleware\StartSession::class,
            \Illuminate\View\Middleware\ShareErrorsFromSession::class,
            \App\Http\Middleware\VerifyCsrfToken::class,
            \Illuminate\Routing\Middleware\SubstituteBindings::class,
        ],

        'api' => [
            // \Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful::class,
            'throttle:api',
            \Illuminate\Routing\Middleware\SubstituteBindings::class,
        ],

        'api.session' => [
            'throttle:api',
            \Illuminate\Routing\Middleware\SubstituteBindings::class,
            \App\Http\Middleware\SessionMiddleware::class,
        ],
    ];

    /**
     * The application's route middleware.
     *
     * These middleware may be assigned to groups or used individually.
     *
     * @var array<string, class-string|string>
     */
    protected $routeMiddleware = [
        'auth' => \App\Http\Middleware\Authenticate::class,
        'auth.basic' => \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,
        'auth.session' => \Illuminate\Session\Middleware\AuthenticateSession::class,
        'cache.headers' => \Illuminate\Http\Middleware\SetCacheHeaders::class,
        'can' => \Illuminate\Auth\Middleware\Authorize::class,
        'guest' => \App\Http\Middleware\RedirectIfAuthenticated::class,
        'password.confirm' => \Illuminate\Auth\Middleware\RequirePassword::class,
        'signed' => \App\Http\Middleware\ValidateSignature::class,
        'throttle' => \Illuminate\Routing\Middleware\ThrottleRequests::class,
        'verified' => \Illuminate\Auth\Middleware\EnsureEmailIsVerified::class,
        'session' => \App\Http\Middleware\SessionMiddleware::class,
        'mobile.session' => \App\Http\Middleware\MobileSessionMiddleware::class,
        'auth.token' => \App\Http\Middleware\AuthenticateToken::class,
    ];
}

=== END OF FILE: Http\Kernel.php ===


=== START OF FILE: Http\Controllers\Berita.php ===
<?php
namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Pagination\Paginator;
// Menggunakan alias 'BeritaModel' untuk menghindari bentrok nama
use App\Models\Berita as BeritaModel; 

class Berita extends Controller
{
    // Halaman utama daftar berita
    public function index()
    {
        Paginator::useBootstrap();
        $site   = DB::table('konfigurasi')->first();
        $model  = new BeritaModel();

        $berita = $model->listing();
        $beritas = $model->home();
        $layanan = DB::table('berita')->where(array('jenis_berita' => 'Layanan','status_berita' => 'Publish'))->orderBy('urutan', 'ASC')->get();

        $data = array(
            'title'     => 'Berita dan Update',
            'deskripsi' => 'Berita dan Update',
            'keywords'  => 'Berita dan Update',
            'site'      => $site,
            'berita'    => $berita,
            'beritas'   => $beritas,
            'layanan'   => $layanan,
            'content'   => 'berita/index'
        );
        return view('layout/wrapper', $data);
    }

    // Halaman kategori berita
    public function kategori($slug_kategori)
    {
        Paginator::useBootstrap();
        $site     = DB::table('konfigurasi')->first();
        $kategori = DB::table('kategori')->where('slug_kategori', $slug_kategori)->first();
        $model    = new BeritaModel();
        $berita   = $model->all_kategori($kategori->id_kategori);
        $beritas  = $model->home();
        $layanan  = DB::table('berita')->where(array('jenis_berita' => 'Layanan','status_berita' => 'Publish'))->orderBy('urutan', 'ASC')->get();

        $data = array(
            'title'     => $kategori->nama_kategori,
            'deskripsi' => $kategori->nama_kategori,
            'keywords'  => $kategori->nama_kategori,
            'site'      => $site,
            'berita'    => $berita,
            'beritas'   => $beritas,
            'layanan'   => $layanan,
            'content'   => 'berita/index'
        );
        return view('layout/wrapper', $data);
    }

    // Halaman detail berita
    public function read($slug_berita)
    {
        $site    = DB::table('konfigurasi')->first();
        $model   = new BeritaModel();
        $berita  = $model->read($slug_berita);
        $beritas = $model->home();

        // --- PERBAIKAN DI SINI ---
        // Jika berita tidak ditemukan, alihkan ke halaman utama berita
        if(!$berita)
        {
            return redirect('berita');
        }
        // --- AKHIR PERBAIKAN ---

        $data = array(
            'title'     => $berita->judul_berita,
            'deskripsi' => $berita->judul_berita,
            'keywords'  => $berita->judul_berita,
            'site'      => $site,
            'berita'    => $berita,
            'beritas'   => $beritas,
            'content'   => 'berita/read'
        );
        return view('layout/wrapper', $data);
    }

    public function layanan($slug_berita)
    {
        Paginator::useBootstrap();
        $site    = DB::table('konfigurasi')->first();
        $model   = new BeritaModel();
        $berita  = $model->read($slug_berita);
        $layanan = DB::table('berita')->where(array('jenis_berita' => 'Layanan','status_berita' => 'Publish'))->orderBy('urutan', 'ASC')->get();
        if(!$berita)
        {
            return redirect('berita');
        }

        $data = array(  'title'     => $berita->judul_berita,
                        'deskripsi' => $berita->judul_berita,
                        'keywords'  => $berita->judul_berita,
                        'site'      => $site,
                        'berita'    => $berita,
                        'layanan'   => $layanan,
                        'content'   => 'berita/layanan'
                    );
        return view('layout/wrapper', $data);
    }

    public function terjadi($slug_berita)
    {
        Paginator::useBootstrap();
        $site    = DB::table('konfigurasi')->first();
        $model   = new BeritaModel();
        $berita  = $model->read($slug_berita);
        $layanan = DB::table('berita')->where(array('jenis_berita' => 'Layanan','status_berita' => 'Publish'))->orderBy('urutan', 'ASC')->get();
        if(!$berita)
        {
            return redirect('berita');
        }

        $data = array(  'title'     => $berita->judul_berita,
                        'deskripsi' => $berita->judul_berita,
                        'keywords'  => $berita->judul_berita,
                        'site'      => $site,
                        'berita'    => $berita,
                        'layanan'   => $layanan,
                        'content'   => 'berita/terjadi'
                    );
        return view('layout/wrapper', $data);
    }
}

=== END OF FILE: Http\Controllers\Berita.php ===


=== START OF FILE: Http\Controllers\Controller.php ===
<?php
// Setting controller
namespace App\Http\Controllers;

use Illuminate\Foundation\Auth\Access\AuthorizesRequests;
use Illuminate\Foundation\Bus\DispatchesJobs;
use Illuminate\Foundation\Validation\ValidatesRequests;
use Illuminate\Routing\Controller as BaseController;

class Controller extends BaseController
{
    use AuthorizesRequests, DispatchesJobs, ValidatesRequests;
}

=== END OF FILE: Http\Controllers\Controller.php ===


=== START OF FILE: Http\Controllers\DownloadController.php ===
<?php

namespace App\Http\Controllers;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Illuminate\Pagination\Paginator;
use App\Models\Download;

class DownloadController extends Controller
{
    // Main page
    public function index()
    {
        Paginator::useBootstrap();
        $kategori_download = DB::table('kategori_download')
                    ->orderBy('kategori_download.urutan','ASC')
                    ->get();

		$data = array(  'title'		             => 'Dokumen '.website('namaweb'),
						'deskripsi'	          => 'Dokumen '.website('namaweb'),
						'keywords'	           => 'Dokumen '.website('namaweb'),
						'kategori_download'	  => $kategori_download,
                        'content'	          => 'download/kategori'
                    );
        return view('layout/wrapper',$data);
    }

    // Main page
    public function kategori($slug_kategori_download)
    {
        Paginator::useBootstrap();
        $kategori   = DB::table('kategori_download')
                    ->where('kategori_download.slug_kategori_download',$slug_kategori_download)
                    ->first();
        $download = DB::table('download')
                    ->join('kategori_download', 'kategori_download.id_kategori_download', '=', 'download.id_kategori_download','LEFT')
                    ->select('download.*', 'kategori_download.nama_kategori_download')
                    ->where('download.id_kategori_download',$kategori->id_kategori_download)
                    ->orderBy('download.id_download','DESC')
                    ->paginate(25);

        $data = array(  'title'     => $kategori->nama_kategori_download,
                        'deskripsi' => $kategori->nama_kategori_download,
                        'keywords'  => $kategori->nama_kategori_download,
                        'downloads' => $download,
                        'kategori'  => $kategori,
                        'content'   => 'download/index'
                    );
        return view('layout/wrapper',$data);
    }

    // detail
    public function detail($id_download,$slug_download)
    {
        $mydownload = new Download();
        $download   = $mydownload->detail($id_download);
        $hits       = $download->hits+1;
        DB::table('download')->where('id_download',$download->id_download)->update([
            'hits'      => $hits
        ]);
        $data = array(  'title'     => $download->judul_download,
                        'deskripsi' => $download->judul_download,
                        'keywords'  => $download->judul_download,
                        'download'  => $download,
                        'content'   => 'download/detail'
                    );
        return view('layout/wrapper',$data);
    }

    // Unduh
    public function unduh($id_download)
    {
        $mydownload = new Download();
        $download   = $mydownload->detail($id_download);
        $hits       = $download->hits+1;
        DB::table('download')->where('id_download',$download->id_download)->update([
            'hits'      => $hits
        ]);
        $pathToFile           = './assets/upload/file/'.$download->gambar;
        return response()->download($pathToFile, $download->gambar);
    }

}

=== END OF FILE: Http\Controllers\DownloadController.php ===


=== START OF FILE: Http\Controllers\ForgotPasswordController.php ===
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Carbon\Carbon;
use Illuminate\Support\Facades\Mail;

class ForgotPasswordController extends Controller
{
    /**
     * Menampilkan halaman form untuk memasukkan email
     */
    public function showLinkRequestForm()
    {
        $site = DB::table('konfigurasi')->first();
        $data = [
            'title' => 'Lupa Password',
            'site'  => $site
        ];
        return view('login.forgot-password', $data);
    }

    /**
     * Mengirim link reset password ke email pengguna
     */
    public function sendResetLinkEmail(Request $request)
    {
        $request->validate(['email' => 'required|email']);

        $user = DB::table('users')->where('email', $request->email)->first();

        if (!$user) {
            return back()->with(['warning' => 'Email tidak terdaftar di sistem kami.']);
        }

        // Buat token reset password
        $token = Str::random(60);

        // Simpan token ke database (kita akan buat tabel baru)
        DB::table('password_resets')->insert([
            'email' => $request->email,
            'token' => $token,
            'created_at' => Carbon::now()
        ]);

        // Kirim email menggunakan Mailable class
        try {
            Mail::to($request->email)->send(new \App\Mail\PasswordResetEmail($request->email, $token));
        } catch (\Exception $e) {
            \Log::error('Password reset email failed to send: '.$e->getMessage());
        }

        return redirect('login')->with(['sukses' => 'Link reset password telah dikirim ke email Anda.']);
    }

    /**
     * Menampilkan form untuk reset password
     */
    public function showResetForm(Request $request, $token = null)
    {
        $site = DB::table('konfigurasi')->first();
        $data = [
            'title' => 'Reset Password',
            'site'  => $site,
            'token' => $token
        ];
        return view('login.reset-password', $data);
    }

    /**
     * Memproses reset password
     */
    public function reset(Request $request)
    {
        $request->validate([
            'token' => 'required',
            'email' => 'required|email',
            'password' => 'required|confirmed|min:6',
        ]);

        $reset = DB::table('password_resets')
                    ->where('email', $request->email)
                    ->where('token', $request->token)
                    ->first();

        if (!$reset) {
            return back()->with(['warning' => 'Token reset password tidak valid atau email salah.']);
        }
        
        // Update password di tabel users
        DB::table('users')->where('email', $request->email)->update([
            'password' => sha1($request->password) // Enkripsi menggunakan sha1
        ]);

        // Hapus token yang sudah digunakan
        DB::table('password_resets')->where('email', $request->email)->delete();

        return redirect('login')->with(['sukses' => 'Password Anda berhasil diubah. Silakan login dengan password baru.']);
    
    
    
    }

}

=== END OF FILE: Http\Controllers\ForgotPasswordController.php ===


=== START OF FILE: Http\Controllers\GaleriController.php ===
<?php

namespace App\Http\Controllers;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use App\Models\Galeri;

class GaleriController extends Controller
{
    // Main page
    public function index()
    {
        $galeri = DB::table('galeri')
                    ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
                    ->select('galeri.*', 'kategori_galeri.nama_kategori_galeri')
                    ->orderBy('galeri.id_galeri','DESC')
                    ->paginate(10);
       	$site 	= DB::table('konfigurasi')->first();

		$data = array(  'title'		=> 'Galeri '.$site->namaweb,
						'deskripsi'	=> 'Galeri '.$site->namaweb,
						'keywords'	=> 'Galeri '.$site->namaweb,
						'galeris'	=> $galeri,
						'site'		=> $site,
                        'content'	=> 'galeri/index'
                    );
        return view('layout/wrapper',$data);
    }

     // detail
    public function detail($id_galeri)
    {
        $galeri = DB::table('galeri')
                    ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
                    ->select('galeri.*', 'kategori_galeri.nama_kategori_galeri')
                    ->where('galeri.id_galeri',$id_galeri)
                    ->orderBy('galeri.id_galeri','DESC')
                    ->first();
        $hits       = $galeri->hits+1;
        DB::table('galeri')->where('id_galeri',$galeri->id_galeri)->update([
            'hits'      => $hits
        ]);
        $data = array(  'title'		=> $galeri->judul_galeri,
						'deskripsi'	=> $galeri->judul_galeri,
						'keywords'	=> $galeri->judul_galeri,
						'galeri'	=> $galeri,
                        'content'	=> 'galeri/detail'
                    );
        return view('layout/wrapper',$data);
    }

}

=== END OF FILE: Http\Controllers\GaleriController.php ===


=== START OF FILE: Http\Controllers\Home.php ===
<?php
namespace App\Http\Controllers;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use App\Models\Rekening;
use App\Models\Berita;
use App\Models\Staff;
use App\Models\Download;
use App\Models\Property;
use App\Models\Proyek;
use App\Models\Promosi;
use PDF;
use App\Services\WaisakaAiService;

class Home extends Controller
{
    // Homepage
    public function index()
    {
    	$site_config   = DB::table('konfigurasi')->first();
        $kategori_property = DB::table('kategori_property')->orderBy('urutan','ASC')->get();
        $video          = DB::table('video')->orderBy('id_video','DESC')->first();
    	$slider         = DB::table('galeri')->where('jenis_galeri','Homepage')->limit(5)->orderBy('id_galeri', 'DESC')->get();
        $layanan        = DB::table('berita')->where(array('jenis_berita'=>'Layanan','status_berita'=>'Publish'))->limit(3)->orderBy('urutan', 'ASC')->get();
        $news           = new Berita();
        $myproperty     = new Property();
        $berita         = $news->home();

        // Get promotion slideshow from database
        $promosi = Promosi::getSlideshow();

        $property = $myproperty->semua_raw();
        $property = $property->orderByRaw('property_db.tanggal desc')->limit(6)->get();

        $data = array(  'title'         => $site_config->namaweb.' - '.$site_config->tagline,
                        'deskripsi'     => $site_config->namaweb.' - '.$site_config->tagline,
                        'keywords'      => $site_config->namaweb.' - '.$site_config->tagline,
                        'slider'        => $slider,
                        'promosi'       => $promosi,
                        'site_config'   => $site_config,
                        'properties'    => $property,
                        'berita'        => $berita,
                        'beritas'       => $berita,
                        'layanan'       => $layanan,
                        'video'         => $video,
                        'kategori_property' => $kategori_property,
                        'content'       => 'home/index'
                    );
        return view('layout/wrapper',$data);
    }

    public function search($tipe, Request $request)
    {
    	$site_config   = DB::table('konfigurasi')->first();
        $kategori_property = DB::table('kategori_property')->orderBy('urutan','ASC')->get();
        $news           = new Berita();
        $myproperty     = new Property();
        $berita         = $news->home();
        $layanan        = DB::table('berita')->where(array('jenis_berita'=>'Layanan','status_berita'=>'Publish'))->limit(3)->orderBy('urutan', 'ASC')->get();

        //Filter
        $id_kategori_property = $request->id_kategori_property;
        $listing_type       = ($tipe=='jual') ? '1' : '2'; 
        $location           = $request->location;
        $price_from         = $request->price_from;
        $price_to           = $request->price_to;
        $bedrooms           = $request->bedrooms;
        $bathrooms          = $request->bathrooms;
        $landsize_from      = $request->landsize_from;
        $landsize_to        = $request->landsize_to;
        $buildingsize_from  = $request->buildingsize_from;
        $buildingsize_to    = $request->buildingsize_to;
        $certificates       = $request->certificates;
        $limit              = ($request->limit) ? $request->limit : '9';
        $order              = ($request->order) ? $request->order : 'newest';
       
        switch ($order) {
            case 'newest':
                $orderData = 'property_db.tanggal desc';
                break;
            case 'price_desc':
                $orderData = 'property_db.harga desc';
                break;
            case 'price_asc':
                $orderData = 'property_db.harga';
                break;
            default:
                $orderData = 'property_db.tanggal';
          }

        $priceArray = [50000000,100000000,500000000,1000000000,3000000000,5000000000,7000000000,10000000000,15000000000,20000000000,30000000000,50000000000,75000000000,100000000000];
        $bedroomArray   = [1,2,3,4];
        $bathroomsArray = [1,2,3,4,5,6];
        $certificatesArray = ['SHM' => 'SHM - Sertifikat Hak Milik','HGB' => 'HGB - Hak Guna Bangunan','other' => 'Lainnya (PPJB, Girik, Adat, dll)'];
        $limit          = $limit;

        $where = array(
            'property_db.tipe' => $tipe,
        );  

        $property = $myproperty->semua_raw($where);
        if($location != '') {
            $item = explode(", ",$location);
            if(count($item) >= 3 ) {
                $kecamatan = strtolower($item[0]);
                $kabupaten = strtolower($item[1]);
                $provinsi = strtolower($item[2]);

                $whereRaw = " (LOWER(kecamatan.nama) LIKE '%".$kecamatan."%' AND LOWER(kabupaten.nama) LIKE '%".$kabupaten."%' AND LOWER(provinsi.nama) LIKE '%".$provinsi."%') ";
            }
            else if(count($item) == 2 ) {
                $kabupaten = $item[0];
                $provinsi = $item[1];

                $whereRaw = " (LOWER(kabupaten.nama) LIKE '%".$kabupaten."%' AND LOWER(provinsi.nama) LIKE '%".$provinsi."%') ";
            }
            else if(count($item) == 1 ) {
                $item = $item[0];
                $whereRaw = " (LOWER(kecamatan.nama) LIKE '%".$item."%' OR LOWER(kabupaten.nama) LIKE '%".$item."%' OR LOWER(provinsi.nama) LIKE '%".$item."%') ";
            }
            
            $property->whereRaw($whereRaw);
        }
		if($id_kategori_property != '') {
            $property->where('property_db.id_kategori_property',$id_kategori_property);
        }
        if($price_from != '' && $price_to != '') {
            $property->whereBetween('property_db.harga', [$price_from, $price_to]);
        } elseif ($price_from != '') {
            $property->where('property_db.harga', '>=', $price_from);
        } elseif ($price_to != '') {
            $property->where('property_db.harga', '<=', $price_to);
        }
        if($bedrooms != '') {
            if($bedrooms != '5+') {
                $property->where('property_db.kamar_tidur',$bedrooms);
            } else {
                $property->where('property_db.kamar_tidur','>=',5);
            }
        }
        if($bathrooms != '') {
            if($bathrooms != '7+') {
                $property->where('property_db.kamar_mandi',$bathrooms);
            } else {
                $property->where('property_db.kamar_mandi','>=',7);
            }
        }
        if($landsize_from >= 0 && $landsize_to > 0 ) {
            $property->whereBetween('property_db.lt', [$landsize_from, $landsize_to]);
        }
        if($buildingsize_from >= 0 && $buildingsize_to > 0) {
            $property->whereBetween('property_db.lb', [$buildingsize_from, $buildingsize_to]);
        }
        if($certificates != '') {
            $property->where('property_db.surat',$certificates);
        }
        $property = $property->orderByRaw($orderData)->paginate($limit);

        $data = array(  'title'         => $site_config->namaweb.' - '.$site_config->tagline,
                        'deskripsi'     => $site_config->namaweb.' - '.$site_config->tagline,
                        'keywords'      => $site_config->namaweb.' - '.$site_config->tagline,
                        'site_config'   => $site_config,
                        'berita'        => $berita,
                        'layanan'       => $layanan,
                        'properties'    => $property,
                        'priceArray'    => $priceArray,
                        'bedroomArray'  => $bedroomArray,
                        'bathroomsArray'=> $bathroomsArray,
                        'certificatesArray' => $certificatesArray,
                        'kategori_property'     => $kategori_property,
                        'id_kategori_property'  => $id_kategori_property,
                        'listing_type'          => $listing_type,
                        'location'              => $location,
                        'price_from'            => $price_from,
                        'price_to'              => $price_to,
                        'bedrooms'              => $bedrooms,
                        'bathrooms'             => $bathrooms,
                        'landsize_from'         => $landsize_from,
                        'landsize_to'           => $landsize_to,
                        'buildingsize_from'     => $buildingsize_from,
                        'buildingsize_to'       => $buildingsize_to,
                        'certificates'          => $certificates,
                        'limit'         => $limit,
                        'order'         => $order,
                        'content'       => 'home/search'
                    );
        return view('layout/wrapper',$data);
    }

    public function search_kontraktor($tipe, Request $request)
    {
    	$site_config  = DB::table('konfigurasi')->first();
        $news         = new Berita();
        $myproyek     = new Proyek();
        $berita       = $news->home();
        $layanan      = DB::table('berita')->where(array('jenis_berita'=>'Layanan','status_berita'=>'Publish'))->limit(3)->orderBy('urutan', 'ASC')->get();
        
        //Filter
        $listing_type       = ($tipe=='done') ? '1' : '2'; 
        $location           = $request->location;
        $landsize_from      = $request->landsize_from;
        $landsize_to        = $request->landsize_to;
        $buildingsize_from  = $request->buildingsize_from;
        $buildingsize_to    = $request->buildingsize_to;
        $limit              = ($request->limit) ? $request->limit : '9';
        $order              = ($request->order) ? $request->order : 'newest';
       
        switch ($order) {
            case 'newest':
                $orderData = 'proyek.tanggal desc';
                break;
            default:
                $orderData = 'proyek.tanggal desc';
          }

        $limit          = $limit;

        $where = array(
            'proyek.tipe' => $tipe,
        );  

        $proyek = $myproyek->semua_raw($where);
        if($location != '') {
            $item = explode(", ",$location);
            if(count($item) >= 3 ) {
                $kecamatan = strtolower($item[0]);
                $kabupaten = strtolower($item[1]);
                $provinsi = strtolower($item[2]);

                $whereRaw = " (LOWER(kecamatan.nama) LIKE '%".$kecamatan."%' AND LOWER(kabupaten.nama) LIKE '%".$kabupaten."%' AND LOWER(provinsi.nama) LIKE '%".$provinsi."%') ";
            }
            else if(count($item) == 2 ) {
                $kabupaten = $item[0];
                $provinsi = $item[1];

                $whereRaw = " (LOWER(kabupaten.nama) LIKE '%".$kabupaten."%' AND LOWER(provinsi.nama) LIKE '%".$provinsi."%') ";
            }
            else if(count($item) == 1 ) {
                $item = $item[0];
                $whereRaw = " (LOWER(kecamatan.nama) LIKE '%".$item."%' OR LOWER(kabupaten.nama) LIKE '%".$item."%' OR LOWER(provinsi.nama) LIKE '%".$item."%') ";
            }
            
            $proyek->whereRaw($whereRaw);
        }
        if($landsize_from >= 0 && $landsize_to > 0 ) {
            $proyek->whereBetween('proyek.lt', [$landsize_from, $landsize_to]);
        }
        if($buildingsize_from >= 0 && $buildingsize_to > 0) {
            $proyek->whereBetween('proyek.lb', [$buildingsize_from, $buildingsize_to]);
        }
        $proyek = $proyek->orderByRaw($orderData)->paginate($limit);

        $data = array(  'title'         => $site_config->namaweb.' - '.$site_config->tagline,
                        'deskripsi'     => $site_config->namaweb.' - '.$site_config->tagline,
                        'keywords'      => $site_config->namaweb.' - '.$site_config->tagline,
                        'site_config'   => $site_config,
                        'berita'        => $berita,
                        'layanan'       => $layanan,
                        'projects'      => $proyek,
                        'listing_type'          => $listing_type,
                        'location'              => $location,
                        'landsize_from'         => $landsize_from,
                        'landsize_to'           => $landsize_to,
                        'buildingsize_from'     => $buildingsize_from,
                        'buildingsize_to'       => $buildingsize_to,
                        'limit'         => $limit,
                        'order'         => $order,
                        'content'       => 'home/search_kontraktor'
                    );
        return view('layout/wrapper',$data);
    }

    public function properti($id_property)
    {
        $site_config    = DB::table('konfigurasi')->first();
        
        $myproperty     = new Property();
        $property       = $myproperty->detail($id_property);

        if (!$property) {
            abort(404);
        }

        // Auto-enrichment dengan AI langsung (tanpa layer PropertyInsightService)
        $aiService = app(WaisakaAiService::class);

        // 1. Check & enrich harga_rata
        if(trim((string) ($property->harga_rata ?? '')) == '') {
            $this->enrichHargaRata($property, $aiService);
        }

        // 2. Check & enrich fasilitas_terdekat
        if(trim((string) ($property->fasilitas_terdekat ?? '')) == '') {
            $this->enrichFasilitasTerdekat($property, $aiService);
        }

        // 3. Check & enrich peta_map
        if(trim((string) ($property->peta_map ?? '')) == '') {
            $this->enrichPetaMap($property, $aiService);
        }

        $images         = DB::table('property_img')->where('id_property',$property->id_property)->orderBy('index_img')->get();
        $mystaff        = new Staff();
        $staff          = $mystaff->detail($property->id_staff);
        $news           = new Berita();
        $berita         = $news->home();

        $gambar = [];
        foreach($images as $key => $img) {
            $gambar[$key] = $img;
        }

        $data = array(  'title'             => $property->slug_property,
                        'deskripsi'         => $property->nama_property,
                        'keywords'          => $site_config->namaweb.' - '.$site_config->tagline,
                        'site_config'       => $site_config,
                        'berita'            => $berita,
                        'property'          => $property,
                        'images'            => $images,
                        'staff'             => $staff,

                        'og_site_name'      => strtolower(str_replace(' ','',$site_config->namaweb)),
                        'og_title'          => $staff->nama_staff,
                        'og_image'          => asset('assets/upload/property/'.$img->gambar),
                        'og_description'    => 'Agent of '.$site_config->namaweb,
                        'og_url'            => asset('agent/'.$staff->id_staff),

                        'content'           => 'home/properti'
                    );
        return view('layout/wrapper',$data);
    }

    public function proyek($id_proyek)
    {
        $site_config    = DB::table('konfigurasi')->first();
        
        $myproyek       = new Proyek();
        $proyek         = $myproyek->detail($id_proyek);
        $images         = DB::table('proyek_img')->where('id_proyek',$proyek->id_proyek)->orderBy('index_img')->get();
        $news           = new Berita();
        $berita         = $news->home();

        $gambar = [];
        foreach($images as $key => $img) {
            $gambar[$key] = $img;
        }

        $data = array(  'title'             => $proyek->slug_proyek,
                        'deskripsi'         => $proyek->nama_proyek,
                        'keywords'          => $site_config->namaweb.' - '.$site_config->tagline,
                        'site_config'       => $site_config,
                        'berita'            => $berita,
                        'proyek'            => $proyek,
                        'images'            => $images,
                        'staff'             => DB::table('staff')->first(),

                        'content'           => 'home/proyek'
                    );
        return view('layout/wrapper',$data);
    }

    public function agent($id_staff, Request $request)
    {
        $site_config    = DB::table('konfigurasi')->first();
        
        $mystaff        = new Staff();
        $staff          = $mystaff->detail($id_staff);
        $myproperty     = new Property();
        $news           = new Berita();
        $berita         = $news->home();
        $limit          = ($request->limit) ? $request->limit : '9';
        $order          = ($request->order) ? $request->order : 'newest';
       
        switch ($order) {
            case 'newest':
                $orderData = 'property_db.tanggal';
                break;
            case 'price_desc':
                $orderData = 'property_db.harga desc';
                break;
            case 'price_asc':
                $orderData = 'property_db.harga';
                break;
            default:
                $orderData = 'property_db.tanggal';
          }

        $where = array(
            'property_db.id_staff' => $id_staff,
        );  

        $property = $myproperty->semua_raw($where);
        $property = $property->orderByRaw($orderData)->paginate($limit);

        $data = array(  'title'             => $staff->slug_staff,
                        'deskripsi'         => $staff->nama_staff,
                        'keywords'          => $site_config->namaweb.' - '.$site_config->tagline,
                        'site_config'       => $site_config,
                        'berita'            => $berita,
                        'properties'        => $property,
                        'staff'             => $staff,
                        'limit'             => $limit,
                        'order'             => $order,

                        'og_site_name'      => strtolower(str_replace($site_config->namaweb,'',' ')),
                        'og_title'          => $staff->nama_staff,
                        'og_image'          => ($staff->gambar!="") ? asset('assets/upload/staff/thumbs/'.$staff->gambar) : asset('assets/aws/images/no-profile.png'),
                        'og_description'    => 'Agent of '.$site_config->namaweb,
                        'og_url'            => asset('agent/'.$staff->id_staff),

                        'content'           => 'home/agent'
                    );
        return view('layout/wrapper',$data);
    }


    // Homepage
    public function about()
    {
        $site_config   = DB::table('konfigurasi')->first();
        $news   = new Berita();
        $berita = $news->home();
        // Staff
        $kategori_staff  = DB::table('kategori_staff')->orderBy('urutan','ASC')->get();
        $layanan = DB::table('berita')->where(array('jenis_berita' => 'Layanan','status_berita' => 'Publish'))->orderBy('urutan', 'ASC')->get();

        $data = array(  'title'     => 'Tentang '.$site_config->namaweb,
                        'deskripsi' => 'Tentang '.$site_config->namaweb,
                        'keywords'  => 'Tentang '.$site_config->namaweb,
                        'site_config'      => $site_config,
                        'berita'    => $berita,
                        'layanan'   => $layanan,
                        'kategori_staff'     => $kategori_staff,
                        'content'   => 'home/aws'
                    );
        return view('layout/wrapper',$data);
    }

    public function about_project()
    {
        $site_config   = DB::table('konfigurasi')->first();
        $news   = new Berita();
        $berita = $news->home();
        // Staff
        $kategori_staff  = DB::table('kategori_staff')->orderBy('urutan','ASC')->get();
        $layanan = DB::table('berita')->where(array('jenis_berita' => 'Layanan','status_berita' => 'Publish'))->orderBy('urutan', 'ASC')->get();

        $data = array(  'title'     => 'Tentang '.$site_config->namaweb,
                        'deskripsi' => 'Tentang '.$site_config->namaweb,
                        'keywords'  => 'Tentang '.$site_config->namaweb,
                        'site_config'      => $site_config,
                        'berita'    => $berita,
                        'layanan'   => $layanan,
                        'kategori_staff'     => $kategori_staff,
                        'content'   => 'home/aws_project'
                    );
        return view('layout/wrapper',$data);
    }

    // kontak
    public function kontak()
    {
        $site_config   = DB::table('konfigurasi')->first();

        $data = array(  'title'     => 'Menghubungi '.$site_config->namaweb,
                        'deskripsi' => 'Kontak '.$site_config->namaweb,
                        'keywords'  => 'Kontak '.$site_config->namaweb,
                        'site_config'      => $site_config,
                        'content'   => 'home/kontak'
                    );
        return view('layout/wrapper',$data);
    }

    /**
     * Enrich harga_rata dengan AI langsung - menggunakan prompt yang lebih spesifik
     */
    protected function enrichHargaRata($property, WaisakaAiService $aiService)
    {
        $category = trim((string) ($property->nama_kategori_property ?? ''));
        $type = trim((string) ($property->tipe ?? ''));
        $alamat = trim((string) ($property->alamat ?? ''));
        $kecamatan = trim((string) ($property->nama_kecamatan ?? ''));
        $kabupaten = trim((string) ($property->nama_kabupaten ?? ''));
        $provinsi = trim((string) ($property->nama_provinsi ?? ''));
        $hargaListing = !empty($property->harga) ? (float) $property->harga : null;
        $luasTanah = !empty($property->lt) ? (int) $property->lt : null;
        $luasBangunan = !empty($property->lb) ? (int) $property->lb : null;

        // Build alamat lengkap sesuai format yang diharapkan AI
        // Format: alamat, kecamatan, kabupaten
        $addressParts = [];
        if (!empty($alamat)) {
            $addressParts[] = $alamat;
        }
        if (!empty($kecamatan)) {
            $addressParts[] = 'Kecamatan ' . $kecamatan;
        }
        if (!empty($kabupaten)) {
            $addressParts[] = $kabupaten;
        }
        if (!empty($provinsi)) {
            $addressParts[] = $provinsi;
        }
        
        $alamatLengkap = implode(', ', array_filter($addressParts));

        if (empty($alamatLengkap) || empty($category)) return;

        // Panggil AI dengan parameter sesuai signature di WaisakaAiService (tambah luasTanah dan luasBangunan)
        $priceSummary = $aiService->getAveragePriceSummary($type, $category, $alamatLengkap, $hargaListing, $luasTanah, $luasBangunan);
        
        if (empty($priceSummary)) return;
        $cleanPriceSummary = trim(strip_tags($priceSummary));
        if (\Illuminate\Support\Str::startsWith($cleanPriceSummary, 'Data pasar untuk lokasi ini belum tersedia')) {
            return;
        }

        // Simpan apa adanya (batas 18 kalimat dikontrol oleh prompt AI)

        // Save ke database
        try {
            DB::table('property_db')
                ->where('id_property', $property->id_property)
                ->update(['harga_rata' => $priceSummary]);
            
            $property->harga_rata = $priceSummary;
        } catch (\Throwable $e) {
            \Log::error('Failed to save harga_rata', ['id' => $property->id_property, 'error' => $e->getMessage()]);
        }
    }

    /**
     * Enrich fasilitas_terdekat dengan AI langsung - menggunakan alamat lengkap
     */
    protected function enrichFasilitasTerdekat($property, WaisakaAiService $aiService)
    {
        $alamat = trim((string) ($property->alamat ?? ''));
        $kecamatan = trim((string) ($property->nama_kecamatan ?? ''));
        $kabupaten = trim((string) ($property->nama_kabupaten ?? ''));

        // Build alamat lengkap sesuai format yang diharapkan AI
        // Format: alamat, kecamatan, kabupaten
        $addressParts = [];
        if (!empty($alamat)) {
            $addressParts[] = $alamat;
        }
        if (!empty($kecamatan)) {
            $addressParts[] = 'Kecamatan ' . $kecamatan;
        }
        if (!empty($kabupaten)) {
            $addressParts[] = $kabupaten;
        }
        
        $alamatLengkap = implode(', ', array_filter($addressParts));

        if (empty($alamatLengkap)) return;

        // Panggil AI sesuai signature di WaisakaAiService
        $summary = $aiService->getNearbyFacilitiesSummary($alamatLengkap);
        if (empty($summary)) return;

        // Format to HTML list if belum HTML
        if (stripos($summary, '<ul') === false) {
            $lines = array_filter(array_map('trim', preg_split('/\r\n|\r|\n/', strip_tags($summary))));
            if (!empty($lines)) {
                $items = array_map(fn($line) => '<li>' . htmlspecialchars($line) . '</li>', $lines);
                $summary = "<ul>" . implode('', $items) . "</ul>";
            }
        }

        // Save ke database
        try {
            DB::table('property_db')
                ->where('id_property', $property->id_property)
                ->update(['fasilitas_terdekat' => $summary]);
            
            $property->fasilitas_terdekat = $summary;
        } catch (\Throwable $e) {
            \Log::error('Failed to save fasilitas_terdekat', ['id' => $property->id_property, 'error' => $e->getMessage()]);
        }
    }

    /**
     * Enrich peta_map dengan AI langsung - menggunakan alamat lengkap
     */
    protected function enrichPetaMap($property, WaisakaAiService $aiService)
    {
        $alamat = trim((string) ($property->alamat ?? ''));
        $kecamatan = trim((string) ($property->nama_kecamatan ?? ''));
        $kabupaten = trim((string) ($property->nama_kabupaten ?? ''));
        $provinsi = trim((string) ($property->nama_provinsi ?? ''));

        $alamatLengkap = implode(', ', array_filter([$alamat, $kecamatan, $kabupaten, $provinsi]));

        if (empty($alamatLengkap)) return;

        $coordinates = $aiService->getMapCoordinateSummary($alamat, $kecamatan, $kabupaten, $provinsi);
        
        $embed = null;
        if ($coordinates && isset($coordinates['latitude'], $coordinates['longitude'])) {
            // Build iframe dari koordinat
            $embed = sprintf(
                '<iframe src="https://www.google.com/maps?q=%1$s,%2$s&z=16&output=embed" width="100%%" height="350" style="border:0;" allowfullscreen loading="lazy"></iframe>',
                $coordinates['latitude'],
                $coordinates['longitude']
            );
        } else {
            // Fallback: build iframe dari search query (gunakan maps_query jika ada, selain itu pakai alamat lengkap)
            $fallbackQuery = $alamatLengkap;
            if (is_array($coordinates) && !empty($coordinates['maps_query'])) {
                $fallbackQuery = (string) $coordinates['maps_query'];
            }
            $encoded = rawurlencode($fallbackQuery);
            $embed = sprintf(
                '<iframe src="https://www.google.com/maps?q=%1$s&z=16&output=embed" width="100%%" height="350" style="border:0;" allowfullscreen loading="lazy"></iframe>',
                $encoded
            );
        }

        if (empty($embed)) return;

        // Save ke database
        try {
            DB::table('property_db')
                ->where('id_property', $property->id_property)
                ->update(['peta_map' => $embed]);
            
            $property->peta_map = $embed;
        } catch (\Throwable $e) {
            \Log::error('Failed to save peta_map', ['id' => $property->id_property, 'error' => $e->getMessage()]);
        }
    }

}

=== END OF FILE: Http\Controllers\Home.php ===


=== START OF FILE: Http\Controllers\Listing.php ===
<?php
namespace App\Http\Controllers;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class Listing extends Controller
{

    public function location(Request $request)
    {
        $q = strtolower($request->q);
		$location 	= DB::table('kabupaten')
            ->join('provinsi', 'provinsi.id', '=', 'kabupaten.id_provinsi','LEFT')
            ->select('kabupaten.id','provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten')
            ->whereRaw('LOWER(provinsi.nama) LIKE "%'.$q.'%" OR LOWER(kabupaten.nama) LIKE "%'.$q.'%"')
            ->orderBy('kabupaten.nama','ASC')->orderBy('provinsi.nama','ASC')
            ->get();
 
        $response = [];
        foreach($location as $location){
            $response[] = array($location->nama_kabupaten,$location->nama_provinsi);
        }

        echo json_encode($response);   
    }

}

=== END OF FILE: Http\Controllers\Listing.php ===


=== START OF FILE: Http\Controllers\Login.php ===
<?php

namespace App\Http\Controllers;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Session;
use App\Models\User;
use App\Helpers\Website;

class Login extends Controller
{
    // Main page
    public function index()
    {
    	$site = DB::table('konfigurasi')->first();
        $data = array(  'title'     => 'Login Administrator',
    					'site'		=> $site);

        $characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        $captcha = '';
        for ($i = 0; $i < 4; $i++) {
            $captcha .= $characters[rand(0, strlen($characters) - 1)];
        }

        // Simpan CAPTCHA ke session
        Session::put('captcha_answer', $captcha);
        Session::put('captcha_expire', now()->addMinutes(5));

        $data = array(
            'title'     => 'Login Administrator',
            'captcha_question' => $captcha, 
        );
        return view('login/index', $data);
    }

    public function check(Request $request)
    {
        request()->validate([
            'username' => 'required',
            'password' => 'required',
            'captcha'  => 'required|string' // Validasi input captcha sebagai string
        ]);

        // --- VALIDASI JAWABAN CAPTCHA ---
        // Cek apakah captcha sudah kedaluwarsa
        if (Session::has('captcha_expire') && now()->gt(Session::get('captcha_expire'))) {
            Session::forget(['captcha_answer', 'captcha_expire']);
            return redirect('login')->with(['warning' => 'CAPTCHA sudah kedaluwarsa, silakan muat ulang dan coba lagi.']);
        }

        // Cek jawaban (case-insensitive)
        if (strtoupper($request->captcha) != Session::get('captcha_answer')) {
            return redirect('login')->with(['warning' => 'Kode verifikasi salah. Silakan coba lagi.']);
        }
        
        // Hapus session captcha setelah berhasil divalidasi
        Session::forget(['captcha_answer', 'captcha_expire']);
        // --- AKHIR VALIDASI CAPTCHA ---

        $username   = $request->username;
        $password   = $request->password;
        $model      = new User();
        $user       = $model->login($username,$password);
        if($user) {
            // --- LOGIKA BARU: CEK & BUAT STAFF ---
            $staff = DB::table('staff')->where('id_user', $user->id_user)->first();
            if(!$staff) {
                // Ambil urutan terakhir dari tabel staff
                $lastUrutan = DB::table('staff')->max('urutan') ?? 0;
                $newUrutan = $lastUrutan + 1;
                
                // Jika staff belum ada, buat baru dengan data dasar
                DB::table('staff')->insert([
                    'id_user'           => $user->id_user,
                    'nama_staff'        => $user->nama, // Ambil dari nama user
                    'email'             => $user->email,  // Ambil dari email user
                    'status_staff'      => 'Ya',
                    'urutan'            => $newUrutan, // Set urutan sebagai yang terakhir
                    'tanggal'           => now()
                ]);
                // Ambil lagi data staff yang baru dibuat
                $staff = DB::table('staff')->where('id_user', $user->id_user)->first();
                }
            
            // --- AKHIR LOGIKA BARU ---

            $request->session()->put('id_user', $user->id_user);
            $request->session()->put('nama', $user->nama);
            $request->session()->put('nodbpswrd', $password);
            $request->session()->put('username', $user->username);
            $request->session()->put('akses_level', $user->akses_level);
            $request->session()->put('is_member', ($staff && $staff->total_kuota_iklan > 0));
            $request->session()->put('id_staff', $staff ? $staff->id_staff : null);
            return redirect('admin/dasbor')->with(['sukses' => 'Anda berhasil login']);
        }else{
            return redirect('login')->with(['warning' => 'Mohon maaf, Username atau password salah']);
        }
    }

    // Homepage
    public function logout()
    {
        Session()->forget('id_user');
        Session()->forget('nama');
        Session()->forget('username');
        Session()->forget('akses_level');
        return redirect('login')->with(['sukses' => 'Anda berhasil logout']);
    }

    // Forgot password
    public function fogot()
    {
    	$site = DB::table('konfigurasi')->first();
       	$data = array(  'title'     => 'Lupa Password',
    					'site'		=> $site);
        return view('login/lupa',$data);
    }
}

=== END OF FILE: Http\Controllers\Login.php ===


=== START OF FILE: Http\Controllers\PulauController.php ===
<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;

class PulauController extends Controller
{
    public function index()
    {
        return view('pulau.index');
    }

    public function about()
    {
        return view('pulau.about');
    }

    public function packages()
    {
        return view('pulau.packages');
    }

    public function contact()
    {
        return view('pulau.contact');
    }

    public function gallery()
    {
        return view('pulau.gallery');
    }

    public function itinerary()
    {
        return view('pulau.itinerary');
    }

    public function faq()
    {
        return view('pulau.faq');
    }
}

=== END OF FILE: Http\Controllers\PulauController.php ===


=== START OF FILE: Http\Controllers\VideoController.php ===
<?php

namespace App\Http\Controllers;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Illuminate\Pagination\Paginator;
use App\Models\Video;

class VideoController extends Controller
{
    // Main page
    public function index()
    {
        Paginator::useBootstrap();
        $video = DB::table('video')
                    ->select('*')
                    ->orderBy('id_video','DESC')
                    ->paginate(10);
       	$site 	= DB::table('konfigurasi')->first();

		$data = array(  'title'		=> 'Video and Webinar '.$site->namaweb,
						'deskripsi'	=> 'Video and Webinar '.$site->namaweb,
						'keywords'	=> 'Video and Webinar '.$site->namaweb,
						'videos'	=> $video,
						'site'		=> $site,
                        'content'	=> 'video/index'
                    );
        return view('layout/wrapper',$data);
    }

     // detail
    public function detail($id_video)
    {
        $video = DB::table('video')
                    ->join('kategori_video', 'kategori_video.id_kategori_video', '=', 'video.id_kategori_video','LEFT')
                    ->select('video.*', 'kategori_video.nama_kategori_video')
                    ->where('video.id_video',$id_video)
                    ->orderBy('video.id_video','DESC')
                    ->first();
        $hits       = $video->hits+1;
        DB::table('video')->where('id_video',$video->id_video)->update([
            'hits'      => $hits
        ]);
        $data = array(  'title'		=> $video->judul_video,
						'deskripsi'	=> $video->judul_video,
						'keywords'	=> $video->judul_video,
						'videos'	=> $video,
                        'content'	=> 'video/detail'
                    );
        return view('layout/wrapper',$data);
    }

}

=== END OF FILE: Http\Controllers\VideoController.php ===


=== START OF FILE: Http\Controllers\Admin\Agenda.php ===
<?php

namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Illuminate\Pagination\Paginator;
use Image;
use App\Models\Agenda as AgendaModel;

class Agenda extends Controller
{
    // Main page
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        Paginator::useBootstrap();
    	$myagenda 	= new AgendaModel();
		$agenda 	= $myagenda->semua();
		$kategori_agenda 	= DB::table('kategori_agenda')->orderBy('urutan','ASC')->get();

		$data = array(  'title'       => 'Data Agenda',
						'agenda'      => $agenda,
						'kategori_agenda'    => $kategori_agenda,
                        'content'     => 'admin/agenda/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Add
    public function add()
    {
        $data = array(  'title'       => 'Data Agenda'
                    );
        return view('admin/agenda/add',$data);
    }

    // Cari
    public function cari(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $myagenda           = new AgendaModel();
        $keywords           = $request->keywords;
        $agenda             = $myagenda->cari($keywords);
        $kategori_agenda    = DB::table('kategori_agenda')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Data Agenda',
                        'agenda'            => $agenda,
                        'kategori_agenda'   => $kategori_agenda,
                        'content'           => 'admin/agenda/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Proses
    public function proses(Request $request)
    {
        $site           = DB::table('konfigurasi')->first();
        $pengalihan     = $request->pengalihan;
        // PROSES HAPUS MULTIPLE
        if(isset($_POST['hapus'])) {
            $id_agendanya       = $request->id_agenda;
            for($i=0; $i < sizeof($id_agendanya);$i++) {
                DB::table('agenda')->where('id_agenda',$id_agendanya[$i])->delete();
            }
            return redirect($pengalihan)->with(['sukses' => 'Data telah dihapus']);
        // PROSES SETTING DRAFT
        }elseif(isset($_POST['draft'])) {
            $id_agendanya       = $request->id_agenda;
            for($i=0; $i < sizeof($id_agendanya);$i++) {
                DB::table('agenda')->where('id_agenda',$id_agendanya[$i])->update([
                        'id_user'       => Session()->get('id_user'),
                        'status_agenda' => 'Draft'
                    ]);
            }
            return redirect($pengalihan)->with(['sukses' => 'Data telah diubah menjadi Draft']);
        // PROSES SETTING PUBLISH
        }elseif(isset($_POST['publish'])) {
            $id_agendanya       = $request->id_agenda;
            for($i=0; $i < sizeof($id_agendanya);$i++) {
                DB::table('agenda')->where('id_agenda',$id_agendanya[$i])->update([
                        'id_user'       => Session()->get('id_user'),
                        'status_agenda' => 'Publish'
                    ]);
            }
            return redirect($pengalihan)->with(['sukses' => 'Data telah diubah menjadi Publish']);
        }elseif(isset($_POST['update'])) {
            $id_agendanya       = $request->id_agenda;
            for($i=0; $i < sizeof($id_agendanya);$i++) {
                DB::table('agenda')->where('id_agenda',$id_agendanya[$i])->update([
                        'id_user'        => Session()->get('id_user'),
                        'id_kategori_agenda'    => $request->id_kategori_agenda
                    ]);
            }
            return redirect($pengalihan)->with(['sukses' => 'Data kategori_agenda telah diubah']);
        }
    }

    //Status
    public function status_agenda($status_agenda)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        Paginator::useBootstrap();
        $myagenda    = new AgendaModel();
        $agenda      = $myagenda->status_agenda($status_agenda);
        $kategori_agenda    = DB::table('kategori_agenda')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Status Agenda: '.$status_agenda,
                        'agenda'            => $agenda,
                        'kategori_agenda'   => $kategori_agenda,
                        'content'           => 'admin/agenda/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    //Status
    public function jenis_agenda($jenis_agenda)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        Paginator::useBootstrap();
        $myagenda    = new AgendaModel();
        $agenda      = $myagenda->jenis_agenda($jenis_agenda);
        $kategori_agenda    = DB::table('kategori_agenda')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Jenis Agenda: '.$jenis_agenda,
                        'agenda'            => $agenda,
                        'kategori_agenda'   => $kategori_agenda,
                        'content'           => 'admin/agenda/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    //Status
    public function author($id_user)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        Paginator::useBootstrap();
        $myagenda           = new AgendaModel();
        $agenda             = $myagenda->author($id_user);
        $kategori_agenda    = DB::table('kategori_agenda')->orderBy('urutan','ASC')->get();
        $author    = DB::table('users')->where('id_user',$id_user)->orderBy('id_user','ASC')->first();

        $data = array(  'title'             => 'Data Agenda dengan Penulis: '.$author->nama,
                        'agenda'            => $agenda,
                        'kategori_agenda'   => $kategori_agenda,
                        'content'           => 'admin/agenda/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    //Kategori
    public function kategori_agenda($id_kategori_agenda)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        Paginator::useBootstrap();
        $myagenda    = new AgendaModel();
        $agenda      = $myagenda->all_kategori_agenda($id_kategori_agenda);
        $kategori_agenda    = DB::table('kategori_agenda')->orderBy('urutan','ASC')->get();
        $detail      = DB::table('kategori_agenda')->where('id_kategori_agenda',$id_kategori_agenda)->first();
        $data = array(  'title'             => 'Kategori: '.$detail->nama_kategori_agenda,
                        'agenda'            => $agenda,
                        'kategori_agenda'   => $kategori_agenda,
                        'content'           => 'admin/agenda/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Tambah
    public function tambah()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $kategori_agenda    = DB::table('kategori_agenda')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Tambah Agenda',
                        'kategori_agenda'   => $kategori_agenda,
                        'content'           => 'admin/agenda/tambah'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // edit
    public function edit($id_agenda)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $myagenda           = new AgendaModel();
        $agenda             = $myagenda->detail($id_agenda);
        $kategori_agenda    = DB::table('kategori_agenda')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Edit Agenda',
                        'agenda'            => $agenda,
                        'kategori_agenda'   => $kategori_agenda,
                        'content'           => 'admin/agenda/edit'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'judul_agenda'  => 'required|unique:agenda',
                            'isi'           => 'required',
                            'gambar'        => 'file|image|mimes:jpeg,png,jpg|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            $slug_agenda = Str::slug($request->judul_agenda, '-');
            DB::table('agenda')->insert([
                'id_kategori_agenda'       => $request->id_kategori_agenda,
                'id_user'           => Session()->get('id_user'),
                'slug_agenda'       => $slug_agenda,
                'judul_agenda'      => $request->judul_agenda,
                'isi'               => $request->isi,
                'jenis_agenda'      => $request->jenis_agenda,
                'status_agenda'     => $request->status_agenda,
                'icon'              => $request->icon,
                'tanggal_mulai'     => tanggal('tanggal_input',$request->tanggal_mulai),
                'tanggal_selesai'   => tanggal('tanggal_input',$request->tanggal_selesai),
                'jam_mulai'         => $request->jam_mulai,
                'jam_selesai'       => $request->jam_selesai,
                'keywords'          => $request->keywords,
                'tempat'            => $request->tempat,
                'google_map'        => $request->google_map,
                'tanggal_publish'   => date('Y-m-d',strtotime($request->tanggal_publish)).' '.$request->jam_publish,
                'tanggal_post'      => date('Y-m-d H:i:s')
            ]);
        }else{
            $slug_agenda = Str::slug($request->judul_agenda, '-');
            DB::table('agenda')->insert([
                'id_kategori_agenda'       => $request->id_kategori_agenda,
                'id_user'           => Session()->get('id_user'),
                'slug_agenda'       => $slug_agenda,
                'judul_agenda'      => $request->judul_agenda,
                'isi'               => $request->isi,
                'jenis_agenda'      => $request->jenis_agenda,
                'status_agenda'     => $request->status_agenda,
                'icon'              => $request->icon,
                'tanggal_mulai'     => tanggal('tanggal_input',$request->tanggal_mulai),
                'tanggal_selesai'   => tanggal('tanggal_input',$request->tanggal_selesai),
                'jam_mulai'         => $request->jam_mulai,
                'jam_selesai'       => $request->jam_selesai,
                'keywords'          => $request->keywords,
                'tempat'            => $request->tempat,
                'google_map'        => $request->google_map,
                'tanggal_publish'   => date('Y-m-d',strtotime($request->tanggal_publish)).' '.$request->jam_publish,
                'tanggal_post'      => date('Y-m-d H:i:s')
            ]);
        }
        return redirect('admin/agenda')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'judul_agenda'   => 'required',
                            'isi'           => 'required',
                            'gambar'        => 'file|image|mimes:jpeg,png,jpg|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            $slug_agenda = Str::slug($request->judul_agenda, '-');
            DB::table('agenda')->where('id_agenda',$request->id_agenda)->update([
                'id_kategori_agenda'       => $request->id_kategori_agenda,
                'id_user'           => Session()->get('id_user'),
                'slug_agenda'       => $slug_agenda,
                'judul_agenda'      => $request->judul_agenda,
                'isi'               => $request->isi,
                'jenis_agenda'      => $request->jenis_agenda,
                'status_agenda'     => $request->status_agenda,
                'icon'              => $request->icon,
                'tanggal_mulai'     => tanggal('tanggal_input',$request->tanggal_mulai),
                'tanggal_selesai'   => tanggal('tanggal_input',$request->tanggal_selesai),
                'jam_mulai'         => $request->jam_mulai,
                'jam_selesai'       => $request->jam_selesai,
                'keywords'          => $request->keywords,
                'tempat'            => $request->tempat,
                'google_map'        => $request->google_map,
                'tanggal_publish'   => date('Y-m-d',strtotime($request->tanggal_publish)).' '.$request->jam_publish
            ]);
        }else{
            $slug_agenda = Str::slug($request->judul_agenda, '-');
            DB::table('agenda')->where('id_agenda',$request->id_agenda)->update([
                'id_kategori_agenda'       => $request->id_kategori_agenda,
                'id_user'           => Session()->get('id_user'),
                'slug_agenda'       => $slug_agenda,
                'judul_agenda'      => $request->judul_agenda,
                'isi'               => $request->isi,
                'jenis_agenda'      => $request->jenis_agenda,
                'status_agenda'     => $request->status_agenda,
                'icon'              => $request->icon,
                'tanggal_mulai'     => tanggal('tanggal_input',$request->tanggal_mulai),
                'tanggal_selesai'   => tanggal('tanggal_input',$request->tanggal_selesai),
                'jam_mulai'         => $request->jam_mulai,
                'jam_selesai'       => $request->jam_selesai,
                'keywords'          => $request->keywords,
                'tempat'            => $request->tempat,
                'google_map'        => $request->google_map,
                'tanggal_publish'   => date('Y-m-d',strtotime($request->tanggal_publish)).' '.$request->jam_publish
                ]);
        }
        return redirect('admin/agenda')->with(['sukses' => 'Data telah ditambah']);
    }

    // Delete
    public function delete($id_agenda)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        DB::table('agenda')->where('id_agenda',$id_agenda)->delete();
        return redirect('admin/agenda')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Agenda.php ===


=== START OF FILE: Http\Controllers\Admin\Berita.php ===
<?php

namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Illuminate\Pagination\Paginator;
use Image;
use App\Models\Berita as BeritaModel;

class Berita extends Controller
{
    // Main page
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        Paginator::useBootstrap();
    	$myberita 	= new BeritaModel();
		$berita 	= $myberita->berita_update();
		$kategori 	= DB::table('kategori')->orderBy('urutan','ASC')->get();

		$data = array(  'title'       => 'Data Berita',
						'berita'      => $berita,
                        'berita'      => $berita,
						'kategori'    => $kategori,
                        'content'     => 'admin/berita/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Add
    public function add()
    {
        $data = array(  'title'       => 'Data Berita'
                    );
        return view('admin/berita/add',$data);
    }

    // Cari
    public function cari(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $myberita           = new BeritaModel();
        $keywords           = $request->keywords;
        $berita             = $myberita->cari($keywords);
        $kategori           = DB::table('kategori')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Data Berita',
                        'berita'            => $berita,
                        'kategori'   => $kategori,
                        'content'           => 'admin/berita/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Proses
    public function proses(Request $request)
    {
        $site           = DB::table('konfigurasi')->first();
        $pengalihan     = $request->pengalihan;
        // PROSES HAPUS MULTIPLE
        if(isset($_POST['hapus'])) {
            $id_beritanya       = $request->id_berita;
            for($i=0; $i < sizeof($id_beritanya);$i++) {
                DB::table('berita')->where('id_berita',$id_beritanya[$i])->delete();
            }
            return redirect($pengalihan)->with(['sukses' => 'Data telah dihapus']);
        // PROSES SETTING DRAFT
        }elseif(isset($_POST['draft'])) {
            $id_beritanya       = $request->id_berita;
            for($i=0; $i < sizeof($id_beritanya);$i++) {
                DB::table('berita')->where('id_berita',$id_beritanya[$i])->update([
                        'id_user'       => Session()->get('id_user'),
                        'status_berita' => 'Draft'
                    ]);
            }
            return redirect($pengalihan)->with(['sukses' => 'Data telah diubah menjadi Draft']);
        // PROSES SETTING PUBLISH
        }elseif(isset($_POST['publish'])) {
            $id_beritanya       = $request->id_berita;
            for($i=0; $i < sizeof($id_beritanya);$i++) {
                DB::table('berita')->where('id_berita',$id_beritanya[$i])->update([
                        'id_user'       => Session()->get('id_user'),
                        'status_berita' => 'Publish'
                    ]);
            }
            return redirect($pengalihan)->with(['sukses' => 'Data telah diubah menjadi Publish']);
        }elseif(isset($_POST['update'])) {
            $id_beritanya       = $request->id_berita;
            for($i=0; $i < sizeof($id_beritanya);$i++) {
                DB::table('berita')->where('id_berita',$id_beritanya[$i])->update([
                        'id_user'        => Session()->get('id_user'),
                        'id_kategori'    => $request->id_kategori
                    ]);
            }
            return redirect($pengalihan)->with(['sukses' => 'Data kategori telah diubah']);
        }
    }

    //Status
    public function status_berita($status_berita)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        Paginator::useBootstrap();
        $myberita    = new BeritaModel();
        $berita      = $myberita->status_berita($status_berita);
        $kategori    = DB::table('kategori')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Status Berita: '.$status_berita,
                        'berita'            => $berita,
                        'kategori'   => $kategori,
                        'content'           => 'admin/berita/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    //Status
    public function jenis_berita($jenis_berita)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        Paginator::useBootstrap();
        $myberita    = new BeritaModel();
        $berita      = $myberita->jenis_berita($jenis_berita);
        $kategori    = DB::table('kategori')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Jenis Berita: '.$jenis_berita,
                        'berita'            => $berita,
                        'kategori'   => $kategori,
                        'content'           => 'admin/berita/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    //Status
    public function author($id_user)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        Paginator::useBootstrap();
        $myberita           = new BeritaModel();
        $berita             = $myberita->author($id_user);
        $kategori    = DB::table('kategori')->orderBy('urutan','ASC')->get();
        $author    = DB::table('users')->where('id_user',$id_user)->orderBy('id_user','ASC')->first();

        $data = array(  'title'             => 'Data Berita dengan Penulis: '.$author->nama,
                        'berita'            => $berita,
                        'kategori'   => $kategori,
                        'content'           => 'admin/berita/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    //Kategori
    public function kategori($id_kategori)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        Paginator::useBootstrap();
        $myberita    = new BeritaModel();
        $berita      = $myberita->all_kategori($id_kategori);
        $kategori    = DB::table('kategori')->orderBy('urutan','ASC')->get();
        $detail      = DB::table('kategori')->where('id_kategori',$id_kategori)->first();
        $data = array(  'title'             => 'Kategori: '.$detail->nama_kategori,
                        'berita'            => $berita,
                        'kategori'   => $kategori,
                        'content'           => 'admin/berita/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Tambah
    public function tambah()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $kategori    = DB::table('kategori')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Tambah Berita',
                        'kategori'   => $kategori,
                        'content'           => 'admin/berita/tambah'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // edit
    public function edit($id_berita)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $myberita           = new BeritaModel();
        $berita             = $myberita->detail($id_berita);
        $kategori    = DB::table('kategori')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Edit Berita',
                        'berita'            => $berita,
                        'kategori'   => $kategori,
                        'content'           => 'admin/berita/edit'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'judul_berita'  => 'required|unique:berita',
                            'isi'           => 'required',
                            'gambar'        => 'file|image|mimes:jpeg,png,jpg|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            $slug_berita = Str::slug($request->judul_berita, '-');
            DB::table('berita')->insert([
                'id_kategori'       => $request->id_kategori,
                'id_user'           => Session()->get('id_user'),
                'slug_berita'       => $slug_berita,
                'judul_berita'      => $request->judul_berita,
                'isi'               => $request->isi,
                'link_berita'       => ($request->link_berita) ? $request->link_berita : '#',
                'jenis_berita'      => $request->jenis_berita,
                'status_berita'     => $request->status_berita,
                'gambar'            => $input['nama_file'],
                'icon'              => $request->icon,
                'keywords'          => $request->keywords,
                'tanggal_publish'   => date('Y-m-d',strtotime($request->tanggal_publish)).' '.$request->jam_publish,
                'urutan'            => $request->urutan,
                'tanggal_post'      => date('Y-m-d H:i:s')
            ]);
        }else{
            $slug_berita = Str::slug($request->judul_berita, '-');
            DB::table('berita')->insert([
                'id_kategori'       => $request->id_kategori,
                'id_user'           => Session()->get('id_user'),
                'slug_berita'       => $slug_berita,
                'judul_berita'      => $request->judul_berita,
                'isi'               => $request->isi,
                'link_berita'       => ($request->link_berita) ? $request->link_berita : '#',
                'jenis_berita'      => $request->jenis_berita,
                'status_berita'     => $request->status_berita,
                'icon'              => $request->icon,
                'keywords'          => $request->keywords,
                'tanggal_publish'   => date('Y-m-d',strtotime($request->tanggal_publish)).' '.$request->jam_publish,
                'urutan'            => $request->urutan,
                'tanggal_post'      => date('Y-m-d H:i:s')
            ]);
        }
        if($request->jenis_berita=="Berita") {
            return redirect('admin/berita')->with(['sukses' => 'Data telah ditambah']);
        }else{
            return redirect('admin/berita/jenis_berita/'.$request->jenis_berita)->with(['sukses' => 'Data telah ditambah']);
        }
    }

    // edit
    public function edit_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'judul_berita'   => 'required',
                            'isi'           => 'required',
                            'gambar'        => 'file|image|mimes:jpeg,png,jpg|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            $slug_berita = Str::slug($request->judul_berita, '-');
            DB::table('berita')->where('id_berita',$request->id_berita)->update([
                'id_kategori'       => $request->id_kategori,
                'id_user'           => Session()->get('id_user'),
                'slug_berita'       => $slug_berita,
                'judul_berita'      => $request->judul_berita,
                'isi'               => $request->isi,
                'link_berita'       => ($request->link_berita) ? $request->link_berita : '#',
                'jenis_berita'      => $request->jenis_berita,
                'status_berita'     => $request->status_berita,
                'gambar'            => $input['nama_file'],
                'icon'              => $request->icon,
                'keywords'          => $request->keywords,
                'tanggal_publish'   => date('Y-m-d',strtotime($request->tanggal_publish)).' '.$request->jam_publish,
                'urutan'            => $request->urutan
            ]);
        }else{
            $slug_berita = Str::slug($request->judul_berita, '-');
            DB::table('berita')->where('id_berita',$request->id_berita)->update([
                'id_kategori'       => $request->id_kategori,
                'id_user'           => Session()->get('id_user'),
                'slug_berita'       => $slug_berita,
                'judul_berita'      => $request->judul_berita,
                'isi'               => $request->isi,
                'link_berita'       => ($request->link_berita) ? $request->link_berita : '#',
                'jenis_berita'      => $request->jenis_berita,
                'status_berita'     => $request->status_berita,
                'icon'              => $request->icon,
                'keywords'          => $request->keywords,
                'tanggal_publish'   => date('Y-m-d',strtotime($request->tanggal_publish)).' '.$request->jam_publish,
                'urutan'            => $request->urutan
            ]);
        }
        if($request->jenis_berita=="Berita") {
            return redirect('admin/berita')->with(['sukses' => 'Data telah ditambah']);
        }else{
            return redirect('admin/berita/jenis_berita/'.$request->jenis_berita)->with(['sukses' => 'Data telah ditambah']);
        }
    }

    // Delete
    public function delete($id_berita,$jenis_berita)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        DB::table('berita')->where('id_berita',$id_berita)->delete();
        return redirect('admin/berita/jenis_berita/'.$jenis_berita)->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Berita.php ===


=== START OF FILE: Http\Controllers\Admin\Controller.php ===
<?php

namespace App\Http\Controllers\admin;

use Illuminate\Foundation\Auth\Access\AuthorizesRequests;
use Illuminate\Foundation\Bus\DispatchesJobs;
use Illuminate\Foundation\Validation\ValidatesRequests;
use Illuminate\Routing\Controller as BaseController;

class Controller extends BaseController
{
    use AuthorizesRequests, DispatchesJobs, ValidatesRequests;
}

=== END OF FILE: Http\Controllers\Admin\Controller.php ===


=== START OF FILE: Http\Controllers\Admin\Dasbor.php ===
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use App\Models\Konfigurasi as KonfigurasiModel;
use Image;
use PDF;

class Dasbor extends Controller
{


    // Index
    public function index()
    {
        if(Session()->get('username')=="") {
            $last_page = url()->current();
            return redirect('login?redirect='.$last_page)->with(['warning' => 'Mohon maaf, Anda belum login']);
        }
    	$mysite = new KonfigurasiModel();
		$site 	= $mysite->listing();
       
		$data = array(  'title'     => $site->namaweb.' - '.$site->tagline,
                        'content'   => 'admin/dasbor/index'
                    );
        return view('admin/layout/wrapper',$data);
    }
}

=== END OF FILE: Http\Controllers\Admin\Dasbor.php ===


=== START OF FILE: Http\Controllers\Admin\Dataset.php ===
<?php

namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Image;

class Dataset extends Controller
{
    public function kabupaten($provinsi_id)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
		$kabupaten 	= DB::table('kabupaten')->where('id_provinsi',$provinsi_id)->orderBy('nama','ASC')->get();

        return $kabupaten->toJson();
    }

    public function kecamatan($kabupaten_id)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
		$kecamatan 	= DB::table('kecamatan')->where('id_kabupaten',$kabupaten_id)->orderBy('nama','ASC')->get();

        return $kecamatan->toJson();
    }
}

=== END OF FILE: Http\Controllers\Admin\Dataset.php ===


=== START OF FILE: Http\Controllers\Admin\Download.php ===
<?php

namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Image;
use App\Models\Download as DownloadModel;

class Download extends Controller
{
    // Main page
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	$mydownload 			= new DownloadModel();
		$download 			= $mydownload->semua();
		$kategori_download 	= DB::table('kategori_download')->orderBy('urutan','ASC')->get();

		$data = array(  'title'				=> 'Data Download',
						'download'			=> $download,
						'kategori_download'	=> $kategori_download,
                        'content'			=> 'admin/download/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Cari
    public function cari(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mydownload           = new DownloadModel();
        $keywords           = $request->keywords;
        $download             = $mydownload->cari($keywords);
        $kategori_download    = DB::table('kategori_download')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Data Download',
                        'download'            => $download,
                        'kategori_download'   => $kategori_download,
                        'content'           => 'admin/download/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Proses
    public function proses(Request $request)
    {
        $site   = DB::table('konfigurasi')->first();
        // PROSES HAPUS MULTIPLE
        if(isset($_POST['hapus'])) {
            $id_downloadnya       = $request->id_download;
            for($i=0; $i < sizeof($id_downloadnya);$i++) {
                DB::table('download')->where('id_download',$id_downloadnya[$i])->delete();
            }
            return redirect('admin/download')->with(['sukses' => 'Data telah dihapus']);
        // PROSES SETTING DRAFT
        }elseif(isset($_POST['update'])) {
            $id_downloadnya       = $request->id_download;
            for($i=0; $i < sizeof($id_downloadnya);$i++) {
                DB::table('download')->where('id_download',$id_downloadnya[$i])->update([
                        'id_user'               => Session()->get('id_user'),
                        'id_kategori_download'    => $request->id_kategori_download
                    ]);
            }
            return redirect('admin/download')->with(['sukses' => 'Data kategori telah diubah']);
        }
    }

    //Status
    public function status_download($status_download)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mydownload           = new DownloadModel();
        $download             = $mydownload->status_download($status_download);
        $kategori_download    = DB::table('kategori_download')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Data Download',
                        'download'            => $download,
                        'kategori_download'   => $kategori_download,
                        'content'           => 'admin/download/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    //Kategori
    public function kategori($id_kategori_download)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mydownload           = new DownloadModel();
        $download             = $mydownload->all_kategori_download($id_kategori_download);
        $kategori_download    = DB::table('kategori_download')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Data Download',
                        'download'            => $download,
                        'kategori_download'   => $kategori_download,
                        'content'           => 'admin/download/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Tambah
    public function tambah()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $kategori_download    = DB::table('kategori_download')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Tambah Download',
                        'kategori_download'   => $kategori_download,
                        'content'           => 'admin/download/tambah'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Unduh
    public function unduh($id_download)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mydownload = new DownloadModel();
        $download   = $mydownload->detail($id_download);
        $hits       = $download->hits+1;
        DB::table('download')->where('id_download',$download->id_download)->update([
            'hits'      => $hits
        ]);
        $pathToFile           = './public/upload/file/'.$download->gambar;
        return response()->download($pathToFile, $download->gambar);
    }

    // edit
    public function edit($id_download)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mydownload           = new DownloadModel();
        $download             = $mydownload->detail($id_download);
        $kategori_download    = DB::table('kategori_download')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Edit Download',
                        'download'            => $download,
                        'kategori_download'   => $kategori_download,
                        'content'           => 'admin/download/edit'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'judul_download'  => 'required|unique:download',
                            'gambar'          => 'required|file|mimes:jpeg,png,jpg,pdf,doc,docx,xls,xlsx,ppt,pptx|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
        $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
        $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
        $destinationPath = './assets/upload/file';
        $image->move($destinationPath, $input['nama_file']);
        // END UPLOAD
        DB::table('download')->insert([
            'id_kategori_download'  => $request->id_kategori_download,
            'id_user'               => Session()->get('id_user'),
            'judul_download'        => $request->judul_download,
            'jenis_download'        => $request->jenis_download,
            'isi'                   => $request->isi,
            'gambar'                => $input['nama_file'],
            'website'               => $request->website
        ]);
        return redirect('admin/download')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'judul_download'    => 'required',
                            'gambar'            => 'file|mimes:jpeg,png,jpg,pdf,doc,docx,xls,xlsx,ppt,pptx|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath = './assets/upload/file';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            DB::table('download')->where('id_download',$request->id_download)->update([
                'id_kategori_download'  => $request->id_kategori_download,
                'id_user'               => Session()->get('id_user'),
                'judul_download'        => $request->judul_download,
                'jenis_download'        => $request->jenis_download,
                'isi'                   => $request->isi,
                'gambar'                => $input['nama_file'],
                'website'               => $request->website
            ]);
        }else{
            DB::table('download')->where('id_download',$request->id_download)->update([
                'id_kategori_download'  => $request->id_kategori_download,
                'id_user'               => Session()->get('id_user'),
                'judul_download'        => $request->judul_download,
                'jenis_download'        => $request->jenis_download,
                'isi'                   => $request->isi,
                'website'               => $request->website
            ]);
        }
        return redirect('admin/download')->with(['sukses' => 'Data telah ditambah']);
    }

    // Delete
    public function delete($id_download)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        DB::table('download')->where('id_download',$id_download)->delete();
        return redirect('admin/download')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Download.php ===


=== START OF FILE: Http\Controllers\Admin\Galeri.php ===
<?php

namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Intervention\Image\Facades\Image;
use App\Models\Galeri as GaleriModel;

class Galeri extends Controller
{
    // Main page
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	$mygaleri 			= new GaleriModel();
		$galeri 			= $mygaleri->semua();
		$kategori_galeri 	= DB::table('kategori_galeri')->orderBy('urutan','ASC')->get();

		$data = array(  'title'				=> 'Data Galeri',
						'galeri'			=> $galeri,
						'kategori_galeri'	=> $kategori_galeri,
                        'content'			=> 'admin/galeri/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Cari
    public function cari(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mygaleri           = new GaleriModel();
        $keywords           = $request->keywords;
        $galeri             = $mygaleri->cari($keywords);
        $kategori_galeri    = DB::table('kategori_galeri')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Data Galeri',
                        'galeri'            => $galeri,
                        'kategori_galeri'   => $kategori_galeri,
                        'content'           => 'admin/galeri/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Proses
    public function proses(Request $request)
    {
        $site   = DB::table('konfigurasi')->first();
        // PROSES HAPUS MULTIPLE
        if(isset($_POST['hapus'])) {
            $id_galerinya       = $request->id_galeri;
            for($i=0; $i < sizeof($id_galerinya);$i++) {
                DB::table('galeri')->where('id_galeri',$id_galerinya[$i])->delete();
            }
            return redirect('admin/galeri')->with(['sukses' => 'Data telah dihapus']);
        // PROSES SETTING DRAFT
        }elseif(isset($_POST['update'])) {
            $id_galerinya       = $request->id_galeri;
            for($i=0; $i < sizeof($id_galerinya);$i++) {
                DB::table('galeri')->where('id_galeri',$id_galerinya[$i])->update([
                        'id_user'               => Session()->get('id_user'),
                        'id_kategori_galeri'    => $request->id_kategori_galeri
                    ]);
            }
            return redirect('admin/galeri')->with(['sukses' => 'Data kategori telah diubah']);
        }
    }

    //Status
    public function status_galeri($status_galeri)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mygaleri           = new GaleriModel();
        $galeri             = $mygaleri->status_galeri($status_galeri);
        $kategori_galeri    = DB::table('kategori_galeri')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Data Galeri',
                        'galeri'            => $galeri,
                        'kategori_galeri'   => $kategori_galeri,
                        'content'           => 'admin/galeri/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    //Kategori
    public function kategori($id_kategori_galeri)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mygaleri           = new GaleriModel();
        $galeri             = $mygaleri->all_kategori_galeri($id_kategori_galeri);
        $kategori_galeri    = DB::table('kategori_galeri')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Data Galeri',
                        'galeri'            => $galeri,
                        'kategori_galeri'   => $kategori_galeri,
                        'content'           => 'admin/galeri/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Tambah
    public function tambah()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $kategori_galeri    = DB::table('kategori_galeri')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Tambah Galeri',
                        'kategori_galeri'   => $kategori_galeri,
                        'content'           => 'admin/galeri/tambah'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // edit
    public function edit($id_galeri)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mygaleri           = new GaleriModel();
        $galeri             = $mygaleri->detail($id_galeri);
        $kategori_galeri    = DB::table('kategori_galeri')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Edit Galeri',
                        'galeri'            => $galeri,
                        'kategori_galeri'   => $kategori_galeri,
                        'content'           => 'admin/galeri/edit'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'judul_galeri'  => 'required|unique:galeri',
                            'gambar'        => 'required|file|image|mimes:jpeg,png,jpg|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
        $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
        $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
        $destinationPath        = './assets/upload/image/thumbs/';
        $img = Image::make($image->getRealPath(),array(
            'width'     => 150,
            'height'    => 150,
            'grayscale' => false
        ));
        $img->save($destinationPath.'/'.$input['nama_file']);
        $destinationPath = './assets/upload/image/';
        $image->move($destinationPath, $input['nama_file']);
        // END UPLOAD
        $slug_nama_galeri = Str::slug($request->nama_galeri, '-');
        if($request->mulai_diskon=='') {
            $mulai_diskon = NULL;
        }else{ 
            $mulai_diskon = date('Y-m-d',strtotime($request->mulai_diskon)); 
        }
        if($request->selesai_diskon=='') {
            $selesai_diskon = NULL;
        }else{ 
            $selesai_diskon = date('Y-m-d',strtotime($request->selesai_diskon)); 
        }
        DB::table('galeri')->insert([
            'id_user'               => Session()->get('id_user'),
            'id_kategori_galeri'    => $request->id_kategori_galeri,
            'id_user'               => Session()->get('id_user'),
            'judul_galeri'          => $request->judul_galeri,
            'isi'                   => $request->isi,
            'jenis_galeri'          => $request->jenis_galeri,
            'gambar'                => $input['nama_file'],
            'website'               => $request->website,
            'status_text'           => $request->status_text,
            'urutan'                => $request->urutan
        ]);
        return redirect('admin/galeri')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'judul_galeri'  => 'required',
                            'gambar'        => 'file|image|mimes:jpeg,png,jpg|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            $slug_nama_galeri = Str::slug($request->nama_galeri, '-');
            if($request->mulai_diskon=='') {
                $mulai_diskon = NULL;
            }else{ 
                $mulai_diskon = date('Y-m-d',strtotime($request->mulai_diskon)); 
            }
            if($request->selesai_diskon=='') {
                $selesai_diskon = NULL;
            }else{ 
                $selesai_diskon = date('Y-m-d',strtotime($request->selesai_diskon)); 
            }
            DB::table('galeri')->where('id_galeri',$request->id_galeri)->update([
                'id_user'               => Session()->get('id_user'),
                'id_kategori_galeri'    => $request->id_kategori_galeri,
                'id_user'               => Session()->get('id_user'),
                'judul_galeri'          => $request->judul_galeri,
                'isi'                   => $request->isi,
                'jenis_galeri'          => $request->jenis_galeri,
                'gambar'                => $input['nama_file'],
                'website'               => $request->website,
                'status_text'           => $request->status_text,
                'urutan'                => $request->urutan
            ]);
        }else{
            $slug_nama_galeri = Str::slug($request->nama_galeri, '-');
            if($request->mulai_diskon=='') {
                $mulai_diskon = NULL;
            }else{ 
                $mulai_diskon = date('Y-m-d',strtotime($request->mulai_diskon)); 
            }
            if($request->selesai_diskon=='') {
                $selesai_diskon = NULL;
            }else{ 
                $selesai_diskon = date('Y-m-d',strtotime($request->selesai_diskon)); 
            }
            DB::table('galeri')->where('id_galeri',$request->id_galeri)->update([
                'id_user'               => Session()->get('id_user'),
                'id_kategori_galeri'    => $request->id_kategori_galeri,
                'id_user'               => Session()->get('id_user'),
                'judul_galeri'          => $request->judul_galeri,
                'isi'                   => $request->isi,
                'jenis_galeri'          => $request->jenis_galeri,
                'website'               => $request->website,
                'status_text'           => $request->status_text,
                'urutan'                => $request->urutan
            ]);
        }
        return redirect('admin/galeri')->with(['sukses' => 'Data telah ditambah']);
    }

    // Delete
    public function delete($id_galeri)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        DB::table('galeri')->where('id_galeri',$id_galeri)->delete();
        return redirect('admin/galeri')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Galeri.php ===


=== START OF FILE: Http\Controllers\Admin\Heading.php ===
<?php
namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Intervention\Image\Facades\Image;

class Heading extends Controller
{
    // Index
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
		$heading 	= DB::table('heading')->orderBy('judul_heading','ASC')->get();

		$data = array(  'title'         => 'Setting Header',
						'heading'	    => $heading,
                        'content'       => 'admin/heading/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'judul_heading' => 'required|unique:heading',
                            'gambar'        => 'required|file|image|mimes:jpeg,png,jpg|max:8024',
					        ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
        $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
        $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
        $destinationPath        = './assets/upload/image/thumbs';
        $img = Image::make($image->getRealPath(),array(
            'width'     => 150,
            'height'    => 150,
            'grayscale' => false
        ));
        $img->save($destinationPath.'/'.$input['nama_file']);
        $destinationPath = './assets/upload/image';
        $image->move($destinationPath, $input['nama_file']);
        // END UPLOAD
        DB::table('heading')->insert([
            'judul_heading' => $request->judul_heading,
            'keterangan'    => $request->keterangan,
            'gambar'        => $input['nama_file'],
            'halaman'       => $request->halaman
        ]);
        return redirect('admin/heading')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'judul_heading' => 'required',
					        'judul_heading'               => 'required',
                            'gambar'               => 'file|image|mimes:jpeg,png,jpg|max:8024',
					        ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            // UPLOAD START
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            $slug_heading = Str::slug($request->judul_heading, '-');
            DB::table('heading')->where('id_heading',$request->id_heading)->update([
                'judul_heading' => $request->judul_heading,
                'keterangan'    => $request->keterangan,
                'gambar'        => $input['nama_file'],
                'halaman'       => $request->halaman
            ]);
        }else{
            $slug_heading = Str::slug($request->judul_heading, '-');
            DB::table('heading')->where('id_heading',$request->id_heading)->update([
                'judul_heading' => $request->judul_heading,
                'keterangan'    => $request->keterangan,
                // 'gambar'        => $input['nama_file'],
                'halaman'       => $request->halaman
            ]);
        }
        return redirect('admin/heading')->with(['sukses' => 'Data telah diupdate']);
    }

    // Delete
    public function delete($id_heading)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	DB::table('heading')->where('id_heading',$id_heading)->delete();
    	return redirect('admin/heading')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Heading.php ===


=== START OF FILE: Http\Controllers\Admin\Kategori.php ===
<?php
namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class Kategori extends Controller
{
    // Index
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
		$kategori 	= DB::table('kategori')->orderBy('urutan','ASC')->get();

		$data = array(  'title'     => 'Kategori Berita',
						'kategori'	=> $kategori,
                        'content'   => 'admin/kategori/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'nama_kategori' => 'required|unique:kategori',
					        'urutan' 		=> 'required',
					        ]);
    	$slug_kategori = Str::slug($request->nama_kategori, '-');
        DB::table('kategori')->insert([
            'id_user'       => Session()->get('id_user'),
            'nama_kategori' => $request->nama_kategori,
            'slug_kategori'	=> $slug_kategori,
            'urutan'   		=> $request->urutan
        ]);
        return redirect('admin/kategori')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'nama_kategori' => 'required',
					        'urutan' 		=> 'required',
					        ]);
    	$slug_kategori = Str::slug($request->nama_kategori, '-');
        DB::table('kategori')->where('id_kategori',$request->id_kategori)->update([
            'id_user'       => Session()->get('id_user'),
            'nama_kategori' => $request->nama_kategori,
            'slug_kategori'	=> $slug_kategori,
            'urutan'   		=> $request->urutan
        ]);
        return redirect('admin/kategori')->with(['sukses' => 'Data telah diupdate']);
    }

    // Delete
    public function delete($id_kategori)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	DB::table('kategori')->where('id_kategori',$id_kategori)->delete();
    	return redirect('admin/kategori')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Kategori.php ===


=== START OF FILE: Http\Controllers\Admin\Kategori_agenda.php ===
<?php
namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class Kategori_agenda extends Controller
{
    // Index
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
		$kategori_agenda 	= DB::table('kategori_agenda')->orderBy('urutan','ASC')->get();

		$data = array(  'title'             => 'Kategori Agenda',
						'kategori_agenda'	=> $kategori_agenda,
                        'content'           => 'admin/kategori_agenda/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'nama_kategori_agenda' => 'required|unique:kategori_agenda',
					        'urutan' 		       => 'required',
					        ]);
    	$slug_kategori_agenda = Str::slug($request->nama_kategori_agenda, '-');
        DB::table('kategori_agenda')->insert([
            'nama_kategori_agenda'   => $request->nama_kategori_agenda,
            'slug_kategori_agenda'	=> $slug_kategori_agenda,
            'keterangan'            => $request->keterangan,
            'urutan'   		        => $request->urutan
        ]);
        return redirect('admin/kategori_agenda')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'nama_kategori_agenda' => 'required',
					        'urutan'               => 'required',
					        ]);
    	$slug_kategori_agenda = Str::slug($request->nama_kategori_agenda, '-');
        DB::table('kategori_agenda')->where('id_kategori_agenda',$request->id_kategori_agenda)->update([
            'nama_kategori_agenda'   => $request->nama_kategori_agenda,
            'slug_kategori_agenda'	=> $slug_kategori_agenda,
            'keterangan'            => $request->keterangan,
            'urutan'                => $request->urutan
        ]);
        return redirect('admin/kategori_agenda')->with(['sukses' => 'Data telah diupdate']);
    }

    // Delete
    public function delete($id_kategori_agenda)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	DB::table('kategori_agenda')->where('id_kategori_agenda',$id_kategori_agenda)->delete();
    	return redirect('admin/kategori_agenda')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Kategori_agenda.php ===


=== START OF FILE: Http\Controllers\Admin\Kategori_download.php ===
<?php
namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class Kategori_download extends Controller
{
    // Index
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
		$kategori_download 	= DB::table('kategori_download')->orderBy('urutan','ASC')->get();

		$data = array(  'title'             => 'Kategori Download',
						'kategori_download'	=> $kategori_download,
                        'content'           => 'admin/kategori_download/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'nama_kategori_download' => 'required|unique:kategori_download',
					        'urutan' 		       => 'required',
					        ]);
    	$slug_kategori_download = Str::slug($request->nama_kategori_download, '-');
        DB::table('kategori_download')->insert([
            'nama_kategori_download'  => $request->nama_kategori_download,
            'slug_kategori_download'	=> $slug_kategori_download,
            'urutan'   		        => $request->urutan,
            'keterangan'               => $request->keterangan
        ]);
        return redirect('admin/kategori_download')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'nama_kategori_download' => 'required',
					        'urutan'               => 'required',
					        ]);
    	$slug_kategori_download = Str::slug($request->nama_kategori_download, '-');
        DB::table('kategori_download')->where('id_kategori_download',$request->id_kategori_download)->update([
            'nama_kategori_download'  => $request->nama_kategori_download,
            'slug_kategori_download'	=> $slug_kategori_download,
            'urutan'                => $request->urutan,
            'keterangan'               => $request->keterangan
        ]);
        return redirect('admin/kategori_download')->with(['sukses' => 'Data telah diupdate']);
    }

    // Delete
    public function delete($id_kategori_download)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	DB::table('kategori_download')->where('id_kategori_download',$id_kategori_download)->delete();
    	return redirect('admin/kategori_download')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Kategori_download.php ===


=== START OF FILE: Http\Controllers\Admin\Kategori_galeri.php ===
<?php
namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class Kategori_galeri extends Controller
{
    // Index
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
		$kategori_galeri 	= DB::table('kategori_galeri')->orderBy('urutan','ASC')->get();

		$data = array(  'title'             => 'Kategori Galeri',
						'kategori_galeri'	=> $kategori_galeri,
                        'content'           => 'admin/kategori_galeri/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'nama_kategori_galeri' => 'required|unique:kategori_galeri',
					        'urutan' 		       => 'required',
					        ]);
    	$slug_kategori_galeri = Str::slug($request->nama_kategori_galeri, '-');
        DB::table('kategori_galeri')->insert([
            'nama_kategori_galeri'  => $request->nama_kategori_galeri,
            'slug_kategori_galeri'	=> $slug_kategori_galeri,
            'urutan'   		        => $request->urutan
        ]);
        return redirect('admin/kategori_galeri')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'nama_kategori_galeri' => 'required',
					        'urutan'               => 'required',
					        ]);
    	$slug_kategori_galeri = Str::slug($request->nama_kategori_galeri, '-');
        DB::table('kategori_galeri')->where('id_kategori_galeri',$request->id_kategori_galeri)->update([
            'nama_kategori_galeri'  => $request->nama_kategori_galeri,
            'slug_kategori_galeri'	=> $slug_kategori_galeri,
            'urutan'                => $request->urutan
        ]);
        return redirect('admin/kategori_galeri')->with(['sukses' => 'Data telah diupdate']);
    }

    // Delete
    public function delete($id_kategori_galeri)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	DB::table('kategori_galeri')->where('id_kategori_galeri',$id_kategori_galeri)->delete();
    	return redirect('admin/kategori_galeri')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Kategori_galeri.php ===


=== START OF FILE: Http\Controllers\Admin\Kategori_property.php ===
<?php
namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class Kategori_property extends Controller
{
    // Index
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
		$kategori_property 	= DB::table('kategori_property')->orderBy('urutan','ASC')->get();

		$data = array(  'title'             => 'Kategori Property',
						'kategori_property'	=> $kategori_property,
                        'content'           => 'admin/kategori_property/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
                'nama_kategori_property' => 'required|unique:kategori_property',
                'urutan' 		         => 'required',
            ]);
    	$slug_kategori_property = Str::slug($request->nama_kategori_property, '-');
        DB::table('kategori_property')->insert([
            'nama_kategori_property' => $request->nama_kategori_property,
            'slug_kategori_property' => $slug_kategori_property,
            'keterangan'             => $request->keterangan,
            'urutan'   		         => $request->urutan
        ]);
        return redirect('admin/kategori_property')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
                'nama_kategori_property' => 'required',
                'urutan'                 => 'required',
            ]);
    	$slug_kategori_property = Str::slug($request->nama_kategori_property, '-');
        DB::table('kategori_property')->where('id_kategori_property',$request->id_kategori_property)->update([
            'nama_kategori_property' => $request->nama_kategori_property,
            'slug_kategori_property' => $slug_kategori_property,
            'keterangan'             => $request->keterangan,
            'urutan'                 => $request->urutan
        ]);
        return redirect('admin/kategori_property')->with(['sukses' => 'Data telah diupdate']);
    }

    // Delete
    public function delete($id_kategori_property)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	DB::table('kategori_property')->where('id_kategori_property',$id_kategori_property)->delete();
    	return redirect('admin/kategori_property')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Kategori_property.php ===


=== START OF FILE: Http\Controllers\Admin\Kategori_staff.php ===
<?php
namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class Kategori_staff extends Controller
{
    // Index
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
		$kategori_staff 	= DB::table('kategori_staff')->orderBy('urutan','ASC')->get();

		$data = array(  'title'             => 'Kategori Staff',
						'kategori_staff'	=> $kategori_staff,
                        'content'           => 'admin/kategori_staff/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'nama_kategori_staff' => 'required|unique:kategori_staff',
					        'urutan' 		       => 'required',
					        ]);
    	$slug_kategori_staff = Str::slug($request->nama_kategori_staff, '-');
        DB::table('kategori_staff')->insert([
            'nama_kategori_staff'   => $request->nama_kategori_staff,
            'slug_kategori_staff'	=> $slug_kategori_staff,
            'keterangan'            => $request->keterangan,
            'urutan'   		        => $request->urutan
        ]);
        return redirect('admin/kategori_staff')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'nama_kategori_staff' => 'required',
					        'urutan'               => 'required',
					        ]);
    	$slug_kategori_staff = Str::slug($request->nama_kategori_staff, '-');
        DB::table('kategori_staff')->where('id_kategori_staff',$request->id_kategori_staff)->update([
            'nama_kategori_staff'   => $request->nama_kategori_staff,
            'slug_kategori_staff'	=> $slug_kategori_staff,
            'keterangan'            => $request->keterangan,
            'urutan'                => $request->urutan
        ]);
        return redirect('admin/kategori_staff')->with(['sukses' => 'Data telah diupdate']);
    }

    // Delete
    public function delete($id_kategori_staff)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	DB::table('kategori_staff')->where('id_kategori_staff',$id_kategori_staff)->delete();
    	return redirect('admin/kategori_staff')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Kategori_staff.php ===


=== START OF FILE: Http\Controllers\Admin\Konfigurasi.php ===
<?php

namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Intervention\Image\Facades\Image;
use App\Models\Konfigurasi as KonfigurasiModel;

class Konfigurasi extends Controller
{
    // Main page
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mykonfigurasi 	= new KonfigurasiModel();
        $site 			= $mykonfigurasi->listing();

		$data = array(  'title'        => 'Data Konfigurasi',
						'site'         => $site,
                        'content'      => 'admin/konfigurasi/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // logo
    public function logo()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mykonfigurasi  = new KonfigurasiModel();
        $site           = $mykonfigurasi->listing();

        $data = array(  'title'        => 'Update Logo',
                        'site'         => $site,
                        'content'      => 'admin/konfigurasi/logo'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // --- AWAL PERBAIKAN ---

    // profil
    public function profil()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        // Menggunakan KonfigurasiModel, bukan Konfigurasi
        $mykonfigurasi  = new KonfigurasiModel();
        $site           = $mykonfigurasi->listing();

        $data = array(  'title'        => 'Profil '.$site->namaweb,
                        'site'         => $site,
                        'content'      => 'admin/konfigurasi/profil'
                    );
        return view('admin/layout/wrapper',$data);
    }

    public function profil_kontraktor()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        // Menggunakan KonfigurasiModel, bukan Konfigurasi
        $mykonfigurasi  = new KonfigurasiModel();
        $site           = $mykonfigurasi->listing();

        $data = array(  'title'        => 'Profil Kontraktor '.$site->namaweb,
                        'site'         => $site,
                        'content'      => 'admin/konfigurasi/profil_kontraktor'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // gambar
    public function gambar()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        // Menggunakan KonfigurasiModel, bukan Konfigurasi
        $mykonfigurasi  = new KonfigurasiModel();
        $site           = $mykonfigurasi->listing();

        $data = array(  'title'        => 'Update Gambar Banner',
                        'site'         => $site,
                        'content'      => 'admin/konfigurasi/gambar'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // icon
    public function icon()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        // Menggunakan KonfigurasiModel, bukan Konfigurasi
        $mykonfigurasi  = new KonfigurasiModel();
        $site           = $mykonfigurasi->listing();

        $data = array(  'title'        => 'Update Icon',
                        'site'         => $site,
                        'content'      => 'admin/konfigurasi/icon'
                    );
        return view('admin/layout/wrapper',$data);
    }


    // email
    public function email()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        // Menggunakan KonfigurasiModel, bukan Konfigurasi
        $mykonfigurasi  = new KonfigurasiModel();
        $site           = $mykonfigurasi->listing();

        $data = array(  'title'        => 'Update Setting Email',
                        'site'         => $site,
                        'content'      => 'admin/konfigurasi/email'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // pembayaran
    public function pembayaran()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        // Menggunakan KonfigurasiModel, bukan Konfigurasi
        $mykonfigurasi  = new KonfigurasiModel();
        $site           = $mykonfigurasi->listing();

        $data = array(  'title'        => 'Update Panduan Pembayaran',
                        'site'         => $site,
                        'content'      => 'admin/konfigurasi/pembayaran'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Proses
    public function proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'namaweb'          => 'required'
                            ]);
       DB::table('konfigurasi')->where('id_konfigurasi',$request->id_konfigurasi)->update([
            'namaweb'           => $request->namaweb,
            'nama_singkat'      => $request->nama_singkat,
            'singkatan'         => $request->singkatan,
            'tagline'           => $request->tagline,
            'tagline2'          => $request->tagline2,
            'tentang'           => $request->tentang,
            'website'           => $request->website,
            'email'             => $request->email,
            'email_cadangan'    => $request->email_cadangan,
            'alamat'            => $request->alamat,
            'telepon'           => $request->telepon,
            'hp'                => $request->hp,
            'fax'               => $request->fax,
            'deskripsi'         => $request->deskripsi,
            'keywords'          => $request->keywords,
            'metatext'          => $request->metatext,
            'facebook'          => $request->facebook,
            'tiktok'            => $request->tiktok,
            'instagram'         => $request->instagram,
            'youtube'           => $request->youtube,
            'linkedin'          => $request->linkedin,
            'nama_facebook'     => $request->nama_facebook,
            'nama_tiktok'       => $request->nama_tiktok,
            'nama_instagram'    => $request->nama_instagram,
            'nama_youtube'      => $request->nama_youtube,
            'nama_linkedin'     => $request->nama_linkedin,
            'google_map'        => $request->google_map,
            'text_bawah_peta'   => $request->text_bawah_peta,
            'link_bawah_peta'   => $request->link_bawah_peta,
            'cara_pesan'        => $request->cara_pesan,
            'id_user'           => Session()->get('id_user'),
        ]);
        return redirect('admin/konfigurasi')->with(['sukses' => 'Data telah diupdate']);
    }

    // Proses
    public function proses_email(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'protocol'          => 'required',
                            'smtp_host'          => 'required',
                            'smtp_port'          => 'required',
                            'smtp_timeout'       => 'required',
                            'smtp_user'          => 'required',
                            'smtp_pass'          => 'required'
                            ]);
       DB::table('konfigurasi')->where('id_konfigurasi',$request->id_konfigurasi)->update([
            'protocol'          => $request->protocol,
            'smtp_host'         => $request->smtp_host,
            'smtp_port'         => $request->smtp_port,
            'smtp_timeout'      => $request->smtp_timeout,
            'smtp_user'         => $request->smtp_user,
            'smtp_pass'         => $request->smtp_pass,
            'id_user'           => Session()->get('id_user'),
        ]);
        return redirect('admin/konfigurasi/email')->with(['sukses' => 'Data setting email telah diupdate']);
    }

    // logo
    public function proses_logo(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'logo'        => 'required|file|image|mimes:jpeg,png,jpg|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('logo');
        $filenamewithextension  = $request->file('logo')->getClientOriginalName();
        $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
        $input['nama_file']     = Str::slug($filename, '-').'.'.$image->getClientOriginalExtension();
        $destinationPath        = './assets/upload/image/thumbs/';
        $img = Image::make($image->getRealPath(),array(
            'width'     => 150,
            'height'    => 150,
            'grayscale' => false
        ));
        $img->save($destinationPath.'/'.$input['nama_file']);
        $destinationPath = './assets/upload/image/';
        $image->move($destinationPath, $input['nama_file']);
        // END UPLOAD
        DB::table('konfigurasi')->where('id_konfigurasi',$request->id_konfigurasi)->update([
            'id_user'  => Session()->get('id_user'),
            'logo'     => $input['nama_file']
        ]);
        return redirect('admin/konfigurasi/logo')->with(['sukses' => 'Logo telah diupdate']);
    }

    // logo
    public function proses_profil(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'gambar'        => 'file|image|mimes:jpeg,png,jpg|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            DB::table('konfigurasi')->where('id_konfigurasi',$request->id_konfigurasi)->update([
                'id_user'       => Session()->get('id_user'),
                'nama_singkat'  => $request->nama_singkat,
                'tentang'       => $request->tentang,
                'gambar'        => $input['nama_file']
            ]);
        }else{
            DB::table('konfigurasi')->where('id_konfigurasi',$request->id_konfigurasi)->update([
                'id_user'       => Session()->get('id_user'),
                'nama_singkat'  => $request->nama_singkat,
                'tentang'       => $request->tentang
            ]);
        }
        return redirect('admin/konfigurasi/profil')->with(['sukses' => 'Profil telah diupdate']);
    }

    public function proses_profil_kontraktor(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'gambar'        => 'file|image|mimes:jpeg,png,jpg|max:8024',
                            ]);
        // UPLOAD START
        $image = $request->file('gambar_kontraktor');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar_kontraktor')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            DB::table('konfigurasi')->where('id_konfigurasi',$request->id_konfigurasi)->update([
                'id_user'       => Session()->get('id_user'),
                'nama_singkat_kontraktor'  => $request->nama_singkat_kontraktor,
                'tentang_kontraktor'       => $request->tentang_kontraktor,
                'gambar_kontraktor'        => $input['nama_file']
            ]);
        }else{
            DB::table('konfigurasi')->where('id_konfigurasi',$request->id_konfigurasi)->update([
                'id_user'       => Session()->get('id_user'),
                'nama_singkat_kontraktor'  => $request->nama_singkat_kontraktor,
                'tentang_kontraktor'       => $request->tentang_kontraktor
            ]);
        }
        return redirect('admin/konfigurasi/profil_kontraktor')->with(['sukses' => 'Profil Kontraktor telah diupdate']);
    }

    // icon
    public function proses_icon(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'icon'        => 'required|file|image|mimes:jpeg,png,jpg|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('icon');
        $filenamewithextension  = $request->file('icon')->getClientOriginalName();
        $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
        $input['nama_file']     = Str::slug($filename, '-').'.'.$image->getClientOriginalExtension();
        $destinationPath        = './assets/upload/image/thumbs';
        $img = Image::make($image->getRealPath(),array(
            'width'     => 150,
            'height'    => 150,
            'grayscale' => false
        ));
        $img->save($destinationPath.'/'.$input['nama_file']);
        $destinationPath = './assets/upload/image';
        $image->move($destinationPath, $input['nama_file']);
        // END UPLOAD
        DB::table('konfigurasi')->where('id_konfigurasi',$request->id_konfigurasi)->update([
            'id_user'  => Session()->get('id_user'),
            'icon'     => $input['nama_file']
        ]);
        return redirect('admin/konfigurasi/icon')->with(['sukses' => 'Icon telah diupdate']);
    }

    // gambar
    public function proses_gambar(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'gambar'        => 'required|file|image|mimes:jpeg,png,jpg|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
        $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
        $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
        $destinationPath        = './assets/upload/image/thumbs/';
        $img = Image::make($image->getRealPath(),array(
            'width'     => 150,
            'height'    => 150,
            'grayscale' => false
        ));
        $img->save($destinationPath.'/'.$input['nama_file']);
        $destinationPath = './assets/upload/image/';
        $image->move($destinationPath, $input['nama_file']);
        // END UPLOAD
        DB::table('konfigurasi')->where('id_konfigurasi',$request->id_konfigurasi)->update([
            'id_user'  => Session()->get('id_user'),
            'gambar'     => $input['nama_file']
        ]);
        return redirect('admin/konfigurasi/gambar')->with(['sukses' => 'Gambar Banner telah diupdate']);
    }

    // edit
    public function proses_pembayaran(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'judul_pembayaran'  => 'required',
                            'isi_pembayaran'    => 'required',
                            'gambar_pembayaran' => 'image|mimes:jpeg,png,jpg|max:8024',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar_pembayaran');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar_pembayaran')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            DB::table('konfigurasi')->where('id_konfigurasi',$request->id_konfigurasi)->update([
                'judul_pembayaran'  => $request->judul_pembayaran,
                'isi_pembayaran'    => $request->isi_pembayaran,
                'gambar_pembayaran' => $input['nama_file'],
                'id_user'           => Session()->get('id_user'),
            ]);
        }else{
             DB::table('konfigurasi')->where('id_konfigurasi',$request->id_konfigurasi)->update([
                'judul_pembayaran'  => $request->judul_pembayaran,
                'isi_pembayaran'    => $request->isi_pembayaran,
                'id_user'           => Session()->get('id_user'),
            ]);
        }
        return redirect('admin/konfigurasi/pembayaran')->with(['sukses' => 'Data metode pembayaran telah diupdate']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Konfigurasi.php ===


=== START OF FILE: Http\Controllers\Admin\Paket_iklan.php ===
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\PaketIklan;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Session; // Tambahkan ini untuk session check

class Paket_iklan extends Controller
{
    /**
     * Menampilkan halaman utama untuk Kelola Paket Iklan.
     */
    public function index()
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        
        $paket_iklan = PaketIklan::orderBy('harga', 'asc')->paginate(10);

        $data = [
            'title'         => 'Kelola Paket Iklan',
            'paket_iklan'   => $paket_iklan,
            'content'       => 'admin/paket_iklan/index'
        ];
        return view('admin/layout/wrapper', $data);
    }

    /**
     * Menampilkan form untuk membuat paket baru.
     */
    public function create()
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}

        $data = [
            'title'   => 'Tambah Paket Iklan Baru',
            'content' => 'admin/paket_iklan/create'
        ];
        return view('admin/layout/wrapper', $data);
    }

    /**
     * Menyimpan paket baru ke database.
     */
    public function store(Request $request)
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}

        $request->validate([
            'nama_paket'  => 'required|string|max:100|unique:paket_iklan',
            'harga'       => 'required|numeric|min:0',
            'kuota_iklan' => 'required|integer|min:0',
        ]);

        PaketIklan::create($request->all());

        return redirect('admin/paket-iklan')->with('sukses', 'Data berhasil ditambahkan.');
    }

    /**
     * Menampilkan form untuk mengedit paket.
     */
    public function edit($id)
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}

        $paket = PaketIklan::findOrFail($id);

        $data = [
            'title'   => 'Edit Paket: ' . $paket->nama_paket,
            'paket'   => $paket,
            'content' => 'admin/paket_iklan/edit'
        ];
        return view('admin/layout/wrapper', $data);
    }
    
    public function update(Request $request, $id)
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}

        $request->validate([
            'nama_paket'  => 'required|string|max:100|unique:paket_iklan,nama_paket,' . $id,
            'harga'       => 'required|numeric|min:0',
            'kuota_iklan' => 'required|integer|min:0',
        ]);

        $paket = PaketIklan::findOrFail($id);
        $paket->update($request->all());

        return redirect('admin/paket-iklan')->with('sukses', 'Data berhasil diperbarui.');
    }

    /**
     * Menghapus paket dari database.
     */
    public function destroy($id)
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}

        // --- PERBAIKAN DI SINI ---
               DB::table('paket_iklan')->where('id',$id)->delete();


        // Redirect kembali ke halaman daftar dengan pesan sukses
        return redirect('admin/paket-iklan')->with(['sukses' => 'Data berhasil dihapus.']);
    }

    /**
     * FUNGSI BARU UNTUK PROSES HAPUS MASSAL
     */
    public function proses(Request $request)
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        
        // Ambil ID dari checkbox yang dipilih
        $id_paket = $request->id_paket;

        // Pastikan ada item yang dipilih
        if(empty($id_paket)) {
            return redirect('admin/paket-iklan')->with(['warning' => 'Anda belum memilih data untuk dihapus.']);
        }

        // Hapus data yang dipilih menggunakan DB Facades
        DB::table('paket_iklan')->whereIn('id', $id_paket)->delete();

        return redirect('admin/paket-iklan')->with(['sukses' => 'Data yang dipilih berhasil dihapus.']);
    }

    // ... (fungsi index, create, store, edit, update, delete tidak berubah) ...

    // --- FUNGSI UNTUK MENAMPILKAN HALAMAN BELI PAKET (DIPERBAIKI) ---
    public function beliUntukMember()
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}

        // Ambil data paket, rekening, dan site config
        $paket_iklan = PaketIklan::where('is_active', true)->orderBy('harga', 'asc')->get();
        $rekening = DB::table('rekening')->get();
        $site = DB::table('konfigurasi')->first();

        // --- AWAL LOGIKA BARU UNTUK DAFTAR STAFF ---
        $staff_list = null;
        if(Session::get('akses_level') == 'Admin') {
            // Jika Admin, ambil semua staff
            $staff_list = DB::table('staff')->orderBy('nama_staff', 'asc')->get();
        } else {
            // Jika User, ambil HANYA staff yang terhubung dengan id_user mereka
            $staff_list = DB::table('staff')->where('id_user', Session::get('id_user'))->get();
        }
        // --- AKHIR LOGIKA BARU ---

        $data = [
            'title'         => 'Beli Paket Iklan untuk Member',
            'paket_iklan'   => $paket_iklan,
            'rekening'      => $rekening,
            'site'          => $site,
            'staff_list'    => $staff_list, // Kirim daftar staff yang sudah difilter
            'content'       => 'admin/paket_iklan/beli_untuk_member'
        ];
        return view('admin/layout/wrapper', $data);
    }

    // --- FUNGSI BARU UNTUK MEMPROSES FORM PEMBELIAN ---
    public function prosesPembelian(Request $request)
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}

        $request->validate([
            'paket_id'          => 'required|exists:paket_iklan,id',
            'bukti_pembayaran'  => 'required|file|mimes:jpeg,jpg,png|max:4096',
            // Validasi staff_id hanya jika yang login adalah Admin
            'staff_id'          => (Session::get('akses_level') == 'Admin' ? 'required|exists:staff,id_staff' : 'nullable')
        ]);

        // Tentukan id_user berdasarkan siapa yang login
        if(Session::get('akses_level') == 'Admin') {
            $staff = DB::table('staff')->where('id_staff', $request->staff_id)->first();
            $id_user = $staff->id_user;
        } else {
            // Jika user biasa, ambil id_user dari session
            $id_user = Session::get('id_user');
        }

        // Proses upload gambar bukti pembayaran
        $image = $request->file('bukti_pembayaran');
        $originalName = pathinfo($image->getClientOriginalName(), PATHINFO_FILENAME);
        $extension = $image->getClientOriginalExtension();
        
        // Clean filename and limit length
        $cleanName = Str::slug($originalName, '-');
        $cleanName = substr($cleanName, 0, 50); // Limit to 50 characters
        
        $nama_file = time() . '_' . $cleanName . '.' . $extension;
        $tujuan_upload = 'assets/upload/bukti';
        $image->move($tujuan_upload, $nama_file);

        // Simpan data transaksi ke database
        //  FIXED: Added missing id_staff and keterangan fields
        $staff = DB::table('staff')->where('id_user', $id_user)->first();
        $paket = DB::table('paket_iklan')->where('id', $request->paket_id)->first();

        DB::table('transaksi_paket')->insert([
            'id_user'           => $id_user,
            'id_staff'          => $staff ? $staff->id_staff : 0, //  ADDED: Required field
            'paket_id'          => $request->paket_id,
            'kode_transaksi'    => 'WSP-'.strtoupper(uniqid()),
            'status_pembayaran' => 'pending',
            'bukti_pembayaran'  => $nama_file,
            'keterangan'        => 'Pembelian paket ' . ($paket ? $paket->nama_paket : 'iklan'), //  ADDED: Required field
            'created_at'        => now(),
            'updated_at'        => now()
        ]);

        return redirect('admin/dasbor')->with('sukses', 'Pesanan Anda telah diterima dan akan segera diproses oleh Admin. Terima kasih.');
    }
}

=== END OF FILE: Http\Controllers\Admin\Paket_iklan.php ===


=== START OF FILE: Http\Controllers\Admin\Promosi.php ===
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use App\Models\Promosi as PromosiModel;
use Image;

class Promosi extends Controller
{
    // Halaman index - daftar promosi
    public function index()
    {
        $promosi = PromosiModel::orderBy('urutan', 'ASC')
                              ->orderBy('id_promosi', 'DESC')
                              ->get();

        $data = array(
            'title' => 'Data Promosi',
            'promosi' => $promosi,
            'content' => 'admin/promosi/index'
        );
        return view('admin/layout/wrapper', $data);
    }

    // Halaman tambah promosi
    public function tambah()
    {
        $data = array(
            'title' => 'Tambah Promosi',
            'content' => 'admin/promosi/tambah'
        );
        return view('admin/layout/wrapper', $data);
    }

    // Proses tambah promosi
    public function tambah_proses(Request $request)
    {
        $request->validate([
            'judul_promosi' => 'required|max:200',
            'gambar' => 'required|image|mimes:jpeg,jpg,png,gif|max:8192',
            'status_promosi' => 'required|in:Aktif,Tidak Aktif',
            'urutan' => 'required|integer',
        ]);

        // Upload gambar
        if ($request->hasFile('gambar')) {
            $file = $request->file('gambar');
            $filename = time() . '_' . Str::slug($request->judul_promosi) . '.' . $file->getClientOriginalExtension();
            
            // Simpan gambar original
            $file->move(public_path('assets/upload/promosi'), $filename);
        }

        // Simpan ke database
        PromosiModel::create([
            'judul_promosi' => $request->judul_promosi,
            'deskripsi' => $request->deskripsi,
            'gambar' => $filename ?? '',
            'link_url' => $request->link_url,
            'status_promosi' => $request->status_promosi,
            'urutan' => $request->urutan,
            'tanggal_mulai' => $request->tanggal_mulai,
            'tanggal_selesai' => $request->tanggal_selesai,
        ]);

        return redirect('admin/promosi')->with('sukses', 'Promosi berhasil ditambahkan');
    }

    // Halaman edit promosi
    public function edit($id_promosi)
    {
        $promosi = PromosiModel::findOrFail($id_promosi);

        $data = array(
            'title' => 'Edit Promosi',
            'promosi' => $promosi,
            'content' => 'admin/promosi/edit'
        );
        return view('admin/layout/wrapper', $data);
    }

    // Proses edit promosi
    public function edit_proses(Request $request)
    {
        $request->validate([
            'id_promosi' => 'required',
            'judul_promosi' => 'required|max:200',
            'status_promosi' => 'required|in:Aktif,Tidak Aktif',
            'urutan' => 'required|integer',
        ]);

        $promosi = PromosiModel::findOrFail($request->id_promosi);
        $filename = $promosi->gambar;

        // Upload gambar baru jika ada
        if ($request->hasFile('gambar')) {
            $request->validate([
                'gambar' => 'image|mimes:jpeg,jpg,png,gif|max:8192',
            ]);

            $file = $request->file('gambar');
            $filename = time() . '_' . Str::slug($request->judul_promosi) . '.' . $file->getClientOriginalExtension();
            
            // Hapus gambar lama
            if (file_exists(public_path('assets/upload/promosi/' . $promosi->gambar))) {
                unlink(public_path('assets/upload/promosi/' . $promosi->gambar));
            }

            // Simpan gambar baru
            $file->move(public_path('assets/upload/promosi'), $filename);
        }

        // Update database
        $promosi->update([
            'judul_promosi' => $request->judul_promosi,
            'deskripsi' => $request->deskripsi,
            'gambar' => $filename,
            'link_url' => $request->link_url,
            'status_promosi' => $request->status_promosi,
            'urutan' => $request->urutan,
            'tanggal_mulai' => $request->tanggal_mulai,
            'tanggal_selesai' => $request->tanggal_selesai,
        ]);

        return redirect('admin/promosi')->with('sukses', 'Promosi berhasil diupdate');
    }

    // Delete promosi
    public function delete($id_promosi)
    {
        $promosi = PromosiModel::findOrFail($id_promosi);

        // Hapus gambar
        if (file_exists(public_path('assets/upload/promosi/' . $promosi->gambar))) {
            unlink(public_path('assets/upload/promosi/' . $promosi->gambar));
        }

        // Hapus dari database
        $promosi->delete();

        return redirect('admin/promosi')->with('sukses', 'Promosi berhasil dihapus');
    }
}


=== END OF FILE: Http\Controllers\Admin\Promosi.php ===


=== START OF FILE: Http\Controllers\Admin\Property.php ===
<?php

namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Log;
use Image;
use App\Models\Property as PropertyModel;
use App\Models\Staff as StaffModel;
use App\Services\WaisakaAiService;

class Property extends Controller
{
    // Main page
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	$myproperty 	    = new PropertyModel();
		$property 			= $myproperty->semua();
        $tipe               = 'all';
		$kategori_property  = DB::table('kategori_property')->orderBy('urutan','ASC')->get();

        // Tambahkan statistik seperti di API
        $totalProperties = DB::table('property_db')->count();
        $activeProperties = DB::table('property_db')->where('status', 1)->count();
        $totalStaff = DB::table('staff')->count();

		$data = array(  'title'				=> 'Data Property',
						'property'		    => $property,
						'kategori_property'	=> $kategori_property,
                        'tipe'              => $tipe,
                        'statistics'        => [
                            'total_properties' => $totalProperties,
                            'active_properties' => $activeProperties,
                            'total_staff' => $totalStaff
                        ],
                        'content'			=> 'admin/property/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Main page
    public function detail($id_property)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $myproperty = new PropertyModel();
        $property   = $myproperty->detail($id_property);
        $images     = DB::table('property_img')->where('id_property',$property->id_property)->orderBy('id_property_img')->get();
        $mystaff        = new Staff();
        $staff          = $mystaff->detail($property->id_staff);

        $gambar = [];
        foreach($images as $key => $img) {
            $gambar[$key] = $img;
        }

        $data = array(  'title'             => $property->nama_property,
                        'property'          => $property,
                        'gambar'            => $gambar,
                        'staff'             => $staff,
                        'content'           => 'admin/property/detail'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Cari
    public function cari(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $myproperty        = new PropertyModel();
        $keywords          = $request->keywords;
        $tipe              = $request->tipe;
        $property          = $myproperty->cari($keywords,$tipe);
        $kategori_property = DB::table('kategori_property')->orderBy('urutan','ASC')->get();
        $data = array(  'title'             => 'Data Property',
                        'property'          => $property,
                        'tipe'              => $tipe,
                        'kategori_property' => $kategori_property,
                        'content'           => 'admin/property/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Proses
    public function proses(Request $request)
    {
        $site = DB::table('konfigurasi')->first();
        // PROSES HAPUS MULTIPLE
        if(isset($_POST['hapus'])) {
            $id_property = $request->id_property;
            for($i=0; $i < sizeof($id_property);$i++) {
                DB::table('property_db')->where('id_property',$id_property[$i])->delete();
            }
            return redirect('admin/property')->with(['sukses' => 'Data telah dihapus']);
        // PROSES SETTING DRAFT
        }elseif(isset($_POST['update'])) {
            $id_property = $request->id_property;
            for($i=0; $i < sizeof($id_property);$i++) {
                DB::table('property_db')->where('id_property',$id_property[$i])->update([
                        'id_property'          => Session()->get('id_property'),
                        'id_kategori_property' => $request->id_kategori_property
                    ]);
            }
            return redirect('admin/property')->with(['sukses' => 'Data kategori telah diubah']);
        }
    }

    //Kategori
    public function kategori($id_kategori_property)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $myproperty        = new PropertyModel();
        $property          = $myproperty->all_kategori_property($id_kategori_property);
        $tipe              = 'all';
        $kategori_property = DB::table('kategori_property')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Data Property',
                        'property'          => $property,
                        'tipe'              => $tipe,
                        'kategori_property' => $kategori_property,
                        'content'           => 'admin/property/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Tambah
    public function tambah()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $kategori_property = DB::table('kategori_property')->orderBy('urutan','ASC')->get();
        $staff = DB::table('staff')->orderBy('nama_staff','ASC')->get();
        $provinsi = DB::table('provinsi')->orderBy('nama','ASC')->get();

        $data = array(  'title'             => 'Tambah Property',
                        'kategori_property' => $kategori_property,
                        'provinsi'          => $provinsi,
                        'staff'             => $staff,
                        'content'           => 'admin/property/tambah'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // edit
    public function edit($id_property)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $myproperty        = new PropertyModel();
        $property          = $myproperty->detail($id_property);
        $kategori_property = DB::table('kategori_property')->orderBy('urutan','ASC')->get();
        $staff             = DB::table('staff')->orderBy('nama_staff','ASC')->get();
        $images     = DB::table('property_img')->where('id_property',$property->id_property)->orderBy('id_property_img')->get();
        $provinsi   = DB::table('provinsi')->orderBy('nama','ASC')->get();
        $kabupaten  = DB::table('kabupaten')->where('id_provinsi',$property->id_provinsi)->orderBy('nama','ASC')->get();
        $kecamatan  = DB::table('kecamatan')->where('id_kabupaten',$property->id_kabupaten)->orderBy('nama','ASC')->get();

        $gambar = [];
        foreach($images as $key => $img) {
            $gambar[$key] = $img;
        }

        for($i=0;$i<10;$i++) {
            $gambar_v[$i] = isset($gambar[$i]) ? $gambar[$i]->gambar : ''; 
        }

        $data = array(  'title'             => 'Edit Property',
                        'property'          => $property,
                        'kategori_property' => $kategori_property,
                        'provinsi'          => $provinsi,
                        'kabupaten'         => $kabupaten,
                        'kecamatan'         => $kecamatan,
                        'gambar'            => $gambar_v,
                        'staff'             => $staff,
                        'content'           => 'admin/property/edit'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                    'kode'          => 'required|unique:property_db',
                    'nama_property' => 'required|unique:property_db',
                    'lt'            => 'required|numeric',
                    'lb'            => 'required|numeric',
                    'harga'         => 'required|numeric',
                    'id_provinsi'   => 'required',
                    'id_kabupaten'  => 'required',
                    'id_kecamatan'  => 'required',
                    'harga'         => 'required|numeric',
                    'lantai'        => 'numeric',
                    'keywords'      => 'required',
                ]);
        
        $slug_property = Str::slug($request->nama_property);
        $id_property = DB::table('property_db')->insertGetId([
            'id_kategori_property' => $request->id_kategori_property,
            'kode'                 => $request->kode,
            'slug_property'        => $slug_property,
            'nama_property'        => $request->nama_property,
            'tipe'                 => $request->tipe,
            'jenis_sewa'           => $request->jenis_sewa,
            'harga'                => $request->harga,
            'status'               => $request->status,
            'surat'                => $request->surat,
            'lt'                   => $request->lt,
            'lb'                   => $request->lb,
            'isi'                  => $request->isi,
            'kamar_tidur'          => $request->kamar_tidur,
            'kamar_mandi'          => $request->kamar_mandi,
            'lantai'               => $request->lantai,
            'id_staff'             => $request->id_staff,
            'alamat'               => $request->alamat,
            'id_provinsi'          => $request->id_provinsi,
            'id_kabupaten'         => $request->id_kabupaten,
            'id_kecamatan'         => $request->id_kecamatan,
            'keywords'             => $request->keywords
        ]);

        // UPLOAD START
        $images = $request->file('gambar');
        foreach($request->gambar as $key => $val) {
            $image = $images[$key];
            if(!empty($image)) {
                $filenamewithextension  = $image->getClientOriginalName();
                $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
                $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
                $destinationPath = './assets/upload/property/';
                $image->move($destinationPath, $input['nama_file']);
            }

            DB::table('property_img')->insert([
                'id_property'   => $id_property,
                'gambar'        => $input['nama_file'],
                'index_img'     => $key
            ]);
        }

        // END UPLOAD

        // AUTO-GENERATE AI INSIGHTS (Harga Rata, Fasilitas Terdekat, Peta Map)
        $this->generateAiInsights($id_property);

        return redirect('admin/property')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                                'kode'          => 'required',
                                'nama_property' => 'required',
                                'lt'            => 'required|numeric',
                                'lb'            => 'required|numeric',
                                'harga'         => 'required|numeric',
                                'id_provinsi'   => 'required',
                                'id_kabupaten'  => 'required',
                                'id_kecamatan'  => 'required',
                                'harga'         => 'required|numeric',
                                'lantai'        => 'numeric',
                                'keywords'      => 'required',
                            ]);
       
        $slug_property = Str::slug($request->nama_property);
        DB::table('property_db')->where('id_property',$request->id_property)->update([
            'id_kategori_property' => $request->id_kategori_property,
            'kode'                 => $request->kode,
            'slug_property'        => $slug_property,
            'nama_property'        => $request->nama_property,
            'tipe'                 => $request->tipe,
            'jenis_sewa'           => $request->jenis_sewa,
            'harga'                => $request->harga,
            'status'               => $request->status,
            'surat'                => $request->surat,
            'lt'                   => $request->lt,
            'lb'                   => $request->lb,
            'isi'                  => $request->isi,
            'kamar_tidur'          => $request->kamar_tidur,
            'kamar_mandi'          => $request->kamar_mandi,
            'lantai'               => $request->lantai,
            'id_staff'             => $request->id_staff,
            'alamat'               => $request->alamat,
            'id_provinsi'          => $request->id_provinsi,
            'id_kabupaten'         => $request->id_kabupaten,
            'id_kecamatan'         => $request->id_kecamatan,
            'keywords'             => $request->keywords
        ]);
        
        // UPLOAD START
        $images = $request->file('gambar');
        if($request->gambar) {
            foreach($request->gambar as $key => $val) {
                $image = $images[$key];
                if(!empty($image)) {
                    $filenamewithextension  = $image->getClientOriginalName();
                    $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
                    $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
                    $destinationPath = './assets/upload/property/';
                    $image->move($destinationPath, $input['nama_file']);
                }

                DB::table('property_img')->updateOrInsert([
                    'id_property'   => $request->id_property,
                    'index_img'     => $key
                ],[
                    'gambar'        => $input['nama_file']
                ]);
            }
        }

        // END UPLOAD

        // AUTO-GENERATE AI INSIGHTS (Harga Rata, Fasilitas Terdekat, Peta Map)
        // Hanya generate jika field masih kosong
        $this->generateAiInsights($request->id_property);

        return redirect('admin/property')->with(['sukses' => 'Data telah ditambah']);
    }

    // Delete
    public function delete($id_property)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        DB::table('property_db')->where('id_property',$id_property)->delete();
        DB::table('property_img')->where('id_property',$id_property)->delete();
        return redirect('admin/property')->with(['sukses' => 'Data telah dihapus']);
    }

    /**
     * Generate AI insights untuk property (Harga Rata, Fasilitas Terdekat, Peta Map)
     * Dipanggil saat tambah atau edit property
     */
    protected function generateAiInsights($id_property)
    {
        try {
            // Ambil data property lengkap
            $property = DB::table('property_db')
                ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property', 'LEFT')
                ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi', 'LEFT')
                ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten', 'LEFT')
                ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan', 'LEFT')
                ->select(
                    'property_db.*',
                    'kategori_property.nama_kategori_property',
                    'provinsi.nama as nama_provinsi',
                    'kabupaten.nama as nama_kabupaten',
                    'kecamatan.nama as nama_kecamatan'
                )
                ->where('property_db.id_property', $id_property)
                ->first();

            if (!$property) {
                Log::warning("Property tidak ditemukan untuk AI insights: ID {$id_property}");
                return;
            }

            $aiService = app(WaisakaAiService::class);
            $updateData = [];

            // 1. Generate Harga Rata-rata (jika belum ada)
            if (empty(trim($property->harga_rata ?? ''))) {
                $hargaRata = $this->getHargaRata($property, $aiService);
                if ($hargaRata) {
                    $updateData['harga_rata'] = $hargaRata;
                    Log::info("AI Harga Rata generated untuk property ID {$id_property}");
                }
            }

            // 2. Generate Fasilitas Terdekat (jika belum ada)
            if (empty(trim($property->fasilitas_terdekat ?? ''))) {
                $fasilitasTerdekat = $this->getFasilitasTerdekat($property, $aiService);
                if ($fasilitasTerdekat) {
                    $updateData['fasilitas_terdekat'] = $fasilitasTerdekat;
                    Log::info("AI Fasilitas Terdekat generated untuk property ID {$id_property}");
                }
            }

            // 3. Generate Peta Map (jika belum ada)
            if (empty(trim($property->peta_map ?? ''))) {
                $petaMap = $this->getPetaMap($property, $aiService);
                if ($petaMap) {
                    $updateData['peta_map'] = $petaMap;
                    Log::info("AI Peta Map generated untuk property ID {$id_property}");
                }
            }

            // Update database jika ada data yang di-generate
            if (!empty($updateData)) {
                DB::table('property_db')
                    ->where('id_property', $id_property)
                    ->update($updateData);

                Log::info("AI Insights berhasil disimpan untuk property ID {$id_property}", $updateData);
            }

        } catch (\Exception $e) {
            // Log error tapi jangan stop proses utama
            Log::error("Error generating AI insights untuk property ID {$id_property}: " . $e->getMessage(), [
                'exception' => $e,
                'trace' => $e->getTraceAsString()
            ]);
        }
    }

    /**
     * Get Harga Rata-rata dari AI Waisaka
     */
    protected function getHargaRata($property, WaisakaAiService $aiService)
    {
        try {
            $tipe = $property->tipe ?? 'Jual';
            $kategori = $property->nama_kategori_property ?? 'Properti';

            // Susun alamat lengkap
            $addressParts = array_filter([
                $property->alamat,
                $property->nama_kecamatan,
                $property->nama_kabupaten,
                $property->nama_provinsi
            ]);
            $alamatLengkap = implode(', ', $addressParts);

            if (empty($alamatLengkap)) {
                return null;
            }

            $hargaListing = is_numeric($property->harga ?? null) ? (float) $property->harga : null;
            $luasTanah = is_numeric($property->lt ?? null) ? (int) $property->lt : null;
            $luasBangunan = is_numeric($property->lb ?? null) ? (int) $property->lb : null;

            // Panggil AI Service
            $priceSummary = $aiService->getAveragePriceSummary(
                $tipe,
                $kategori,
                $alamatLengkap,
                $hargaListing,
                $luasTanah,
                $luasBangunan
            );

            if (empty($priceSummary)) {
                return null;
            }

            // Bersihkan hasil
            $cleanPriceSummary = trim(strip_tags($priceSummary));

            // Jangan simpan jika data tidak tersedia
            if (Str::startsWith($cleanPriceSummary, 'Data harga pasar untuk lokasi ini belum tersedia') ||
                Str::startsWith($cleanPriceSummary, 'Data pasar untuk lokasi ini belum tersedia')) {
                return null;
            }

            return $cleanPriceSummary;

        } catch (\Exception $e) {
            Log::error("Error getHargaRata: " . $e->getMessage());
            return null;
        }
    }

    /**
     * Get Fasilitas Terdekat dari AI Waisaka
     */
    protected function getFasilitasTerdekat($property, WaisakaAiService $aiService)
    {
        try {
            // Susun alamat lengkap
            $addressParts = array_filter([
                $property->alamat,
                $property->nama_kecamatan,
                $property->nama_kabupaten,
                $property->nama_provinsi
            ]);
            $alamatLengkap = implode(', ', $addressParts);

            if (empty($alamatLengkap)) {
                return null;
            }

            // Panggil AI Service
            $summary = $aiService->getNearbyFacilitiesSummary($alamatLengkap);

            if (empty($summary)) {
                return null;
            }

            // Format to HTML list jika belum HTML
            if (stripos($summary, '<ul') === false) {
                $lines = array_filter(array_map('trim', preg_split('/\r\n|\r|\n/', strip_tags($summary))));
                if (!empty($lines)) {
                    $items = array_map(fn($line) => '<li>' . htmlspecialchars($line) . '</li>', $lines);
                    $summary = "<ul>" . implode('', $items) . "</ul>";
                }
            }

            // Jangan simpan jika data tidak tersedia
            if (stripos($summary, 'Data fasilitas untuk area ini sedang tidak tersedia') !== false ||
                stripos($summary, 'tidak tersedia') !== false) {
                return null;
            }

            return $summary;

        } catch (\Exception $e) {
            Log::error("Error getFasilitasTerdekat: " . $e->getMessage());
            return null;
        }
    }

    /**
     * Get Peta Map (koordinat) dari AI Waisaka
     */
    protected function getPetaMap($property, WaisakaAiService $aiService)
    {
        try {
            $address = $property->alamat ?? '';
            $kecamatan = $property->nama_kecamatan ?? null;
            $kabupaten = $property->nama_kabupaten ?? null;
            $provinsi = $property->nama_provinsi ?? null;

            if (empty($address)) {
                return null;
            }

            // Panggil AI Service untuk mendapatkan koordinat
            $coordinates = $aiService->getMapCoordinateSummary($address, $kecamatan, $kabupaten, $provinsi);

            if (!$coordinates || !isset($coordinates['latitude'], $coordinates['longitude'])) {
                return null;
            }

            // Format sebagai JSON string untuk disimpan di database
            return json_encode([
                'latitude' => $coordinates['latitude'],
                'longitude' => $coordinates['longitude'],
                'maps_query' => $coordinates['maps_query'] ?? ''
            ]);

        } catch (\Exception $e) {
            Log::error("Error getPetaMap: " . $e->getMessage());
            return null;
        }
    }
}

=== END OF FILE: Http\Controllers\Admin\Property.php ===


=== START OF FILE: Http\Controllers\Admin\Proyek.php ===
<?php

namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Image;
use App\Models\Proyek as ProyekModel;
use App\Models\Staff as StaffModel;

class Proyek extends Controller
{
    // Main page
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	$myproyek 	        = new ProyekModel();
		$proyek 			= $myproyek->semua();
        $tipe               = 'all';

		$data = array(  'title'				=> 'Data Proyek',
						'proyek'		    => $proyek,
                        'tipe'              => $tipe,
                        'content'			=> 'admin/proyek/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Main page
    public function detail($id_proyek)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $myproyek = new ProyekModel();
        $proyek   = $myproyek->detail($id_proyek);
        $images     = DB::table('proyek_img')->where('id_proyek',$proyek->id_proyek)->orderBy('id_proyek_img')->get();

        $gambar = [];
        foreach($images as $key => $img) {
            $gambar[$key] = $img;
        }

        $data = array(  'title'             => $proyek->nama_proyek,
                        'proyek'            => $proyek,
                        'gambar'            => $gambar,
                        'content'           => 'admin/proyek/detail'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Cari
    public function cari(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $myproyek        = new ProyekModel();
        $keywords        = $request->keywords;
        $tipe            = $request->tipe;
        $proyek          = $myproyek->cari($keywords,$tipe);
        $data = array(  'title'             => 'Data proyek',
                        'proyek'            => $proyek,
                        'tipe'              => $tipe,
                        'content'           => 'admin/proyek/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Proses
    public function proses(Request $request)
    {
        $site = DB::table('konfigurasi')->first();
        // PROSES HAPUS MULTIPLE
        if(isset($_POST['hapus'])) {
            $id_proyek = $request->id_proyek;
            for($i=0; $i < sizeof($id_proyek);$i++) {
                DB::table('proyek')->where('id_proyek',$id_proyek[$i])->delete();
            }
            return redirect('admin/proyek')->with(['sukses' => 'Data telah dihapus']);
        // PROSES SETTING DRAFT
        }elseif(isset($_POST['update'])) {
            $id_proyek = $request->id_proyek;
            for($i=0; $i < sizeof($id_proyek);$i++) {
                DB::table('proyek')->where('id_proyek',$id_proyek[$i])->update([
                        'id_proyek'          => Session()->get('id_proyek'),
                        'id_kategori_proyek' => $request->id_kategori_proyek
                    ]);
            }
            return redirect('admin/proyek')->with(['sukses' => 'Data kategori telah diubah']);
        }
    }

    //Kategori
    public function kategori($id_kategori_proyek)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $myproyek        = new ProyekModel();
        $proyek          = $myproyek->all_kategori_proyek($id_kategori_proyek);
        $tipe              = 'all';
        $kategori_proyek = DB::table('kategori_proyek')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Data proyek',
                        'proyek'          => $proyek,
                        'tipe'              => $tipe,
                        'kategori_proyek' => $kategori_proyek,
                        'content'           => 'admin/proyek/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Tambah
    public function tambah()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $provinsi = DB::table('provinsi')->orderBy('nama','ASC')->get();

        $data = array(  'title'             => 'Tambah proyek',
                        'provinsi'          => $provinsi,
                        'content'           => 'admin/proyek/tambah'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // edit
    public function edit($id_proyek)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $myproyek        = new ProyekModel();
        $proyek          = $myproyek->detail($id_proyek);
        $images     = DB::table('proyek_img')->where('id_proyek',$proyek->id_proyek)->orderBy('id_proyek_img')->get();
        $provinsi   = DB::table('provinsi')->orderBy('nama','ASC')->get();
        $kabupaten  = DB::table('kabupaten')->where('id_provinsi',$proyek->id_provinsi)->orderBy('nama','ASC')->get();
        $kecamatan  = DB::table('kecamatan')->where('id_kabupaten',$proyek->id_kabupaten)->orderBy('nama','ASC')->get();

        $gambar = [];
        foreach($images as $key => $img) {
            $gambar[$key] = $img;
        }

        for($i=0;$i<10;$i++) {
            $gambar_v[$i] = isset($gambar[$i]) ? $gambar[$i]->gambar : ''; 
        }

        $data = array(  'title'             => 'Edit proyek',
                        'proyek'            => $proyek,
                        'provinsi'          => $provinsi,
                        'kabupaten'         => $kabupaten,
                        'kecamatan'         => $kecamatan,
                        'gambar'            => $gambar_v,
                        'content'           => 'admin/proyek/edit'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                    'kode'          => 'required|unique:proyek',
                    'nama_proyek'   => 'required|unique:proyek',
                    'lt'            => 'required|numeric',
                    'lb'            => 'required|numeric',
                    'lama_pengerjaan' => 'numeric',
                    'id_provinsi'   => 'required',
                    'id_kabupaten'  => 'required',
                    'id_kecamatan'  => 'required',
                    'keywords'      => 'required',
                ]);
        
        $slug_proyek = Str::slug($request->nama_proyek);
        $id_proyek = DB::table('proyek')->insertGetId([
            'kode'                 => $request->kode,
            'slug_proyek'          => $slug_proyek,
            'nama_proyek'          => $request->nama_proyek,
            'tipe'                 => $request->tipe,
            'lama_pengerjaan'      => $request->lama_pengerjaan,
            'lt'                   => $request->lt,
            'lb'                   => $request->lb,
            'isi'                  => $request->isi,
            'alamat'               => $request->alamat,
            'id_provinsi'          => $request->id_provinsi,
            'id_kabupaten'         => $request->id_kabupaten,
            'id_kecamatan'         => $request->id_kecamatan,
            'keywords'             => $request->keywords
        ]);

        // UPLOAD START
        $images = $request->file('gambar');
        foreach($request->gambar as $key => $val) {
            $image = $images[$key]; 
            if(!empty($image)) {
                $filenamewithextension  = $image->getClientOriginalName();
                $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
                $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
                $destinationPath = './assets/upload/proyek/';
                $image->move($destinationPath, $input['nama_file']);
            }

            DB::table('proyek_img')->insert([
                'id_proyek'     => $id_proyek,
                'gambar'        => $input['nama_file'],
                'index_img'     => $key
            ]);
        }
        
        // END UPLOAD

        return redirect('admin/proyek')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                                'kode'          => 'required',
                                'nama_proyek'   => 'required',
                                'lt'            => 'required|numeric',
                                'lb'            => 'required|numeric',
                                'lama_pengerjaan' => 'numeric',
                                'id_provinsi'   => 'required',
                                'id_kabupaten'  => 'required',
                                'id_kecamatan'  => 'required',
                                'keywords'      => 'required',
                            ]);
       
        $slug_proyek = Str::slug($request->nama_proyek);
        DB::table('proyek')->where('id_proyek',$request->id_proyek)->update([
            'kode'                 => $request->kode,
            'slug_proyek'          => $slug_proyek,
            'nama_proyek'          => $request->nama_proyek,
            'tipe'                 => $request->tipe,
            'lama_pengerjaan'      => $request->lama_pengerjaan,
            'lt'                   => $request->lt,
            'lb'                   => $request->lb,
            'isi'                  => $request->isi,
            'alamat'               => $request->alamat,
            'id_provinsi'          => $request->id_provinsi,
            'id_kabupaten'         => $request->id_kabupaten,
            'id_kecamatan'         => $request->id_kecamatan,
            'keywords'             => $request->keywords
        ]);
        
        // UPLOAD START
        $images = $request->file('gambar');
        if($request->gambar) {
            foreach($request->gambar as $key => $val) {
                $image = $images[$key]; 
                if(!empty($image)) {
                    $filenamewithextension  = $image->getClientOriginalName();
                    $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
                    $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
                    $destinationPath = './assets/upload/proyek/';
                    $image->move($destinationPath, $input['nama_file']);
                }

                DB::table('proyek_img')->updateOrInsert([
                    'id_proyek'   => $request->id_proyek,
                    'index_img'     => $key
                ],[
                    'gambar'        => $input['nama_file']
                ]);
            }
        }
        
        // END UPLOAD    

        return redirect('admin/proyek')->with(['sukses' => 'Data telah ditambah']);
    }

    // Delete
    public function delete($id_proyek)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        DB::table('proyek')->where('id_proyek',$id_proyek)->delete();
        DB::table('proyek_img')->where('id_proyek',$id_proyek)->delete();
        return redirect('admin/proyek')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Proyek.php ===


=== START OF FILE: Http\Controllers\Admin\Rekening.php ===
<?php
namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Image;

class Rekening extends Controller
{
    // Index
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
		$rekening 	= DB::table('rekening')->orderBy('urutan','ASC')->get();

		$data = array(  'title'     => 'Data Rekening',
						'rekening'	=> $rekening,
                        'content'           => 'admin/rekening/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Edit
    public function edit($id_rekening)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $rekening   = DB::table('rekening')->where('id_rekening',$id_rekening)->orderBy('urutan','ASC')->first();

        $data = array(  'title'     => 'Edit Data Rekening',
                        'rekening'  => $rekening,
                        'content'   => 'admin/rekening/edit'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Proses
    public function proses(Request $request)
    {
        $site   = DB::table('konfigurasi')->first();
        // PROSES HAPUS MULTIPLE
        if(isset($_POST['hapus'])) {
            $id_rekeningnya       = $request->id_rekening;
            for($i=0; $i < sizeof($id_rekeningnya);$i++) {
                DB::table('rekening')->where('id_rekening',$id_rekeningnya[$i])->delete();
            }
            return redirect('admin/rekening')->with(['sukses' => 'Data telah dihapus']);
        // PROSES SETTING DRAFT
        }
    }

    // tambah
    public function tambah(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'nama_bank' => 'required|unique:rekening',
                            'gambar'    => 'file|image|mimes:jpeg,png,jpg|max:8024',
					        ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            DB::table('rekening')->insert([
                'nama_bank'         => $request->nama_bank,
                'nomor_rekening'    => $request->nomor_rekening,
                'atas_nama'         => $request->atas_nama,
                'urutan'            => $request->urutan,
                'gambar'            => $input['nama_file']
            ]);
        }else{
            DB::table('rekening')->insert([
                'nama_bank'         => $request->nama_bank,
                'nomor_rekening'    => $request->nomor_rekening,
                'atas_nama'         => $request->atas_nama,
                'urutan'            => $request->urutan
            ]);
        }
        return redirect('admin/rekening')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function proses_edit(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					       'nama_bank' => 'required',
                            'gambar'    => 'file|image|mimes:jpeg,png,jpg|max:8024',
					        ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            // UPLOAD START
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            DB::table('rekening')->where('id_rekening',$request->id_rekening)->update([
                'nama_bank'         => $request->nama_bank,
                'nomor_rekening'    => $request->nomor_rekening,
                'atas_nama'         => $request->atas_nama,
                'urutan'            => $request->urutan,
                'gambar'            => $input['nama_file']
            ]);
        }else{
            DB::table('rekening')->where('id_rekening',$request->id_rekening)->update([
                'nama_bank'         => $request->nama_bank,
                'nomor_rekening'    => $request->nomor_rekening,
                'atas_nama'         => $request->atas_nama,
                'urutan'            => $request->urutan,
            ]);
        }
        return redirect('admin/rekening')->with(['sukses' => 'Data telah diupdate']);
    }

    // Delete
    public function delete($id_rekening)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	DB::table('rekening')->where('id_rekening',$id_rekening)->delete();
    	return redirect('admin/rekening')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Rekening.php ===


=== START OF FILE: Http\Controllers\Admin\Staff.php ===
<?php

namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Image;
use App\Models\Staff as StaffModel;

class Staff extends Controller
{
    // Main page
    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	$mystaff 			= new StaffModel();
		$staff 			= $mystaff->semua();
		$kategori_staff 	= DB::table('kategori_staff')->orderBy('urutan','ASC')->get();

		$data = array(  'title'				=> 'Data Staff (Board and Team)',
						'staff'			=> $staff,
						'kategori_staff'	=> $kategori_staff,
                        'content'			=> 'admin/staff/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Main page
    public function detail($id_staff)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mystaff        = new StaffModel();
        $staff          = $mystaff->detail($id_staff);

        $data = array(  'title'             => $staff->nama_staff,
                        'staff'             => $staff,
                        'content'           => 'admin/staff/detail'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Cari
    public function cari(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mystaff           = new StaffModel();
        $keywords           = $request->keywords;
        $staff             = $mystaff->cari($keywords);
        $kategori_staff    = DB::table('kategori_staff')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Data Staff (Board and Team)',
                        'staff'            => $staff,
                        'kategori_staff'   => $kategori_staff,
                        'content'           => 'admin/staff/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Proses
    public function proses(Request $request)
    {
        $site   = DB::table('konfigurasi')->first();
        // PROSES HAPUS MULTIPLE
        if(isset($_POST['hapus'])) {
            $id_staffnya       = $request->id_staff;
            for($i=0; $i < sizeof($id_staffnya);$i++) {
                DB::table('staff')->where('id_staff',$id_staffnya[$i])->delete();
            }
            return redirect('admin/staff')->with(['sukses' => 'Data telah dihapus']);
        // PROSES SETTING DRAFT
        }elseif(isset($_POST['update'])) {
            $id_staffnya       = $request->id_staff;
            for($i=0; $i < sizeof($id_staffnya);$i++) {
                DB::table('staff')->where('id_staff',$id_staffnya[$i])->update([
                        'id_user'               => Session()->get('id_user'),
                        'id_kategori_staff'    => $request->id_kategori_staff
                    ]);
            }
            return redirect('admin/staff')->with(['sukses' => 'Data kategori telah diubah']);
        }
    }

    //Status
    public function status_staff($status_staff)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mystaff           = new StaffModel();
        $staff             = $mystaff->status_staff($status_staff);
        $kategori_staff    = DB::table('kategori_staff')->orderBy('urutan','ASC')->get();

        $data = array(  'title'            => 'Data Staff (Board and Team)',
                        'staff'            => $staff,
                        'kategori_staff'   => $kategori_staff,
                        'content'          => 'admin/staff/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    //Kategori
    public function kategori($id_kategori_staff)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mystaff           = new StaffModel();
        $staff             = $mystaff->all_kategori_staff($id_kategori_staff);
        $kategori_staff    = DB::table('kategori_staff')->orderBy('urutan','ASC')->get();

        $data = array(  'title'             => 'Data Staff (Board and Team)',
                        'staff'            => $staff,
                        'kategori_staff'   => $kategori_staff,
                        'content'           => 'admin/staff/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Tambah
    public function tambah()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $kategori_staff    = DB::table('kategori_staff')->orderBy('urutan','ASC')->get();
        $provinsi = DB::table('provinsi')->orderBy('nama','ASC')->get();

        $data = array(  'title'            => 'Tambah Staff (Board and Team)',
                        'provinsi'         => $provinsi,
                        'kategori_staff'   => $kategori_staff,
                        'content'          => 'admin/staff/tambah'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // edit
    public function edit($id_staff)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $mystaff           = new StaffModel();
        $staff             = $mystaff->detail($id_staff);
        $kategori_staff    = DB::table('kategori_staff')->orderBy('urutan','ASC')->get();
        $provinsi          = DB::table('provinsi')->orderBy('nama','ASC')->get();
        $kabupaten         = DB::table('kabupaten')->where('id_provinsi',$staff->id_provinsi)->orderBy('nama','ASC')->get();
        $kecamatan         = DB::table('kecamatan')->where('id_kabupaten',$staff->id_kabupaten)->orderBy('nama','ASC')->get();

        $data = array(  'title'            => 'Edit Staff (Board and Team)',
                        'provinsi'         => $provinsi,
                        'kabupaten'        => $kabupaten,
                        'kecamatan'        => $kecamatan,
                        'staff'            => $staff,
                        'kategori_staff'   => $kategori_staff,
                        'content'          => 'admin/staff/edit'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // tambah
    public function tambah_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                                'nama_staff'  => 'required|unique:staff',
                                'gambar'      => 'required|file|image|mimes:jpeg,png,jpg|max:8024',
                                'telepon'     => 'required',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/staff/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/staff/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            $slug_staff = Str::slug($request->nama_staff.'-'.$request->jabatan, '-');
            DB::table('staff')->insert([
                'id_user'               => Session()->get('id_user'),
                'id_kategori_staff'     => $request->id_kategori_staff,
                'nickname_staff'        => $request->nickname_staff,
                'nama_staff'            => $request->nama_staff,
                'slug_staff'            => $slug_staff,
                'jabatan'               => $request->jabatan,
                'pendidikan'            => $request->pendidikan,
                'expertise'             => $request->expertise,
                'email'                 => $request->email,
                'telepon'               => $request->telepon,
                'id_provinsi'           => $request->id_provinsi,
                'id_kabupaten'          => $request->id_kabupaten,
                'id_kecamatan'          => $request->id_kecamatan,
                'isi'                   => $request->isi,
                'gambar'                => $input['nama_file'],
                'status_staff'          => $request->status_staff,
                'keywords'              => $request->keywords,
                'urutan'                => $request->urutan
            ]);
        }else{
            $slug_staff = Str::slug($request->nama_staff.'-'.$request->jabatan, '-'); 
            DB::table('staff')->insert([
                'id_user'               => Session()->get('id_user'),
                'id_kategori_staff'     => $request->id_kategori_staff,
                'nickname_staff'        => $request->nickname_staff,
                'nama_staff'            => $request->nama_staff,
                'slug_staff'            => $slug_staff,
                'jabatan'               => $request->jabatan,
                'pendidikan'            => $request->pendidikan,
                'expertise'             => $request->expertise,
                'email'                 => $request->email,
                'telepon'               => $request->telepon,
                'id_provinsi'           => $request->id_provinsi,
                'id_kabupaten'          => $request->id_kabupaten,
                'id_kecamatan'          => $request->id_kecamatan,
                'isi'                   => $request->isi,
                'status_staff'          => $request->status_staff,
                'keywords'              => $request->keywords,
                'urutan'                => $request->urutan
            ]);
        }
        return redirect('admin/staff')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function edit_proses(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'nama_staff'  => 'required',
                            'gambar'        => 'file|image|mimes:jpeg,png,jpg|max:8024',
                            'telepon'     => 'required',
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/staff/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/staff/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            $slug_staff = Str::slug($request->nama_staff.'-'.$request->jabatan, '-');
            DB::table('staff')->where('id_staff',$request->id_staff)->update([
                'id_user'               => Session()->get('id_user'),
                'id_kategori_staff'     => $request->id_kategori_staff,
                'nickname_staff'        => $request->nickname_staff,
                'nama_staff'            => $request->nama_staff,
                'slug_staff'            => $slug_staff,
                'jabatan'               => $request->jabatan,
                'pendidikan'            => $request->pendidikan,
                'expertise'             => $request->expertise,
                'email'                 => $request->email,
                'telepon'               => $request->telepon,
                'isi'                   => $request->isi,
                'id_provinsi'           => $request->id_provinsi,
                'id_kabupaten'          => $request->id_kabupaten,
                'id_kecamatan'          => $request->id_kecamatan,
                'gambar'                => $input['nama_file'],
                'status_staff'          => $request->status_staff,
                'keywords'              => $request->keywords,
                'urutan'                => $request->urutan
            ]);
        }else{
            $slug_staff = Str::slug($request->nama_staff.'-'.$request->jabatan, '-');
            DB::table('staff')->where('id_staff',$request->id_staff)->update([
                'id_user'               => Session()->get('id_user'),
                'id_kategori_staff'     => $request->id_kategori_staff,
                'nickname_staff'        => $request->nickname_staff,
                'nama_staff'            => $request->nama_staff,
                'slug_staff'            => $slug_staff,
                'jabatan'               => $request->jabatan,
                'pendidikan'            => $request->pendidikan,
                'expertise'             => $request->expertise,
                'email'                 => $request->email,
                'telepon'               => $request->telepon,
                'isi'                   => $request->isi,
                'id_provinsi'           => $request->id_provinsi,
                'id_kabupaten'          => $request->id_kabupaten,
                'id_kecamatan'          => $request->id_kecamatan,
                // 'gambar'                => $input['nama_file'],
                'status_staff'          => $request->status_staff,
                'keywords'              => $request->keywords,
                'urutan'                => $request->urutan
            ]);
        }
        return redirect('admin/staff')->with(['sukses' => 'Data telah ditambah']);
    }

    // Delete
    public function delete($id_staff)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $property = DB::table('property_db')->where('id_staff',$id_staff)->get();
        if(COUNT($property)) {
            $str = [];
            foreach($property as $p) {
                $str[] = $p->kode;
            }
            $str = implode(", ",$str);
            return redirect('admin/staff')->withErrors(['msg' => 'Masih terdapat listing atas nama agen ini dengan kode '.$str]);
        }
        DB::table('staff')->where('id_staff',$id_staff)->delete();
        return redirect('admin/staff')->with(['sukses' => 'Data telah dihapus']);
    }


    // --- FUNGSI BARU UNTUK MENAMPILKAN HALAMAN PROFIL SAYA ---
    public function profilMember()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        
        $id_user = Session()->get('id_user');
        $staff = DB::table('staff')->where('id_user', $id_user)->first();

        $data = array(  'title'     => 'Lengkapi Profil Member Anda',
                        'staff'     => $staff,
                        'content'   => 'admin/staff/profil_member' // Path ke view baru
                    );
        return view('admin/layout/wrapper',$data);
    }

    // --- FUNGSI BARU UNTUK MEMPROSES UPDATE PROFIL SAYA ---
    public function updateProfilMember(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        
        request()->validate([
            'nama_staff'  => 'required',
            'telepon'     => 'required',
            'email'       => 'required|email',
        ]);

        $id_staff = Session()->get('id_staff');
        DB::table('staff')->where('id_staff', $id_staff)->update([
            'nama_staff' => $request->nama_staff,
            'telepon'    => $request->telepon,
            'email'      => $request->email,
            // Anda bisa tambahkan field lain di sini jika perlu
        ]);
        
        return redirect('admin/staff/profil-member')->with(['sukses' => 'Profil Anda berhasil diperbarui.']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Staff.php ===


=== START OF FILE: Http\Controllers\Admin\Transaksi.php ===
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Session;

class Transaksi extends Controller
{
    /**
     * Menampilkan daftar semua transaksi paket iklan.
     */
    public function index()
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}

        // Ambil transaksi pending untuk tabel pending
        $transaksi_pending = DB::table('transaksi_paket')
            ->join('users', 'transaksi_paket.id_user', '=', 'users.id_user')
            ->join('paket_iklan', 'transaksi_paket.paket_id', '=', 'paket_iklan.id')
            ->select(
                'transaksi_paket.*', 
                'users.nama as nama_user', 
                'users.email as email_user',
                'paket_iklan.nama_paket',
                'paket_iklan.harga',
                'paket_iklan.kuota_iklan'
            )
            ->where('transaksi_paket.status_pembayaran', 'pending')
            ->orderBy('transaksi_paket.created_at', 'asc')
            ->get();

        // Ambil transaksi yang sudah dikonfirmasi atau direject (tidak termasuk pending)
        // Urutkan berdasarkan status: confirmed dulu, lalu rejected, lalu created_at desc
        $transaksi_all = DB::table('transaksi_paket')
            ->join('users', 'transaksi_paket.id_user', '=', 'users.id_user')
            ->join('paket_iklan', 'transaksi_paket.paket_id', '=', 'paket_iklan.id')
            ->leftJoin('users as admin', 'transaksi_paket.dikonfirmasi_oleh', '=', 'admin.id_user')
            ->select(
                'transaksi_paket.*', 
                'users.nama as nama_user', 
                'users.email as email_user',
                'paket_iklan.nama_paket',
                'paket_iklan.harga',
                'paket_iklan.kuota_iklan',
                'admin.nama as nama_admin'
            )
            ->whereIn('transaksi_paket.status_pembayaran', ['confirmed', 'rejected'])
            ->orderByRaw("
                CASE 
                    WHEN transaksi_paket.status_pembayaran = 'confirmed' THEN 1
                    WHEN transaksi_paket.status_pembayaran = 'rejected' THEN 2
                    ELSE 3
                END
            ")
            ->orderBy('transaksi_paket.created_at', 'desc')
            ->paginate(15);

        // Hitung statistik
        $stats = [
            'pending' => DB::table('transaksi_paket')->where('status_pembayaran', 'pending')->count(),
            'confirmed' => DB::table('transaksi_paket')->where('status_pembayaran', 'confirmed')->count(),
            'rejected' => DB::table('transaksi_paket')->where('status_pembayaran', 'rejected')->count(),
            'total' => DB::table('transaksi_paket')->count()
        ];

        $data = [
            'title'             => 'Manajemen Transaksi Paket Iklan',
            'transaksi_pending' => $transaksi_pending,
            'transaksi_all'     => $transaksi_all,
            'stats'             => $stats,
            'content'           => 'admin/transaksi/index'
        ];
        return view('admin/layout/wrapper', $data);
    }

    /**
     * Mengkonfirmasi pembayaran dan menambah kuota user.
     */
    public function confirm($id)
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}

        $transaksi = DB::table('transaksi_paket')->where('id', $id)->first();
        if(!$transaksi) {
            return redirect('admin/transaksi')->with(['warning' => 'Data transaksi tidak ditemukan.']);
        }

        $paket = DB::table('paket_iklan')->where('id', $transaksi->paket_id)->first();
        if(!$paket) {
            return redirect('admin/transaksi')->with(['warning' => 'Data paket iklan tidak ditemukan.']);
        }

        $staff = DB::table('staff')->where('id_user', $transaksi->id_user)->first();
        if(!$staff) {
            return redirect('admin/transaksi')->with(['warning' => 'Profil staff untuk user ini tidak ditemukan. Pastikan user telah verifikasi email.']);
        }

        // --- LOGIKA KONFIRMASI PEMBELIAN PAKET IKLAN ---
        
        // 1. Dapatkan urutan terakhir dan tentukan urutan baru
        $lastOrder = DB::table('staff')->max('urutan');
        $newOrder = $lastOrder + 1;

        // 2. Hitung kuota baru
        $newTotalKuota = $staff->total_kuota_iklan + $paket->kuota_iklan;
        $newSisaKuota = $staff->sisa_kuota_iklan + $paket->kuota_iklan;

        // 3. Update tabel staff: status selalu "Ya" saat konfirmasi, urutan, kuota, dan id_transaksi
        DB::table('staff')->where('id_staff', $staff->id_staff)->update([
            'status_staff'      => 'Ya', // Selalu set "Ya" saat konfirmasi pembelian
            'urutan'            => $newOrder,
            'total_kuota_iklan' => $newTotalKuota,
            'sisa_kuota_iklan'  => $newSisaKuota,
            'id_transaksi'      => $id  // Update id_transaksi dengan ID transaksi terakhir
        ]);

        // 5. Update paket_id di tabel users
        DB::table('users')->where('id_user', $transaksi->id_user)->update([
            'paket_id' => $transaksi->paket_id
        ]);

        // 6. Update status transaksi menjadi 'confirmed'
        DB::table('transaksi_paket')->where('id', $id)->update([
            'status_pembayaran' => 'confirmed',
            'dikonfirmasi_oleh' => Session::get('id_user'),
            'tanggal_konfirmasi' => now()
        ]);

        // 7. Log aktivitas
        \Log::info('Paket iklan dikonfirmasi', [
            'transaksi_id' => $id,
            'id_user' => $transaksi->id_user,
            'staff_id' => $staff->id_staff,
            'paket_id' => $transaksi->paket_id,
            'kuota_tambahan' => $paket->kuota_iklan,
            'total_kuota_baru' => $newTotalKuota,
            'sisa_kuota_baru' => $newSisaKuota,
            'status_staff_baru' => 'Ya',
            'admin_id' => Session::get('id_user')
        ]);

        $message = 'Transaksi berhasil dikonfirmasi. ';
        $message .= 'Profil staff telah diaktifkan, kuota diperbarui (+' . $paket->kuota_iklan . '), ';
        $message .= 'dan paket_id telah disimpan ke data user. ';
        $message .= 'Status staff: Ya (Sisa kuota: ' . $newSisaKuota . ')';

        return redirect('admin/transaksi')->with(['sukses' => $message]);
    }

    /**
     * Menolak pembayaran.
     */
    public function reject($id)
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}

        DB::table('transaksi_paket')->where('id', $id)->update([
            'status_pembayaran' => 'rejected',
            'dikonfirmasi_oleh' => Session::get('id_user'),
            'tanggal_konfirmasi' => now()
        ]);

        return redirect('admin/transaksi')->with(['sukses' => 'Transaksi telah ditolak.']);
    }

    /**
     * Menandai pembayaran sebagai tidak terverifikasi.
     */
    public function unverify($id)
    {
        if(Session::get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}

        DB::table('transaksi_paket')->where('id', $id)->update([
            'status_pembayaran' => 'unverified',
            'dikonfirmasi_oleh' => Session::get('id_user'),
            'tanggal_konfirmasi' => now()
        ]);

        return redirect('admin/transaksi')->with(['sukses' => 'Transaksi telah ditandai sebagai tidak terverifikasi.']);
    }

    /**
     * Update status staff berdasarkan sisa kuota iklan.
     * Dipanggil ketika ada perubahan kuota iklan (misalnya setelah iklan dibuat).
     */
    public static function updateStaffStatusByQuota($userId)
    {
        $staff = DB::table('staff')->where('id_user', $userId)->first();
        
        if (!$staff) {
            return false;
        }

        $sisaKuota = $staff->sisa_kuota_iklan;
        $statusStaff = ($sisaKuota > 0) ? 'Ya' : 'Tidak';

        // Update status staff jika berubah
        if ($staff->status_staff !== $statusStaff) {
            DB::table('staff')->where('id_user', $userId)->update([
                'status_staff' => $statusStaff
            ]);

            \Log::info('Status staff diupdate berdasarkan kuota', [
                'id_user' => $userId,
                'staff_id' => $staff->id_staff,
                'sisa_kuota_iklan' => $sisaKuota,
                'status_lama' => $staff->status_staff,
                'status_baru' => $statusStaff
            ]);

            return true;
        }

        return false;
    }

    /**
     * Update status staff untuk semua staff berdasarkan kuota mereka.
     * Fungsi ini bisa dipanggil dari cron job atau admin panel.
     */
    public static function updateAllStaffStatusByQuota()
    {
        $staffList = DB::table('staff')
            ->where('status_staff', 'Ya')
            ->where('sisa_kuota_iklan', '<=', 0)
            ->get();

        $updatedCount = 0;

        foreach ($staffList as $staff) {
            DB::table('staff')->where('id_staff', $staff->id_staff)->update([
                'status_staff' => 'Tidak'
            ]);

            \Log::info('Status staff diupdate ke Tidak (kuota habis)', [
                'id_user' => $staff->id_user,
                'staff_id' => $staff->id_staff,
                'sisa_kuota_iklan' => $staff->sisa_kuota_iklan
            ]);

            $updatedCount++;
        }

        return $updatedCount;
    }
}

=== END OF FILE: Http\Controllers\Admin\Transaksi.php ===


=== START OF FILE: Http\Controllers\Admin\User.php ===
<?php
namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
// use Intervention\Image\Facades\Image; // Package tidak tersedia
use Carbon\Carbon;
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Facades\File;

class User extends Controller
{

    public function index()
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
		$user 	= DB::table('users')->orderBy('id_user','DESC')->get();

		$data = array(  'title'     => 'Pengguna Website',
						'user'      => $user,
                        'content'   => 'admin/user/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    
    public function edit($id_user)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $user   = DB::table('users')->where('id_user',$id_user)->orderBy('id_user','DESC')->first();

        $data = array(  'title'     => 'Edit Pengguna Website',
                        'user'      => $user,
                        'content'   => 'admin/user/edit'
                    );
        return view('admin/layout/wrapper',$data);
    }

   public function proses(Request $request)
    {
        $site   = DB::table('konfigurasi')->first();
        
        if(isset($_POST['hapus'])) {
            $id_usernya       = $request->id_user;
            for($i=0; $i < sizeof($id_usernya);$i++) {
                $this->_deleteUserData($id_usernya[$i]);
            }
            return redirect('admin/user')->with(['sukses' => 'Data telah dihapus']);
        }
    }


    public function tambah(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
                            'nama'     => 'required',
					        'username' => 'required|unique:users',
					        'password' => 'required',
                            'email'    => 'required',
                            'gambar'   => 'file|image|mimes:jpeg,png,jpg|max:8024',
					        ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            
            // Upload gambar asli
            $destinationPath = './assets/upload/user/';
            $image->move($destinationPath, $input['nama_file']);
            
            // Buat thumbnail menggunakan GD library
            try {
                $this->createThumbnail($destinationPath . $input['nama_file'], './assets/upload/user/thumbs/' . $input['nama_file'], 150, 150);
            } catch (\Exception $e) {
                // Log error but continue with user creation
                \Log::warning('Failed to create thumbnail: ' . $e->getMessage());
            }
            // END UPLOAD
            DB::table('users')->insert([
                'nama'          => $request->nama,
                'email'	        => $request->email,
                'username'   	=> $request->username,
                'password'      => sha1($request->password),
                'akses_level'   => $request->akses_level,
                'gambar'        => $input['nama_file']
            ]);
        }else{
             DB::table('users')->insert([
                'nama'          => $request->nama,
                'email'         => $request->email,
                'username'      => $request->username,
                'password'      => sha1($request->password),
                'akses_level'   => $request->akses_level
            ]);
        }
        return redirect('admin/user')->with(['sukses' => 'Data telah ditambah']);
    }

    // edit
    public function proses_edit(Request $request)
    {
    	if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
    	request()->validate([
					        'nama'     => 'required',
                            'username' => 'required',
                            'password' => 'required|min:6', // Password wajib diisi, minimal 6 karakter
                            'email'    => 'required',
                            'gambar'   => 'file|image|mimes:jpeg,png,jpg|max:8024',
					        ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            // UPLOAD START
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            
            // Upload gambar asli
            $destinationPath = './assets/upload/user/';
            $image->move($destinationPath, $input['nama_file']);
            
            // Buat thumbnail menggunakan GD library
            $this->createThumbnail($destinationPath . $input['nama_file'], './assets/upload/user/thumbs/' . $input['nama_file'], 150, 150);
            // END UPLOAD
            $slug_user = Str::slug($request->nama, '-');
            
            // Update data user dengan gambar
            DB::table('users')->where('id_user',$request->id_user)->update([
                'nama'          => $request->nama,
                'email'         => $request->email,
                'username'      => $request->username,
                'password'      => sha1($request->password),
                'akses_level'   => $request->akses_level,
                'gambar'        => $input['nama_file']
            ]);
        }else{
            $slug_user = Str::slug($request->nama, '-');
            
            // Update data user tanpa gambar
            DB::table('users')->where('id_user',$request->id_user)->update([
                'nama'          => $request->nama,
                'email'         => $request->email,
                'username'      => $request->username,
                'password'      => sha1($request->password),
                'akses_level'   => $request->akses_level
            ]);
        }
        return redirect('admin/user')->with(['sukses' => 'Data telah diupdate']);
    }


     // --- FUNGSI BARU UNTUK MENAMPILKAN HALAMAN SIGN UP ---
    public function signup()
    {
        // Cukup tampilkan halaman view untuk pendaftaran
        return view('admin/user/signup');
    }


    // --- FUNGSI PROSES SIGN UP DIPERBARUI ---
    public function proses_signup(Request $request)
    {
    	request()->validate([
            'nama'     => 'required',
            'username' => 'required|unique:users,username|unique:users_verification,username',
            'password' => 'required|min:6',
            'email'    => 'required|email|unique:users,email|unique:users_verification,email',
            'gambar'   => 'nullable|file|image|mimes:jpeg,png,jpg|max:2048',
        ]);

        $token = Str::random(60); // Buat token verifikasi acak

        // Siapkan data untuk disimpan di tabel verifikasi
        $data = [
            'nama'          => $request->nama,
            'email'	        => $request->email,
            'username'   	=> $request->username,
            'password'      => sha1($request->password),
            'token'         => $token,
            'tanggal_expired' => Carbon::now()->addDays(3), // Set expired 3 hari dari sekarang
            'created_at'    => now(),
            'updated_at'    => now()
        ];

        // Proses upload gambar jika ada
        $image = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/user/';
            $image->move($destinationPath, $input['nama_file']);
            $data['gambar'] = $input['nama_file'];
        }

        // Simpan data ke tabel users_verification
        DB::table('users_verification')->insert($data);

        // Kirim email verifikasi menggunakan Mailable class
        try {
            $user = new \stdClass();
            $user->nama = $request->nama;
            $user->email = $request->email;
            
            Mail::to($request->email)->send(new \App\Mail\VerificationEmail($user, $token));
        } catch (\Exception $e) {
            \Log::error('Email verification failed to send: '.$e->getMessage());
        }

        return redirect('login')->with(['sukses' => 'Pendaftaran berhasil. Silakan cek email Anda untuk link aktivasi yang berlaku selama 3 hari.']);
    }

    // --- FUNGSI BARU UNTUK MENANGANI VERIFIKASI ---
    public function verifyEmail(Request $request)
    {
        $token = $request->get('token');
        $verification_data = DB::table('users_verification')->where('token', $token)->first();

        // Cek jika token tidak ada
        if(!$verification_data) {
            return redirect('login')->with(['warning' => 'Token verifikasi tidak valid.']);
        }

        // Cek jika token sudah expired
        if(Carbon::now()->gt($verification_data->tanggal_expired)) {
            // Hapus data yang sudah expired
            DB::table('users_verification')->where('token', $token)->delete();
            return redirect('login')->with(['warning' => 'Waktu pendaftaran Anda sudah berakhir (expired). Silakan daftar kembali.']);
        }

        // Jika valid, pindahkan data ke tabel users dan dapatkan ID-nya
        $newUserId = DB::table('users')->insertGetId([
            'nama'          => $verification_data->nama,
            'email'         => $verification_data->email,
            'username'      => $verification_data->username,
            'password'      => $verification_data->password,
            'gambar'        => $verification_data->gambar,
            'akses_level'   => 'User'
        ]);

        // Ambil urutan terakhir dari tabel staff
        $lastUrutan = DB::table('staff')->max('urutan') ?? 0;
        $newUrutan = $lastUrutan + 1;

        // Buat entri staff baru untuk user ini dan dapatkan ID-nya
        $newStaffId = DB::table('staff')->insertGetId([
            'id_user'           => $newUserId,
            'nama_staff'        => $verification_data->nama,
            'email'             => $verification_data->email,
            'status_staff'      => 'Tidak', // "Tidak" berarti belum dikonfirmasi oleh admin
            'slug_staff'        => Str::slug($verification_data->nama, '-'),
            'id_kategori_staff' => 1, // Asumsi default kategori staff adalah 1 (misal: "Agent Baru")
            'nickname_staff'    => $verification_data->nama, // Gunakan nama sebagai nickname default
            'id_provinsi'       => 1, // Default provinsi (bisa disesuaikan)
            'id_kabupaten'      => 1, // Default kabupaten (bisa disesuaikan)
            'id_kecamatan'      => 1, // Default kecamatan (bisa disesuaikan)
            'total_kuota_iklan' => 0,
            'sisa_kuota_iklan'  => 0,
            'urutan'            => $newUrutan // Set urutan sebagai yang terakhir
        ]);

        // Ambil data paket yang dibeli
        $paket = DB::table('paket_iklan')->where('id', $verification_data->paket_id)->first();

        // Buat entri transaksi untuk pembelian paket
        if ($paket) {
            DB::table('transaksi_paket')->insert([
                'id_user'           => $newUserId,
                'id_staff'          => $newStaffId,
                'paket_id'          => $verification_data->paket_id,
                'kode_transaksi'    => 'WPM-' . strtoupper(Str::random(8)),
                'status_pembayaran' => 'pending', // Menunggu konfirmasi admin
                'bukti_pembayaran'  => $verification_data->gambar, // Path dari kolom gambar
                'keterangan'        => 'Pembelian paket ' . $paket->nama_paket . ' saat registrasi', //  ADDED: Required field
                'created_at'        => now(),
                'updated_at'        => now()
            ]);
        }

        // Hapus data dari tabel verifikasi
        DB::table('users_verification')->where('token', $token)->delete();

        // Redirect ke halaman website utama dengan pesan sukses yang informatif
        return redirect('/')->with(['sukses' => 'Verifikasi berhasil! Akun Anda sudah aktif. Silakan login untuk melihat status konfirmasi pembelian paket Anda.']);
    }

    // Delete (FUNGSI YANG DIPERBAIKI)
    public function delete($id_user)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        
        $this->_deleteUserData($id_user);

    	return redirect('admin/user')->with(['sukses' => 'Data pengguna beserta semua data terkait telah berhasil dihapus.']);
    }

    // FUNGSI PRIVATE UNTUK LOGIKA PENGHAPUSAN
    private function _deleteUserData($id_user)
    {
        // 1. Ambil data user & staff
        $user = DB::table('users')->where('id_user', $id_user)->first();
        if (!$user) {
            return; // Jika user tidak ada, hentikan proses
        }
        $staff = DB::table('staff')->where('id_user', $id_user)->first();

        // 2. Hapus data properti dan gambar properti (jika user adalah staff)
        if ($staff) {
            $properties = DB::table('property_db')->where('id_staff', $staff->id_staff)->get();
            foreach ($properties as $property) {
                $propertyImages = DB::table('property_img')->where('id_property', $property->id_property)->get();
                foreach ($propertyImages as $image) {
                    File::delete(public_path('assets/upload/property/' . $image->gambar));
                }
                DB::table('property_img')->where('id_property', $property->id_property)->delete();
            }
            DB::table('property_db')->where('id_staff', $staff->id_staff)->delete();
            
            // Hapus foto staff
            File::delete(public_path('assets/upload/staff/' . $staff->gambar));
            File::delete(public_path('assets/upload/staff/thumbs/' . $staff->gambar));
        }

        // 3. Hapus data transaksi dan bukti pembayaran
        $transactions = DB::table('transaksi_paket')->where('id_user', $id_user)->get();
        foreach ($transactions as $transaction) {
            File::delete(public_path('assets/upload/bukti/' . $transaction->bukti_pembayaran));
        }
        DB::table('transaksi_paket')->where('id_user', $id_user)->delete();

        // 4. Hapus foto profil user
        File::delete(public_path('assets/upload/user/' . $user->gambar));
        File::delete(public_path('assets/upload/user/thumbs/' . $user->gambar));

        // 5. Hapus data dari tabel staff dan users
        DB::table('staff')->where('id_user', $id_user)->delete();
        DB::table('users')->where('id_user', $id_user)->delete();
    }

    /**
     * Membuat thumbnail menggunakan GD library
     */
    private function createThumbnail($sourcePath, $destinationPath, $width, $height)
    {
        try {
            // Pastikan folder tujuan ada
            $destinationDir = dirname($destinationPath);
            if (!file_exists($destinationDir)) {
                mkdir($destinationDir, 0755, true);
            }

            // Dapatkan informasi gambar
            $imageInfo = getimagesize($sourcePath);
            if (!$imageInfo) {
                return false;
            }
        } catch (\Exception $e) {
            \Log::warning('Failed to create thumbnail directory or get image info: ' . $e->getMessage());
            return false;
        }

        try {
            $sourceWidth = $imageInfo[0];
            $sourceHeight = $imageInfo[1];
            $mimeType = $imageInfo['mime'];

            // Buat resource gambar berdasarkan tipe
            switch ($mimeType) {
                case 'image/jpeg':
                    $sourceImage = imagecreatefromjpeg($sourcePath);
                    break;
                case 'image/png':
                    $sourceImage = imagecreatefrompng($sourcePath);
                    break;
                case 'image/gif':
                    $sourceImage = imagecreatefromgif($sourcePath);
                    break;
                default:
                    return false;
            }

            if (!$sourceImage) {
                return false;
            }
        } catch (\Exception $e) {
            \Log::warning('Failed to create image resource: ' . $e->getMessage());
            return false;
        }

        try {
            // Hitung rasio untuk resize proporsional
            $ratio = min($width / $sourceWidth, $height / $sourceHeight);
            $newWidth = (int)($sourceWidth * $ratio);
            $newHeight = (int)($sourceHeight * $ratio);

            // Buat gambar baru
            $thumbnail = imagecreatetruecolor($newWidth, $newHeight);

            // Preserve transparency untuk PNG
            if ($mimeType == 'image/png') {
                imagealphablending($thumbnail, false);
                imagesavealpha($thumbnail, true);
                $transparent = imagecolorallocatealpha($thumbnail, 255, 255, 255, 127);
                imagefilledrectangle($thumbnail, 0, 0, $newWidth, $newHeight, $transparent);
            }

            // Resize gambar
            imagecopyresampled($thumbnail, $sourceImage, 0, 0, 0, 0, $newWidth, $newHeight, $sourceWidth, $sourceHeight);

            // Simpan thumbnail
            $result = false;
            switch ($mimeType) {
                case 'image/jpeg':
                    $result = imagejpeg($thumbnail, $destinationPath, 90);
                    break;
                case 'image/png':
                    $result = imagepng($thumbnail, $destinationPath, 9);
                    break;
                case 'image/gif':
                    $result = imagegif($thumbnail, $destinationPath);
                    break;
            }

            // Bersihkan memory
            imagedestroy($sourceImage);
            imagedestroy($thumbnail);

            return $result;
        } catch (\Exception $e) {
            \Log::warning('Failed to process thumbnail: ' . $e->getMessage());
            return false;
        }
    }
}

=== END OF FILE: Http\Controllers\Admin\User.php ===


=== START OF FILE: Http\Controllers\Admin\Video.php ===
<?php
namespace App\Http\Controllers\Admin;
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Image;

class Video extends Controller
{
    // Index
    public function index()
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $video   = DB::table('video')->orderBy('id_video','DESC')->get();

        $data = array(  'title'     => 'Data Video',
                        'video'  => $video,
                        'content'   => 'admin/video/index'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Edit
    public function edit($id_video)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        $video   = DB::table('video')->where('id_video',$id_video)->orderBy('urutan','ASC')->first();

        $data = array(  'title'     => 'Edit Data Video',
                        'video'     => $video,
                        'content'   => 'admin/video/edit'
                    );
        return view('admin/layout/wrapper',$data);
    }

    // Proses
    public function proses(Request $request)
    {
        $site   = DB::table('konfigurasi')->first();
        // PROSES HAPUS MULTIPLE
        if(isset($_POST['hapus'])) {
            $id_videonya       = $request->id_video;
            for($i=0; $i < sizeof($id_videonya);$i++) {
                DB::table('video')->where('id_video',$id_videonya[$i])->delete();
            }
            return redirect('admin/video')->with(['sukses' => 'Data telah dihapus']);
        // PROSES SETTING DRAFT
        }
    }

    // tambah
    public function tambah(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                            'judul'     => 'required|unique:video',
                            'video'     => 'required|unique:video',
                            'gambar'    => 'file|image|mimes:jpeg,png,jpg|max:8024'
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            // UPLOAD START       
            DB::table('video')->insert([
                'judul'         => $request->judul,
                'posisi'        => $request->posisi,
                'keterangan'    => $request->keterangan,
                'video'         => $request->video,
                'urutan'        => $request->urutan,
                'id_user'       => Session()->get('id_user'),
                'bahasa'        => $request->bahasa
            ]);
            return redirect('admin/video')->with(['sukses' => 'Data telah ditambah']);
        }else{
            // UPLOAD START       
            DB::table('video')->insert([
                'judul'         => $request->judul,
                'posisi'        => $request->posisi,
                'keterangan'    => $request->keterangan,
                'video'         => $request->video,
                'urutan'        => $request->urutan,
                'id_user'       => Session()->get('id_user'),
                'bahasa'        => $request->bahasa,
                'gambar'        => $input['nama_file'],
            ]);
            return redirect('admin/video')->with(['sukses' => 'Data telah ditambah']);
        }
    }

    // edit
    public function proses_edit(Request $request)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        request()->validate([
                           'judul'      => 'required',
                            'video'     => 'required','gambar'    => 'file|image|mimes:jpeg,png,jpg|max:8024'
                            ]);
        // UPLOAD START
        $image                  = $request->file('gambar');
        if(!empty($image)) {
            $filenamewithextension  = $request->file('gambar')->getClientOriginalName();
            $filename               = pathinfo($filenamewithextension, PATHINFO_FILENAME);
            $input['nama_file']     = Str::slug($filename, '-').'-'.time().'.'.$image->getClientOriginalExtension();
            $destinationPath        = './assets/upload/image/thumbs/';
            $img = Image::make($image->getRealPath(),array(
                'width'     => 150,
                'height'    => 150,
                'grayscale' => false
            ));
            $img->save($destinationPath.'/'.$input['nama_file']);
            $destinationPath = './assets/upload/image/';
            $image->move($destinationPath, $input['nama_file']);
            // END UPLOAD
            DB::table('video')->where('id_video',$request->id_video)->update([
                'judul'         => $request->judul,
                'posisi'        => $request->posisi,
                'keterangan'    => $request->keterangan,
                'video'         => $request->video,
                'urutan'        => $request->urutan,
                'id_user'       => Session()->get('id_user'),
                'bahasa'        => $request->bahasa,
                'gambar'            => $input['nama_file'],
            ]);
            return redirect('admin/video')->with(['sukses' => 'Data telah diupdate']);
        }else{
            DB::table('video')->where('id_video',$request->id_video)->update([
                'judul'         => $request->judul,
                'posisi'        => $request->posisi,
                'keterangan'    => $request->keterangan,
                'video'         => $request->video,
                'urutan'        => $request->urutan,
                'id_user'       => Session()->get('id_user'),
                'bahasa'        => $request->bahasa
            ]);
            return redirect('admin/video')->with(['sukses' => 'Data telah diupdate']);
        }
    }

    // Delete
    public function delete($id_video)
    {
        if(Session()->get('username')=="") { return redirect('login')->with(['warning' => 'Mohon maaf, Anda belum login']);}
        DB::table('video')->where('id_video',$id_video)->delete();
        return redirect('admin/video')->with(['sukses' => 'Data telah dihapus']);
    }
}

=== END OF FILE: Http\Controllers\Admin\Video.php ===


=== START OF FILE: Http\Controllers\Api\AdminDashboardController.php ===
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Validator;

/**
 * Controller untuk Admin Dashboard (Mobile App)
 * Menangani fitur khusus admin seperti konfirmasi transaksi, kelola artikel, kelola paket iklan, dan statistik
 */
class AdminDashboardController extends Controller
{
    /**
     * Get admin dashboard statistics
     * Menampilkan statistik untuk admin dashboard
     */
    public function getAdminStats()
    {
        try {
            // Hitung statistik users
            $totalAdmins = DB::table('users')
                ->whereIn(DB::raw('LOWER(akses_level)'), ['admin', 'superadmin'])
                ->count();
            $totalNonAdminUsers = DB::table('users')
                ->whereNotIn(DB::raw('LOWER(akses_level)'), ['admin', 'superadmin'])
                ->count();

            // Hitung statistik iklan/property
            $totalAds = DB::table('property_db')->count();
            $activeAds = DB::table('property_db')->where('status', 1)->count();

            // Hitung total pengunjung dari semua iklan
            $totalVisitors = DB::table('property_db')->sum('view_count');

            // Hitung statistik transaksi paket
            $pendingTransactions = DB::table('transaksi_paket')
                ->where('status_pembayaran', 'pending')
                ->count();
            $confirmedTransactions = DB::table('transaksi_paket')
                ->where('status_pembayaran', 'confirmed')
                ->count();
            $rejectedTransactions = DB::table('transaksi_paket')
                ->where('status_pembayaran', 'rejected')
                ->count();
            $totalTransactions = DB::table('transaksi_paket')->count();

            // Hitung total revenue dari transaksi confirmed
            $totalRevenue = DB::table('transaksi_paket')
                ->join('paket_iklan', 'transaksi_paket.paket_id', '=', 'paket_iklan.id')
                ->where('transaksi_paket.status_pembayaran', 'confirmed')
                ->sum('paket_iklan.harga');

            // Hitung statistik artikel
            $totalArticles = DB::table('berita')->count();
            $publishedArticles = DB::table('berita')->where('status_berita', 'Publish')->count();
            $draftArticles = DB::table('berita')->where('status_berita', 'Draft')->count();

            // Hitung statistik staff
            $totalStaff = DB::table('staff')->count();
            $activeStaff = DB::table('staff')->where('status_staff', 'Ya')->count();

            return response()->json([
                'success' => true,
                'data' => [
                    'users' => [
                        'total_admin' => $totalAdmins,
                        'total_non_admin' => $totalNonAdminUsers,
                    ],
                    'advertisements' => [
                        'total' => $totalAds,
                        'active' => $activeAds,
                    ],
                    'visitors' => [
                        'total' => $totalVisitors,
                    ],
                    'transactions' => [
                        'pending' => $pendingTransactions,
                        'confirmed' => $confirmedTransactions,
                        'rejected' => $rejectedTransactions,
                        'total' => $totalTransactions,
                    ],
                    'revenue' => [
                        'total' => $totalRevenue,
                    ],
                    'articles' => [
                        'total' => $totalArticles,
                        'published' => $publishedArticles,
                        'draft' => $draftArticles,
                    ],
                    'staff' => [
                        'total' => $totalStaff,
                        'active' => $activeStaff,
                    ],
                ],
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil statistik: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Get all transactions for admin management
     * Menampilkan semua transaksi dari semua users untuk dikelola admin
     */
    public function getAllTransactions(Request $request)
    {
        try {
            $status = $request->input('status', null); // Filter by status if provided
            $page = $request->input('page', 1);
            $perPage = $request->input('per_page', 20);

            $query = DB::table('transaksi_paket')
                ->join('users', 'transaksi_paket.id_user', '=', 'users.id_user')
                ->join('paket_iklan', 'transaksi_paket.paket_id', '=', 'paket_iklan.id')
                ->leftJoin('staff', 'transaksi_paket.id_staff', '=', 'staff.id_staff')
                ->select(
                    'transaksi_paket.*',
                    'users.nama as nama_user',
                    'users.email as email_user',
                    'staff.nama_staff',
                    'staff.telepon as telepon_staff',
                    'paket_iklan.nama_paket',
                    'paket_iklan.harga',
                    'paket_iklan.kuota_iklan'
                );

            if ($status) {
                $query->where('transaksi_paket.status_pembayaran', $status);
            }

            $total = $query->count();
            $transactions = $query
                ->orderBy('transaksi_paket.created_at', 'desc')
                ->skip(($page - 1) * $perPage)
                ->take($perPage)
                ->get();

            return response()->json([
                'success' => true,
                'data' => $transactions,
                'pagination' => [
                    'current_page' => $page,
                    'per_page' => $perPage,
                    'total' => $total,
                    'last_page' => ceil($total / $perPage),
                ],
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil transaksi: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Update transaction status (confirm/reject/edit)
     * Mengupdate status transaksi atau mengedit data transaksi
     */
    public function updateTransaction(Request $request, $id)
    {
        try {
            $validator = Validator::make($request->all(), [
                'status_pembayaran' => 'nullable|in:pending,confirmed,rejected,unverified',
                'keterangan' => 'nullable|string',
                'paket_id' => 'nullable|exists:paket_iklan,id',
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Validasi gagal',
                    'errors' => $validator->errors(),
                ], 422);
            }

            $transaction = DB::table('transaksi_paket')->where('id', $id)->first();
            if (!$transaction) {
                return response()->json([
                    'success' => false,
                    'message' => 'Transaksi tidak ditemukan',
                ], 404);
            }

            $updateData = [];
            if ($request->has('status_pembayaran')) {
                $updateData['status_pembayaran'] = $request->status_pembayaran;

                // If confirming transaction, update staff quotas
                if ($request->status_pembayaran === 'confirmed') {
                    // Get package details
                    $paket = DB::table('paket_iklan')->where('id', $transaction->paket_id)->first();
                    
                    if (!$paket) {
                        return response()->json([
                            'success' => false,
                            'message' => 'Paket iklan tidak ditemukan',
                        ], 404);
                    }

                    // Get staff by id_staff from transaction
                    $staff = DB::table('staff')->where('id_staff', $transaction->id_staff)->first();

                    if ($staff) {
                        // Calculate new quotas
                        $newTotalKuota = $staff->total_kuota_iklan + $paket->kuota_iklan;
                        $newSisaKuota = $staff->sisa_kuota_iklan + $paket->kuota_iklan;

                        // Update staff status and quota
                        DB::table('staff')->where('id_staff', $staff->id_staff)->update([
                            'status_staff' => 'Ya',
                            'total_kuota_iklan' => $newTotalKuota,
                            'sisa_kuota_iklan' => $newSisaKuota,
                        ]);
                    }

                    $updateData['tanggal_konfirmasi'] = now();
                    $updateData['dikonfirmasi_oleh'] = 1; // Admin user ID, should be from auth
                } elseif ($request->status_pembayaran === 'rejected') {
                    $updateData['tanggal_konfirmasi'] = now();
                    $updateData['dikonfirmasi_oleh'] = 1; // Admin user ID, should be from auth
                }
            }

            if ($request->has('keterangan')) {
                $updateData['keterangan'] = $request->keterangan;
            }

            if ($request->has('paket_id')) {
                $updateData['paket_id'] = $request->paket_id;
            }

            $updateData['updated_at'] = now();

            DB::table('transaksi_paket')->where('id', $id)->update($updateData);

            return response()->json([
                'success' => true,
                'message' => 'Transaksi berhasil diupdate',
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal update transaksi: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Get all articles for admin management
     * Menampilkan semua artikel untuk dikelola admin
     */
    public function getAllArticles(Request $request)
    {
        try {
            $page = $request->input('page', 1);
            $perPage = $request->input('per_page', 10);
            $status = $request->input('status', null); // Filter by status

            $query = DB::table('berita')
                ->join('users', 'berita.id_user', '=', 'users.id_user')
                ->select(
                    'berita.*',
                    'users.nama as author_name'
                );

            if ($status) {
                $query->where('berita.status_berita', $status);
            }

            $total = $query->count();
            $articles = $query
                ->orderBy('berita.tanggal_publish', 'desc')
                ->skip(($page - 1) * $perPage)
                ->take($perPage)
                ->get();

            return response()->json([
                'success' => true,
                'data' => $articles,
                'pagination' => [
                    'current_page' => $page,
                    'per_page' => $perPage,
                    'total' => $total,
                    'last_page' => ceil($total / $perPage),
                ],
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil artikel: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Create new article
     * Membuat artikel baru
     */
    public function createArticle(Request $request)
    {
        try {
            $validator = Validator::make($request->all(), [
                'judul_berita' => 'required|string|max:255',
                'isi' => 'required|string',
                'id_kategori' => 'required|integer',
                'status_berita' => 'required|in:Draft,Publish',
                'gambar' => 'nullable|image|mimes:jpeg,png,jpg|max:2048',
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Validasi gagal',
                    'errors' => $validator->errors(),
                ], 422);
            }

            $slug = \Illuminate\Support\Str::slug($request->judul_berita);
            
            // Handle image upload
            $gambarName = null;
            if ($request->hasFile('gambar')) {
                $image = $request->file('gambar');
                $gambarName = time() . '_' . $slug . '.' . $image->getClientOriginalExtension();
                $image->move(public_path('assets/upload/image'), $gambarName);
            }

            $articleId = DB::table('berita')->insertGetId([
                'id_user' => 1, // Admin user ID, should be from auth
                'id_kategori' => $request->id_kategori,
                'bahasa' => 'ID',
                'slug_berita' => $slug,
                'judul_berita' => $request->judul_berita,
                'isi' => $request->isi,
                'status_berita' => $request->status_berita,
                'jenis_berita' => 'Berita',
                'keywords' => $request->keywords ?? '',
                'gambar' => $gambarName,
                'hits' => 0,
                'tanggal_post' => now(),
                'tanggal_publish' => now(),
                'tanggal' => now(),
                'link_berita' => '',
            ]);

            return response()->json([
                'success' => true,
                'message' => 'Artikel berhasil dibuat',
                'data' => ['id' => $articleId],
            ], 201);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal membuat artikel: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Update article
     * Mengupdate artikel
     */
    public function updateArticle(Request $request, $id)
    {
        try {
            $validator = Validator::make($request->all(), [
                'judul_berita' => 'required|string|max:255',
                'isi' => 'required|string',
                'id_kategori' => 'required|integer',
                'status_berita' => 'required|in:Draft,Publish',
                'gambar' => 'nullable|image|mimes:jpeg,png,jpg|max:2048',
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Validasi gagal',
                    'errors' => $validator->errors(),
                ], 422);
            }

            $article = DB::table('berita')->where('id_berita', $id)->first();
            if (!$article) {
                return response()->json([
                    'success' => false,
                    'message' => 'Artikel tidak ditemukan',
                ], 404);
            }

            $slug = \Illuminate\Support\Str::slug($request->judul_berita);
            
            // Handle image upload
            $gambarName = $article->gambar;
            if ($request->hasFile('gambar')) {
                // Delete old image
                if ($article->gambar && file_exists(public_path('assets/upload/image/' . $article->gambar))) {
                    unlink(public_path('assets/upload/image/' . $article->gambar));
                }
                
                $image = $request->file('gambar');
                $gambarName = time() . '_' . $slug . '.' . $image->getClientOriginalExtension();
                $image->move(public_path('assets/upload/image'), $gambarName);
            }

            DB::table('berita')->where('id_berita', $id)->update([
                'id_kategori' => $request->id_kategori,
                'slug_berita' => $slug,
                'judul_berita' => $request->judul_berita,
                'isi' => $request->isi,
                'status_berita' => $request->status_berita,
                'keywords' => $request->keywords ?? $article->keywords,
                'gambar' => $gambarName,
                'tanggal' => now(),
            ]);

            return response()->json([
                'success' => true,
                'message' => 'Artikel berhasil diupdate',
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal update artikel: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Delete article
     * Menghapus artikel
     */
    public function deleteArticle($id)
    {
        try {
            $article = DB::table('berita')->where('id_berita', $id)->first();
            if (!$article) {
                return response()->json([
                    'success' => false,
                    'message' => 'Artikel tidak ditemukan',
                ], 404);
            }

            // Delete image file
            if ($article->gambar && file_exists(public_path('assets/upload/image/' . $article->gambar))) {
                unlink(public_path('assets/upload/image/' . $article->gambar));
            }

            DB::table('berita')->where('id_berita', $id)->delete();

            return response()->json([
                'success' => true,
                'message' => 'Artikel berhasil dihapus',
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal menghapus artikel: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Get all advertisement packages
     * Menampilkan semua paket iklan
     */
    public function getAllPackages()
    {
        try {
            $packages = DB::table('paket_iklan')
                ->orderBy('harga', 'asc')
                ->get();

            return response()->json([
                'success' => true,
                'data' => $packages,
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil paket iklan: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Create new package
     * Membuat paket iklan baru
     */
    public function createPackage(Request $request)
    {
        try {
            $validator = Validator::make($request->all(), [
                'nama_paket' => 'required|string|max:100|unique:paket_iklan',
                'harga' => 'required|numeric|min:0',
                'kuota_iklan' => 'required|integer|min:0',
                'deskripsi' => 'nullable|string',
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Validasi gagal',
                    'errors' => $validator->errors(),
                ], 422);
            }

            $packageId = DB::table('paket_iklan')->insertGetId([
                'nama_paket' => $request->nama_paket,
                'harga' => $request->harga,
                'kuota_iklan' => $request->kuota_iklan,
                'deskripsi' => $request->deskripsi,
                'is_active' => $request->is_active ?? 1,
                'created_at' => now(),
                'updated_at' => now(),
            ]);

            return response()->json([
                'success' => true,
                'message' => 'Paket iklan berhasil dibuat',
                'data' => ['id' => $packageId],
            ], 201);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal membuat paket iklan: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Update package
     * Mengupdate paket iklan
     */
    public function updatePackage(Request $request, $id)
    {
        try {
            $validator = Validator::make($request->all(), [
                'nama_paket' => 'required|string|max:100|unique:paket_iklan,nama_paket,' . $id,
                'harga' => 'required|numeric|min:0',
                'kuota_iklan' => 'required|integer|min:0',
                'deskripsi' => 'nullable|string',
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Validasi gagal',
                    'errors' => $validator->errors(),
                ], 422);
            }

            $package = DB::table('paket_iklan')->where('id', $id)->first();
            if (!$package) {
                return response()->json([
                    'success' => false,
                    'message' => 'Paket iklan tidak ditemukan',
                ], 404);
            }

            DB::table('paket_iklan')->where('id', $id)->update([
                'nama_paket' => $request->nama_paket,
                'harga' => $request->harga,
                'kuota_iklan' => $request->kuota_iklan,
                'deskripsi' => $request->deskripsi,
                'is_active' => $request->is_active ?? $package->is_active,
                'updated_at' => now(),
            ]);

            return response()->json([
                'success' => true,
                'message' => 'Paket iklan berhasil diupdate',
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal update paket iklan: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Delete package
     * Menghapus paket iklan
     */
    public function deletePackage($id)
    {
        try {
            $package = DB::table('paket_iklan')->where('id', $id)->first();
            if (!$package) {
                return response()->json([
                    'success' => false,
                    'message' => 'Paket iklan tidak ditemukan',
                ], 404);
            }

            DB::table('paket_iklan')->where('id', $id)->delete();

            return response()->json([
                'success' => true,
                'message' => 'Paket iklan berhasil dihapus',
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal menghapus paket iklan: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Get article categories
     * Mendapatkan kategori artikel
     */
    public function getArticleCategories()
    {
        try {
            $categories = DB::table('kategori')
                ->where('bahasa', 'ID')
                ->orderBy('urutan', 'asc')
                ->get();

            return response()->json([
                'success' => true,
                'data' => $categories,
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil kategori: ' . $e->getMessage(),
            ], 500);
        }
    }
}

=== END OF FILE: Http\Controllers\Api\AdminDashboardController.php ===


=== START OF FILE: Http\Controllers\Api\AiWaisakaInsightController.php ===
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class AiWaisakaInsightController extends Controller
{
    /**
     * Get market insight for specific location and property type
     */
    public function marketInsight(Request $request)
    {
        try {
            $validated = $request->validate([
                'location' => 'required|string|max:255',
                'propertyType' => 'required|string|in:rumah,apartemen,ruko,tanah',
                'listingType' => 'nullable|string|in:jual,sewa'
            ]);

            $location = $validated['location'];
            $propertyType = $validated['propertyType'];
            $listingType = $validated['listingType'] ?? 'jual';

            // Get market data
            $marketData = $this->getMarketData($location, $propertyType, $listingType);

            // Generate AI-powered insights
            $insights = $this->generateInsights($marketData, $location, $propertyType, $listingType);

            return response()->json([
                'success' => true,
                'message' => 'Market insight berhasil diambil',
                'data' => [
                    'location' => $location,
                    'propertyType' => $propertyType,
                    'listingType' => $listingType,
                    'marketData' => $marketData,
                    'insights' => $insights,
                    'generatedAt' => now()->toISOString()
                ]
            ], 200);

        } catch (\Illuminate\Validation\ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Data insight tidak valid',
                'errors' => $e->errors()
            ], 422);
        } catch (\Exception $e) {
            Log::error('AI Waisaka Market Insight Error', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'request_data' => $request->all()
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Terjadi kesalahan pada server',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get market data from database
     */
    private function getMarketData($location, $propertyType, $listingType)
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property')
            ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi')
            ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten')
            ->select(
                'property_db.harga',
                'property_db.lt',
                'property_db.lb',
                'property_db.kamar_tidur',
                'property_db.kamar_mandi',
                'property_db.tanggal',
                'provinsi.nama as provinsi',
                'kabupaten.nama as kabupaten',
                'kategori_property.nama_kategori_property'
            )
            ->where('property_db.status', 1)
            ->where('property_db.tipe', $listingType)
            ->where(function($q) use ($location) {
                $q->where('provinsi.nama', 'LIKE', '%' . $location . '%')
                  ->orWhere('kabupaten.nama', 'LIKE', '%' . $location . '%')
                  ->orWhere('property_db.alamat', 'LIKE', '%' . $location . '%');
            });

        if ($propertyType !== 'all') {
            $query->where('kategori_property.nama_kategori_property', $propertyType);
        }

        $properties = $query->get();

        if ($properties->isEmpty()) {
            return $this->generateDefaultMarketData($location, $propertyType, $listingType);
        }

        // Calculate statistics
        $prices = $properties->pluck('harga')->filter()->toArray();
        $landAreas = $properties->pluck('lt')->filter()->toArray();
        $buildingAreas = $properties->pluck('lb')->filter()->toArray();

        return [
            'totalProperties' => $properties->count(),
            'averagePrice' => count($prices) > 0 ? array_sum($prices) / count($prices) : 0,
            'minPrice' => count($prices) > 0 ? min($prices) : 0,
            'maxPrice' => count($prices) > 0 ? max($prices) : 0,
            'medianPrice' => count($prices) > 0 ? $this->calculateMedian($prices) : 0,
            'averageLandArea' => count($landAreas) > 0 ? array_sum($landAreas) / count($landAreas) : 0,
            'averageBuildingArea' => count($buildingAreas) > 0 ? array_sum($buildingAreas) / count($buildingAreas) : 0,
            'pricePerSquareMeter' => count($landAreas) > 0 ? array_sum($prices) / array_sum($landAreas) : 0,
            'recentListings' => $properties->sortByDesc('tanggal')->take(5)->values(),
            'distribution' => $this->calculateDistribution($prices)
        ];
    }

    /**
     * Generate default market data when no properties found
     */
    private function generateDefaultMarketData($location, $propertyType, $listingType)
    {
        $defaultData = [
            'rumah' => [
                'jual' => ['avg' => 800000000, 'min' => 300000000, 'max' => 2000000000],
                'sewa' => ['avg' => 25000000, 'min' => 10000000, 'max' => 75000000]
            ],
            'apartemen' => [
                'jual' => ['avg' => 500000000, 'min' => 150000000, 'max' => 1500000000],
                'sewa' => ['avg' => 3500000, 'min' => 1500000, 'max' => 10000000]
            ],
            'ruko' => [
                'jual' => ['avg' => 1200000000, 'min' => 500000000, 'max' => 3000000000],
                'sewa' => ['avg' => 45000000, 'min' => 20000000, 'max' => 100000000]
            ],
            'tanah' => [
                'jual' => ['avg' => 300000000, 'min' => 100000000, 'max' => 800000000],
                'sewa' => ['avg' => 5000000, 'min' => 2000000, 'max' => 15000000]
            ]
        ];

        $data = $defaultData[$propertyType][$listingType] ?? $defaultData['rumah']['jual'];

        return [
            'totalProperties' => 0,
            'averagePrice' => $data['avg'],
            'minPrice' => $data['min'],
            'maxPrice' => $data['max'],
            'medianPrice' => $data['avg'],
            'averageLandArea' => 120,
            'averageBuildingArea' => 90,
            'pricePerSquareMeter' => $data['avg'] / 90,
            'recentListings' => [],
            'distribution' => [
                'low' => 0, 'medium' => 0, 'high' => 0, 'luxury' => 0
            ]
        ];
    }

    /**
     * Calculate median value
     */
    private function calculateMedian($array)
    {
        sort($array);
        $count = count($array);
        $middle = floor($count / 2);

        if ($count % 2 == 0) {
            return ($array[$middle - 1] + $array[$middle]) / 2;
        } else {
            return $array[$middle];
        }
    }

    /**
     * Calculate price distribution
     */
    private function calculateDistribution($prices)
    {
        if (empty($prices)) {
            return ['low' => 0, 'medium' => 0, 'high' => 0, 'luxury' => 0];
        }

        $min = min($prices);
        $max = max($prices);
        $range = $max - $min;

        $low = $min + ($range * 0.25);
        $medium = $min + ($range * 0.5);
        $high = $min + ($range * 0.75);

        $distribution = [
            'low' => 0,
            'medium' => 0,
            'high' => 0,
            'luxury' => 0
        ];

        foreach ($prices as $price) {
            if ($price <= $low) {
                $distribution['low']++;
            } elseif ($price <= $medium) {
                $distribution['medium']++;
            } elseif ($price <= $high) {
                $distribution['high']++;
            } else {
                $distribution['luxury']++;
            }
        }

        return $distribution;
    }

    /**
     * Generate AI-powered insights
     */
    private function generateInsights($marketData, $location, $propertyType, $listingType)
    {
        $insights = [];

        // Price trend insight
        if ($marketData['totalProperties'] > 0) {
            $avgPrice = $marketData['averagePrice'];
            $pricePerSqm = $marketData['pricePerSquareMeter'];

            $insights[] = [
                'type' => 'price_trend',
                'title' => 'Tren Harga',
                'description' => "Rata-rata harga {$propertyType} di {$location} adalah " . $this->formatCurrency($avgPrice),
                'recommendation' => $avgPrice < 1000000000 ? "Harga tergolong terjangkau, baik untuk investasi" : "Harga premium, pertimbangkan lokasi strategis",
                'confidence' => 85
            ];

            // Price per square meter insight
            $insights[] = [
                'type' => 'value_analysis',
                'title' => 'Analisis Nilai',
                'description' => "Harga per meter persegi: " . $this->formatCurrency($pricePerSqm),
                'recommendation' => $pricePerSqm < 15000000 ? "Nilai properti bagus untuk investasi jangka panjang" : "Properti premium dengan nilai investasi tinggi",
                'confidence' => 80
            ];
        }

        // Market activity insight
        if ($marketData['totalProperties'] >= 5) {
            $insights[] = [
                'type' => 'market_activity',
                'title' => 'Aktivitas Pasar',
                'description' => "Terdapat {$marketData['totalProperties']} properti aktif di {$location}",
                'recommendation' => "Pasar aktif dengan banyak pilihan, waktu yang baik untuk membeli",
                'confidence' => 90
            ];
        }

        // Distribution insight
        $distribution = $marketData['distribution'];
        $maxSegment = array_keys($distribution, max($distribution))[0];

        $segmentNames = [
            'low' => 'terjangkau',
            'medium' => 'menengah',
            'high' => 'premium',
            'luxury' => 'mewah'
        ];

        $insights[] = [
            'type' => 'market_segment',
            'title' => 'Segmen Pasar',
            'description' => "Pasaran didominasi oleh properti kelas {$segmentNames[$maxSegment]}",
            'recommendation' => "Fokus pada segmen {$segmentNames[$maxSegment]} untuk hasil terbaik",
            'confidence' => 75
        ];

        return $insights;
    }

    /**
     * Format currency to Indonesian Rupiah
     */
    private function formatCurrency($amount)
    {
        if ($amount >= 1000000000) {
            return 'Rp ' . number_format($amount / 1000000000, 1) . ' Miliar';
        } elseif ($amount >= 1000000) {
            return 'Rp ' . number_format($amount / 1000000, 1) . ' Juta';
        } else {
            return 'Rp ' . number_format($amount, 0);
        }
    }
}

=== END OF FILE: Http\Controllers\Api\AiWaisakaInsightController.php ===


=== START OF FILE: Http\Controllers\Api\AiWaisakaSearchController.php ===
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class AiWaisakaSearchController extends Controller
{
    /**
     * Process AI Waisaka search request
     * Receives JSON data from frontend and processes it for precise property search
     */
    public function processAiSearch(Request $request)
    {
        try {
            // Validate input
            $validated = $request->validate([
                'filters' => 'required|array',
                'filters.listingType' => 'required|string|in:jual,sewa',
                'filters.location' => 'nullable|string|max:255',
                'filters.minPrice' => 'nullable|numeric|min:0',
                'filters.maxPrice' => 'nullable|numeric|min:0',
                'filters.minLandArea' => 'nullable|numeric|min:0',
                'filters.maxLandArea' => 'nullable|numeric|min:0',
                'filters.minBuildingArea' => 'nullable|numeric|min:0',
                'filters.maxBuildingArea' => 'nullable|numeric|min:0',
                'filters.bedrooms' => 'nullable|integer|min:0',
                'filters.bathrooms' => 'nullable|integer|min:0',
                'filters.propertyType' => 'nullable|string|in:rumah,apartemen,ruko,tanah',
                'filters.certificate' => 'nullable|string|in:SHM,HGB,Lainnya',
                //  TAMBAHAN: Field baru untuk validasi
                'filters.categoryId' => 'nullable|integer|exists:kategori_property,id_kategori_property',
                'filters.provinceId' => 'nullable|integer|exists:provinsi,id',
                'filters.districtId' => 'nullable|integer|exists:kabupaten,id',
                'filters.subDistrictId' => 'nullable|integer|exists:kecamatan,id',
                'filters.keywords' => 'nullable|string|max:255',
            ]);

            $filters = $validated['filters'];

            //  TAMBAHAN: Validasi price range
            if (!empty($filters['minPrice']) && !empty($filters['maxPrice'])) {
                if ($filters['minPrice'] > $filters['maxPrice']) {
                    return response()->json([
                        'success' => false,
                        'message' => 'Harga minimum tidak boleh lebih besar dari harga maksimum'
                    ], 422);
                }
            }

            //  TAMBAHAN: Validasi land area range
            if (!empty($filters['minLandArea']) && !empty($filters['maxLandArea'])) {
                if ($filters['minLandArea'] > $filters['maxLandArea']) {
                    return response()->json([
                        'success' => false,
                        'message' => 'Luas tanah minimum tidak boleh lebih besar dari luas tanah maksimum'
                    ], 422);
                }
            }

            //  TAMBAHAN: Validasi building area range
            if (!empty($filters['minBuildingArea']) && !empty($filters['maxBuildingArea'])) {
                if ($filters['minBuildingArea'] > $filters['maxBuildingArea']) {
                    return response()->json([
                        'success' => false,
                        'message' => 'Luas bangunan minimum tidak boleh lebih besar dari luas bangunan maksimum'
                    ], 422);
                }
            }

            // Log the search request for debugging
            Log::info('AI Waisaka Search Request', [
                'filters' => $filters,
                'ip' => $request->ip(),
                'user_agent' => $request->userAgent()
            ]);

            // Build the search query
            $query = $this->buildSearchQuery($filters);

            // Execute search
            $properties = $query->get();

            // Get property images
            $propertyIds = $properties->pluck('id_property')->toArray();
            $images = collect();
            
            if (!empty($propertyIds)) {
                $images = DB::table('property_img')
                    ->whereIn('id_property', $propertyIds)
                    ->orderBy('id_property')
                    ->orderBy('index_img')
                    ->get()
                    ->groupBy('id_property');
            }

            // Transform data for response
            $transformedProperties = $properties->map(function($property) use ($images) {
                return $this->transformPropertyData($property, $images);
            });

            // Log search results
            Log::info('AI Waisaka Search Results', [
                'filters_applied' => $filters,
                'results_count' => $transformedProperties->count(),
                'property_ids' => $propertyIds
            ]);

            return response()->json([
                'success' => true,
                'message' => 'Pencarian AI Waisaka berhasil',
                'data' => $transformedProperties,
                'search_metadata' => [
                    'filters_applied' => $filters,
                    'total_results' => $transformedProperties->count(),
                    'search_timestamp' => now()->toISOString()
                ]
            ], 200);

        } catch (\Illuminate\Validation\ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Data pencarian tidak valid',
                'errors' => $e->errors()
            ], 422);
        } catch (\Exception $e) {
            Log::error('AI Waisaka Search Error', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'request_data' => $request->all()
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Terjadi kesalahan pada server',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Build search query based on filters
     */
    private function buildSearchQuery(array $filters)
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property', 'LEFT')
            ->join('staff', 'staff.id_staff', '=', 'property_db.id_staff', 'LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi', 'LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten', 'LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan', 'LEFT')
            ->select(
                'property_db.*',
                'kategori_property.nama_kategori_property',
                'staff.nama_staff',
                'provinsi.nama as nama_provinsi',
                'kabupaten.nama as nama_kabupaten',
                'kecamatan.nama as nama_kecamatan',
                'property_db.tanggal as created_at'
            )
            ->where('property_db.status', 1) // Only active properties
            ->orderBy('property_db.tanggal', 'DESC');

        // Apply filters
        if (!empty($filters['listingType'])) {
            $query->where('property_db.tipe', $filters['listingType']);
        }

        //  PERBAIKAN: Location search yang lebih komprehensif
        if (!empty($filters['location'])) {
            $location = $filters['location'];
            $query->where(function($q) use ($location) {
                $q->where('provinsi.nama', 'LIKE', '%' . $location . '%')
                  ->orWhere('kabupaten.nama', 'LIKE', '%' . $location . '%')
                  ->orWhere('kecamatan.nama', 'LIKE', '%' . $location . '%')
                  ->orWhere('property_db.alamat', 'LIKE', '%' . $location . '%')
                  ->orWhere('property_db.nama_property', 'LIKE', '%' . $location . '%') //  TAMBAHAN
                  ->orWhere('property_db.kode', 'LIKE', '%' . $location . '%') //  TAMBAHAN
                  ->orWhere('property_db.isi', 'LIKE', '%' . $location . '%'); //  TAMBAHAN
            });
        }

        if (!empty($filters['minPrice'])) {
            $query->where('property_db.harga', '>=', $filters['minPrice']);
        }

        if (!empty($filters['maxPrice'])) {
            $query->where('property_db.harga', '<=', $filters['maxPrice']);
        }

        if (!empty($filters['minLandArea'])) {
            $query->where('property_db.lt', '>=', $filters['minLandArea']);
        }

        if (!empty($filters['maxLandArea'])) {
            $query->where('property_db.lt', '<=', $filters['maxLandArea']);
        }

        if (!empty($filters['minBuildingArea'])) {
            $query->where('property_db.lb', '>=', $filters['minBuildingArea']);
        }

        if (!empty($filters['maxBuildingArea'])) {
            $query->where('property_db.lb', '<=', $filters['maxBuildingArea']);
        }

        if (!empty($filters['bedrooms'])) {
            $query->where('property_db.kamar_tidur', '>=', $filters['bedrooms']);
        }

        if (!empty($filters['bathrooms'])) {
            $query->where('property_db.kamar_mandi', '>=', $filters['bathrooms']);
        }

        if (!empty($filters['propertyType'])) {
            $propertyType = $filters['propertyType'];
            $query->where('kategori_property.nama_kategori_property', 'LIKE', '%' . $propertyType . '%');
        }

        if (!empty($filters['certificate'])) {
            $query->where('property_db.surat', $filters['certificate']);
        }

        //  TAMBAHAN: Filter berdasarkan categoryId
        if (!empty($filters['categoryId'])) {
            $query->where('property_db.id_kategori_property', $filters['categoryId']);
        }

        //  TAMBAHAN: Filter berdasarkan provinceId
        if (!empty($filters['provinceId'])) {
            $query->where('property_db.id_provinsi', $filters['provinceId']);
        }

        //  TAMBAHAN: Filter berdasarkan districtId
        if (!empty($filters['districtId'])) {
            $query->where('property_db.id_kabupaten', $filters['districtId']);
        }

        //  TAMBAHAN: Filter berdasarkan subDistrictId
        if (!empty($filters['subDistrictId'])) {
            $query->where('property_db.id_kecamatan', $filters['subDistrictId']);
        }

        //  TAMBAHAN: Filter berdasarkan keywords untuk pencarian yang lebih luas
        if (!empty($filters['keywords'])) {
            $keywords = $filters['keywords'];
            $query->where(function($q) use ($keywords) {
                $q->where('property_db.nama_property', 'LIKE', '%' . $keywords . '%')
                  ->orWhere('property_db.kode', 'LIKE', '%' . $keywords . '%')
                  ->orWhere('property_db.isi', 'LIKE', '%' . $keywords . '%')
                  ->orWhere('property_db.alamat', 'LIKE', '%' . $keywords . '%')
                  ->orWhere('property_db.keywords', 'LIKE', '%' . $keywords . '%');
            });
        }

        return $query;
    }

    /**
     * Transform property data for consistent response format
     */
    private function transformPropertyData($property, $images)
    {
        $propertyImages = [];
        if ($images && $images->has($property->id_property)) {
            $propertyImages = $images->get($property->id_property)->map(function($img) {
                return [
                    'gambar' => asset('assets/upload/property/' . $img->gambar),
                    'index_img' => (int) $img->index_img
                ];
            })->toArray();
        }

        // Set main image URL
        $mainImageUrl = null;
        if (!empty($propertyImages)) {
            $mainImageUrl = $propertyImages[0]['gambar'];
        }

        return [
            'id_property' => (int) $property->id_property,
            'kode' => $property->kode ?? '',
            'nama_property' => $property->nama_property ?? '',
            'tipe' => $property->tipe ?? '',
            'harga' => (int) ($property->harga ?? 0),
            'lt' => $property->lt ? (int) $property->lt : null,
            'lb' => $property->lb ? (int) $property->lb : null,
            'kamar_tidur' => (int) ($property->kamar_tidur ?? 0),
            'kamar_mandi' => (int) ($property->kamar_mandi ?? 0),
            'alamat' => $property->alamat ?? '',
            'view_count' => (int) ($property->view_count ?? 0),
            'created_at' => $property->created_at ?? $property->tanggal ?? null,
            'updated_at' => $property->updated_at ?? $property->tanggal ?? null,
            'nama_kategori_property' => $property->nama_kategori_property ?? '',
            'nama_provinsi' => $property->nama_provinsi ?? '',
            'nama_kabupaten' => $property->nama_kabupaten ?? '',
            'nama_kecamatan' => $property->nama_kecamatan ?? '',
            'nama_staff' => $property->nama_staff ?? '',
            'images' => $propertyImages,
            'main_image_url' => $mainImageUrl,
            // Additional fields
            'slug_property' => $property->slug_property ?? '',
            'surat' => $property->surat ?? 'SHM',
            'lantai' => $property->lantai ? (int) $property->lantai : 1,
            'jenis_sewa' => $property->jenis_sewa ?? '',
            'status' => (int) ($property->status ?? 0),
            'isi' => $property->isi ?? '',
            'keywords' => $property->keywords ?? ''
        ];
    }

    /**
     * Get search suggestions based on popular searches
     */
    public function getSearchSuggestions(Request $request)
    {
        try {
            $query = $request->query('q', '');
            
            if (strlen($query) < 2) {
                return response()->json([
                    'success' => true,
                    'data' => []
                ], 200);
            }

            // Get location suggestions
            $locations = DB::table('property_db')
                ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi', 'LEFT')
                ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten', 'LEFT')
                ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan', 'LEFT')
                ->select('provinsi.nama as provinsi', 'kabupaten.nama as kabupaten', 'kecamatan.nama as kecamatan')
                ->where('property_db.status', 1)
                ->where(function($q) use ($query) {
                    $q->where('provinsi.nama', 'LIKE', '%' . $query . '%')
                      ->orWhere('kabupaten.nama', 'LIKE', '%' . $query . '%')
                      ->orWhere('kecamatan.nama', 'LIKE', '%' . $query . '%');
                })
                ->distinct()
                ->limit(10)
                ->get();

            $suggestions = $locations->map(function($location) {
                return $location->kabupaten ?: $location->provinsi;
            })->unique()->values();

            return response()->json([
                'success' => true,
                'data' => $suggestions
            ], 200);

        } catch (\Exception $e) {
            Log::error('AI Waisaka Search Suggestions Error', [
                'error' => $e->getMessage(),
                'query' => $request->query('q')
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil saran pencarian'
            ], 500);
        }
    }
}

=== END OF FILE: Http\Controllers\Api\AiWaisakaSearchController.php ===


=== START OF FILE: Http\Controllers\Api\AuthApiController.php ===
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\User; 
use Illuminate\Support\Facades\DB;
// Hash facade tidak lagi diperlukan untuk sha1
// use Illuminate\Support\Facades\Hash; 
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Str;
use Carbon\Carbon;
use Illuminate\Support\Facades\Mail;
use Illuminate\Http\JsonResponse;

class AuthApiController extends Controller
{
    /**
     * Registrasi pengguna baru dari aplikasi mobile.
     * Endpoint: POST /api/v1/auth/register
     */
    public function register(Request $request): JsonResponse
    {
        $validator = Validator::make($request->all(), [
            'nama'              => 'required|string|max:255',
            'username'          => 'required|string|max:255|unique:users,username',
            'email'             => 'required|string|email|max:255|unique:users,email',
            'password'          => 'required|string|min:6',
            'paket_id'          => 'required|integer|exists:paket_iklan,id',
            'bukti_pembayaran'  => 'required|file|mimes:jpeg,jpg,png|max:4096',
        ], [
            'bukti_pembayaran.max' => 'Bukti pembayaran tidak boleh lebih dari 4096 kilobytes (4MB)',
            'bukti_pembayaran.file' => 'Bukti pembayaran harus berupa file',
            'bukti_pembayaran.mimes' => 'Bukti pembayaran harus berupa file dengan format: jpeg, jpg, png',
            'bukti_pembayaran.required' => 'Bukti pembayaran harus diupload'
        ]);

        if ($validator->fails()) {
            // Debug informasi file
            $debugInfo = [];
            if ($request->hasFile('bukti_pembayaran')) {
                $file = $request->file('bukti_pembayaran');
                $debugInfo = [
                    'original_name' => $file->getClientOriginalName(),
                    'mime_type' => $file->getMimeType(),
                    'size' => $file->getSize(),
                    'extension' => $file->getClientOriginalExtension(),
                    'is_valid' => $file->isValid(),
                    'error' => $file->getError()
                ];
            }
            
            return response()->json([
                'success' => false, 
                'errors' => $validator->errors(),
                'debug_info' => $debugInfo
            ], 422);
        }

        // Cek juga di tabel verifikasi agar tidak ada duplikasi email/username yang pending
        $isPending = DB::table('users_verification')
                        ->where('email', $request->email)
                        ->orWhere('username', $request->username)
                        ->exists();

        if ($isPending) {
            return response()->json(['success' => false, 'message' => 'Email atau username sudah terdaftar dan menunggu verifikasi.'], 422);
        }

        // Handle upload file bukti pembayaran
        $filePath = null;
        if ($request->hasFile('bukti_pembayaran')) {
            $file = $request->file('bukti_pembayaran');
            $fileName = time() . '_' . Str::slug($file->getClientOriginalName()) . '.' . $file->getClientOriginalExtension();
            $filePath = $file->storeAs('public/bukti_pembayaran', $fileName);
        }

        $token = Str::random(60);

        DB::table('users_verification')->insert([
            'nama'              => $request->nama,
            'email'	            => $request->email,
            'username'   	    => $request->username,
            // PERUBAHAN: Menggunakan sha1()
            'password'          => sha1($request->password),
            'paket_id'          => $request->paket_id,
            'gambar'            => $filePath,
            'token'             => $token,
            'tanggal_expired'   => Carbon::now()->addDays(3),
            'created_at'        => now(),
            'updated_at'        => now()
        ]);

        try {
            // Kirim email verifikasi menggunakan Mailable class
            $user = new \stdClass();
            $user->nama = $request->nama;
            $user->email = $request->email;
            
            Mail::to($request->email)->send(new \App\Mail\VerificationEmail($user, $token));
        } catch (\Exception $e) {
            // Log::error('Email verification failed to send: '.$e->getMessage());
        }

        return response()->json([
            'success' => true,
            'message' => 'Pendaftaran berhasil. Silakan cek email Anda untuk link aktivasi.',
            'data' => [
                'email' => $request->email,
                'nama' => $request->nama,
                'username' => $request->username,
                'paket_id' => $request->paket_id,
                'token' => $token,
                'expired_at' => Carbon::now()->addDays(3)->toISOString()
            ]
        ], 201);
    }

    /**
     * Login pengguna dari aplikasi mobile.
     * Endpoint: POST /api/v1/auth/login
     */
    public function login(Request $request): JsonResponse
    {
        $validator = Validator::make($request->all(), [
            'username' => 'required|string',
            'password' => 'required|string',
        ]);

        if ($validator->fails()) {
            return response()->json(['success' => false, 'errors' => $validator->errors()], 422);
        }

        $user = User::where('username', $request->username)
                    ->orWhere('email', $request->username)
                    ->first();
        
        // PERUBAHAN: Cek password hanya menggunakan sha1()
        if (!$user || $user->password !== sha1($request->password) ) {
            return response()->json(['success' => false, 'message' => 'Kredensial tidak valid.'], 401);
        }

        // Ambil data staff yang terhubung
        $staff = DB::table('staff')->where('id_user', $user->id_user)->first();

        return response()->json([
            'success' => true,
            'message' => 'Login berhasil',
            'data' => [
                'id_user' => $user->id_user,
                'id_staff' => $staff ? $staff->id_staff : null,
                'nama' => $user->nama,
                'username' => $user->username,
                'email' => $user->email,
                'akses_level' => $user->akses_level,
                'sisa_kuota_iklan' => $staff ? $staff->sisa_kuota_iklan : 0,
            ]
        ], 200);
    }

    /**
     * Logout pengguna dari aplikasi mobile.
     * Endpoint: POST /api/v1/auth/logout
     */
    public function logout(Request $request): JsonResponse
    {
        return response()->json([
            'success' => true,
            'message' => 'Logout berhasil.',
            'data' => [
                'logged_out_at' => now()->toISOString()
            ]
        ], 200);
    }
}

=== END OF FILE: Http\Controllers\Api\AuthApiController.php ===


=== START OF FILE: Http\Controllers\Api\MobileArticleController.php ===
<?php

namespace App\Http\Controllers\Api;

use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\DB;

class MobileArticleController extends \App\Http\Controllers\Controller
{
    public function index(Request $request): JsonResponse
    {
        try {
            $page = $request->get('page', 1);
            $perPage = 10;
            
            // Hitung offset untuk pagination
            $offset = ($page - 1) * $perPage;
            
            // Query untuk mengambil data artikel dengan pagination
            $articles = DB::table('berita')
                ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori', 'LEFT')
                ->join('users', 'users.id_user', '=', 'berita.id_user', 'LEFT')
                ->select(
                    'berita.id_berita as id',
                    'berita.judul_berita as title',
                    'berita.isi as content',
                    'berita.tanggal_publish as created_at',
                    'berita.gambar as image',
                    'berita.jenis_berita as type',
                    'berita.slug_berita as slug',
                    'berita.hits as view_count',
                    'berita.keywords',
                    'kategori.nama_kategori as category_name',
                    'users.nama as author_name'
                )
                ->where('berita.status_berita', 'Publish')
                ->orderBy('berita.tanggal_publish', 'desc')
                ->offset($offset)
                ->limit($perPage)
                ->get();

            // Hitung total artikel untuk pagination
            $totalArticles = DB::table('berita')
                ->where('berita.status_berita', 'Publish')
                ->count();

            // Hitung total halaman
            $totalPages = ceil($totalArticles / $perPage);

            // Transform data menggunakan metode transform seperti MobilePropertyController
            $transformedArticles = $articles->transform(function($article) {
                return [
                    'id' => (int) $article->id,
                    'title' => $article->title,
                    'content' => $article->content,
                    'created_at' => $article->created_at,
                    'imageUrl' => asset('assets/upload/image/' . $article->image),
                    'type' => $article->type,
                    'slug' => $article->slug,
                    'viewCount' => (int) $article->view_count,
                    'keywords' => $article->keywords,
                    'category' => $article->category_name,
                    'author' => $article->author_name
                ];
            });

            return response()->json([
                'success' => true,
                'message' => 'Daftar artikel berhasil diambil',
                'data' => $transformedArticles,
                'current_page' => (int) $page,
                'last_page' => (int) $totalPages,
                'total' => (int) $totalArticles,
                'per_page' => (int) $perPage,
                'next_page_url' => $page < $totalPages ? $page + 1 : null
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error fetching articles: ' . $e->getMessage()
            ], 500);
        }
    }

    public function show($id): JsonResponse
    {
        try {
            $article = DB::table('berita')
                ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori', 'LEFT')
                ->join('users', 'users.id_user', '=', 'berita.id_user', 'LEFT')
                ->select(
                    'berita.id_berita as id',
                    'berita.judul_berita as title',
                    'berita.isi as content',
                    'berita.tanggal_publish as created_at',
                    'berita.gambar as image',
                    'berita.jenis_berita as type',
                    'berita.slug_berita as slug',
                    'berita.hits as view_count',
                    'berita.keywords',
                    'kategori.nama_kategori as category_name',
                    'users.nama as author_name'
                )
                ->where('berita.id_berita', $id)
                ->where('berita.status_berita', 'Publish')
                ->first();

            if (!$article) {
                return response()->json([
                    'success' => false,
                    'message' => 'Artikel tidak ditemukan'
                ], 404);
            }

            // Transform data
            $transformedArticle = [
                'id' => (int) $article->id,
                'title' => $article->title,
                'content' => $article->content,
                'created_at' => $article->created_at,
                'imageUrl' => $article->image ? request()->getSchemeAndHttpHost() . '/assets/upload/image/' . $article->image : null,
                'type' => $article->type,
                'slug' => $article->slug,
                'viewCount' => (int) $article->view_count,
                'keywords' => $article->keywords,
                'category' => $article->category_name,
                'author' => $article->author_name
            ];

            return response()->json([
                'success' => true,
                'message' => 'Detail artikel berhasil diambil',
                'data' => $transformedArticle
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error fetching article detail: ' . $e->getMessage()
            ], 500);
        }
    }
}

=== END OF FILE: Http\Controllers\Api\MobileArticleController.php ===


=== START OF FILE: Http\Controllers\Api\MobileControlPanelController.php ===
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Validator;

class MobileControlPanelController extends Controller
{
    /**
     * Get user profile by ID
     */
    public function getProfile(Request $request)
    {
        $validator = Validator::make($request->all(), [
            "id_user" => "required|integer",
        ]);

        if ($validator->fails()) {
            return response()->json([
                "success" => false,
                "message" => "Data tidak valid",
                "errors" => $validator->errors()
            ], 422);
        }

        $user = DB::table("users")
            ->where("id_user", $request->id_user)
            ->first();

        if (!$user) {
            return response()->json([
                "success" => false,
                "message" => "User tidak ditemukan"
            ], 404);
        }

        $staff = DB::table("staff")->where("id_user", $user->id_user)->first();

        $userProfile = [
            "id_user" => (int) $user->id_user,
            "username" => $user->username,
            "nama" => $user->nama,
            "email" => $user->email,
            "akses_level" => $user->akses_level,
            "gambar" => $user->gambar ? asset("assets/upload/staff/" . $user->gambar) : null,
        ];

        $staffProfile = [];
        if ($staff) {
            $staffProfile = [
                "id_staff" => (int) $staff->id_staff,
                "nama_staff" => $staff->nama_staff,
                "telepon_staff" => $staff->telepon_staff,
                "status_staff" => $staff->status_staff,
                "sisa_kuota_iklan" => (int) $staff->sisa_kuota_iklan,
                "total_kuota_iklan" => (int) $staff->total_kuota_iklan,
                "gambar_staff" => $staff->gambar_staff ? asset("assets/upload/staff/" . $staff->gambar_staff) : null,
            ];
        }

        return response()->json([
            "success" => true,
            "message" => "Profil berhasil diambil",
            "data" => [
                "user" => $userProfile,
                "staff" => $staffProfile
            ]
        ], 200);
    }

    /**
     * Update user profile
     */
    public function updateProfile(Request $request)
    {
        $validator = Validator::make($request->all(), [
            "id_user" => "required|integer",
            "nama" => "nullable|string|max:255",
            "telepon" => "nullable|string|max:20",
            "email" => "nullable|email|unique:users,email," . $request->id_user,
            "gambar" => "nullable|image|mimes:jpeg,png,jpg|max:2048",
        ]);

        if ($validator->fails()) {
            return response()->json([
                "success" => false,
                "message" => "Data tidak valid",
                "errors" => $validator->errors()
            ], 422);
        }

        // Update user data
        $updateData = [];
        if ($request->has("nama")) {
            $updateData["nama"] = $request->nama;
        }
        if ($request->has("telepon")) {
            $updateData["telepon"] = $request->telepon;
        }
        if ($request->has("email")) {
            $updateData["email"] = $request->email;
        }

        DB::table("users")
            ->where("id_user", $request->id_user)
            ->update($updateData);

        // Handle image upload if exists
        if ($request->hasFile("gambar")) {
            $file = $request->file("gambar");
            $filename = time() . "." . $file->getClientOriginalExtension();
            $file->move(public_path("assets/upload/staff"), $filename);

            DB::table("users")
                ->where("id_user", $request->id_user)
                ->update(["gambar" => $filename]);
        }

        return response()->json([
            "success" => true,
            "message" => "Profil berhasil diperbarui"
        ], 200);
    }

    /**
     * Change password
     */
    public function changePassword(Request $request)
    {
        $validator = Validator::make($request->all(), [
            "id_user" => "required|integer",
            "current_password" => "required|string",
            "new_password" => "required|string|min:6",
            "password_confirmation" => "required|string|same:new_password",
        ]);

        if ($validator->fails()) {
            return response()->json([
                "success" => false,
                "message" => "Data tidak valid",
                "errors" => $validator->errors()
            ], 422);
        }

        $user = DB::table("users")
            ->where("id_user", $request->id_user)
            ->first();

        if (!$user) {
            return response()->json([
                "success" => false,
                "message" => "User tidak ditemukan"
            ], 404);
        }

        // Check current password
        if ($user->password !== sha1($request->current_password)) {
            return response()->json([
                "success" => false,
                "message" => "Password saat ini salah"
            ], 401);
        }

        // Update new password
        DB::table("users")
            ->where("id_user", $request->id_user)
            ->update(["password" => sha1($request->new_password)]);

        return response()->json([
            "success" => true,
            "message" => "Password berhasil diubah"
        ], 200);
    }
}

=== END OF FILE: Http\Controllers\Api\MobileControlPanelController.php ===


=== START OF FILE: Http\Controllers\Api\MobileDashboardController.php ===
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use App\Models\User;
use App\Models\Staff;
use App\Models\TransaksiPaket;
use App\Models\Property;

class MobileDashboardController extends Controller
{
    /**
     * Get dashboard statistics for user
     *  FIXED: Menggunakan Eloquent Models instead of DB::table() (Rekomendasi #6)
     */
    public function getStats(Request $request, $id)
    {
        try {
            //  Gunakan Eloquent Model
            $user = User::find($id);
            if (!$user) {
                return response()->json([
                    'success' => false,
                    'message' => 'User tidak ditemukan'
                ], 404);
            }

            //  Gunakan Eloquent Model dengan relationship
            $staff = Staff::where('id_user', $id)->first();

            // Hitung statistik properti
            $totalProperties = 0;
            $activeProperties = 0;
            if ($staff) {
                //  Gunakan Eloquent Model
                $totalProperties = Property::where('id_staff', $staff->id_staff)->count();
                $activeProperties = Property::where('id_staff', $staff->id_staff)
                    ->where('status', 1)
                    ->count();
            }

            //  Gunakan Eloquent Model untuk transaksi
            $totalTransactions = TransaksiPaket::where('id_user', $id)->count();
            $confirmedTransactions = TransaksiPaket::where('id_user', $id)
                ->where('status_pembayaran', 'confirmed')
                ->count();

            // Hitung statistik paket (sama dengan transaksi)
            $totalPackages = $totalTransactions;
            $activePackages = $confirmedTransactions;

            return response()->json([
                'success' => true,
                'message' => 'Data dashboard berhasil diambil',
                'data' => [
                    'user' => [
                        'id_user' => $user->id_user,
                        'nama' => $user->nama,
                        'email' => $user->email,
                        'username' => $user->username
                    ],
                    'staff' => $staff ? [
                        'id_staff' => $staff->id_staff,
                        'nama_staff' => $staff->nama_staff,
                        'email' => $staff->email,
                        'telepon' => $staff->telepon,
                        'nickname_staff' => $staff->nickname_staff,
                        'status_staff' => $staff->status_staff,
                        'total_kuota_iklan' => $staff->total_kuota_iklan,
                        'sisa_kuota_iklan' => $staff->sisa_kuota_iklan
                    ] : null,
                    'statistics' => [
                        'total_properties' => $totalProperties,
                        'active_properties' => $activeProperties,
                        'total_transactions' => $totalTransactions,
                        'confirmed_transactions' => $confirmedTransactions,
                        'total_packages' => $totalPackages,
                        'active_packages' => $activePackages
                    ]
                ]
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil statistik dashboard: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get recent activities for user
     *  FIXED: Menggunakan Eloquent Models instead of DB::table() (Rekomendasi #6)
     */
    public function getRecentActivities(Request $request, $id)
    {
        try {
            //  Gunakan Eloquent Model
            $user = User::find($id);
            if (!$user) {
                return response()->json([
                    'success' => false,
                    'message' => 'User tidak ditemukan'
                ], 404);
            }

            //  Gunakan Eloquent Model
            $staff = Staff::where('id_user', $id)->first();
            if (!$staff) {
                return response()->json([
                    'success' => false,
                    'message' => 'Staff tidak ditemukan'
                ], 404);
            }

            //  Gunakan Eloquent Model untuk recent properties
            $recentProperties = Property::where('id_staff', $staff->id_staff)
                ->orderBy('tanggal', 'desc')
                ->limit(5)
                ->get();

            //  Gunakan Eloquent Model dengan relationship untuk recent transactions
            $recentTransactions = TransaksiPaket::with('paketIklan')
                ->where('id_user', $id)
                ->orderBy('created_at', 'desc')
                ->limit(5)
                ->get()
                ->map(function ($transaction) {
                    return [
                        'id' => $transaction->id,
                        'kode_transaksi' => $transaction->kode_transaksi,
                        'status_pembayaran' => $transaction->status_pembayaran,
                        'bukti_pembayaran' => $transaction->bukti_pembayaran,
                        'created_at' => $transaction->created_at,
                        'updated_at' => $transaction->updated_at,
                        'nama_paket' => $transaction->paketIklan->nama_paket ?? null,
                    ];
                });

            return response()->json([
                'success' => true,
                'message' => 'Aktivitas terbaru berhasil diambil',
                'data' => [
                    'recent_properties' => $recentProperties,
                    'recent_transactions' => $recentTransactions
                ]
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil aktivitas terbaru: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get my packages for user
     *  FIXED: Menggunakan Eloquent Models instead of DB::table() (Rekomendasi #6)
     */
    public function getMyPackages(Request $request, $id)
    {
        try {
            //  Gunakan Eloquent Model
            $user = User::find($id);
            if (!$user) {
                return response()->json([
                    'success' => false,
                    'message' => 'User tidak ditemukan'
                ], 404);
            }

            //  Gunakan Eloquent Model dengan relationship
            $packages = TransaksiPaket::with('paketIklan')
                ->where('id_user', $id)
                ->orderBy('created_at', 'desc')
                ->get()
                ->map(function ($transaction) {
                    return [
                        'transaction_id' => $transaction->id,
                        'paket_id' => $transaction->paket_id,
                        'status_pembayaran' => $transaction->status_pembayaran,
                        'bukti_pembayaran' => $transaction->bukti_pembayaran,
                        'keterangan' => $transaction->keterangan,
                        'created_at' => $transaction->created_at,
                        'updated_at' => $transaction->updated_at,
                        'nama_paket' => $transaction->paketIklan->nama_paket ?? null,
                        'harga' => $transaction->paketIklan->harga ?? null,
                        'kuota_iklan' => $transaction->paketIklan->kuota_iklan ?? null,
                    ];
                });

            return response()->json([
                'success' => true,
                'message' => 'Paket saya berhasil diambil',
                'data' => $packages
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil paket saya: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get my advertisements for user
     *  FIXED: Menggunakan Eloquent Models instead of DB::table() (Rekomendasi #6)
     */
    public function getMyAdvertisements(Request $request, $id)
    {
        try {
            //  Gunakan Eloquent Model
            $user = User::find($id);
            if (!$user) {
                return response()->json([
                    'success' => false,
                    'message' => 'User tidak ditemukan'
                ], 404);
            }

            //  Gunakan Eloquent Model
            $staff = Staff::where('id_user', $id)->first();
            if (!$staff) {
                return response()->json([
                    'success' => false,
                    'message' => 'Staff tidak ditemukan'
                ], 404);
            }

            // Get user's advertisements (properties)
            $advertisements = DB::table('property_db as p')
                ->leftJoin('kategori_property as kp', 'p.id_kategori_property', '=', 'kp.id_kategori_property')
                ->leftJoin('provinsi as prov', 'p.id_provinsi', '=', 'prov.id')
                ->leftJoin('kabupaten as kab', 'p.id_kabupaten', '=', 'kab.id')
                ->leftJoin('kecamatan as kec', 'p.id_kecamatan', '=', 'kec.id')
                ->where('p.id_staff', $staff->id_staff)
                ->select(
                    'p.id_property',
                    'p.kode',
                    'p.nama_property',
                    'p.tipe',
                    'p.harga',
                    'p.lt',
                    'p.lb',
                    'p.kamar_tidur',
                    'p.kamar_mandi',
                    'p.alamat',
                    'p.status',
                    'p.view_count',
                    'p.tanggal',
                    'p.id_kategori_property',
                    'p.id_provinsi',
                    'p.id_kabupaten',
                    'p.id_kecamatan',
                    'p.lantai',
                    'p.isi',
                    'p.surat',
                    'p.jenis_sewa',
                    'kp.nama_kategori_property',
                    'prov.nama as nama_provinsi',
                    'kab.nama as nama_kabupaten',
                    'kec.nama as nama_kecamatan'
                )
                ->orderBy('p.tanggal', 'desc')
                ->get();

            // Ambil images untuk setiap properti dan ubah menjadi URL absolut
            $propertyIds = $advertisements->pluck('id_property')->toArray();
            $images = DB::table('property_img')
                ->whereIn('id_property', $propertyIds)
                ->orderBy('id_property')
                ->orderBy('index_img')
                ->get()
                ->groupBy('id_property');

            //  Fixed: Use config instead of hardcoded URL (Fix #6)
            $advertisements = $advertisements->map(function ($property) use ($images) {
                $propertyImages = $images->get($property->id_property, collect())->map(function ($img) {
                    return config('app.upload_url') . '/property/' . $img->gambar;
                })->toArray();

                $property->images = $propertyImages;
                return $property;
            });

            return response()->json([
                'success' => true,
                'message' => 'Iklan saya berhasil diambil',
                'data' => $advertisements
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil iklan saya: ' . $e->getMessage()
            ], 500);
        }
    }
}

=== END OF FILE: Http\Controllers\Api\MobileDashboardController.php ===


=== START OF FILE: Http\Controllers\Api\MobileLoginController.php ===
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Facades\Hash;

class MobileLoginController extends Controller
{
    public function login(Request $request)
    {
        $request->validate([
            "username" => "required|string",
            "password" => "required|string",
        ]);

        $user = DB::table("users")
            ->where(function ($query) use ($request) {
                $query->where("username", $request->username)
                      ->orWhere("email", $request->username);
            })
            ->first();

        if (!$user) {
            return response()->json([
                "success" => false,
                "message" => "Username atau password salah.",
            ], 401);
        }

        $passwordValid = Hash::check($request->password, $user->password);

        if (!$passwordValid && $user->password === sha1($request->password)) {
            // Password masih format lama (SHA1). Upgrade ke bcrypt setelah verifikasi berhasil.
            $passwordValid = true;
            DB::table('users')
                ->where('id_user', $user->id_user)
                ->update(['password' => Hash::make($request->password)]);
        }

        if (!$passwordValid) {
            return response()->json([
                "success" => false,
                "message" => "Username atau password salah.",
            ], 401);
        }

        if (empty($user->email_verified_at) || $user->email_verified_at == "") {
            return response()->json([
                "success" => false,
                "message" => "Email belum diverifikasi. Silakan cek email Anda.",
            ], 403);
        }

        $staff = DB::table("staff")->where("id_user", $user->id_user)->first();

        $timestamp = now()->format('YmdHis');
        $token = $user->id_user . $timestamp;

        return response()->json([
            "success" => true,
            "message" => "Login berhasil.",
            "data" => [
                "token_auth" => $token,
                "user" => [
                    "id_user" => (int) $user->id_user,
                    "username" => $user->username,
                    "nama" => $user->nama,
                    "email" => $user->email,
                    "akses_level" => $user->akses_level,
                    "staff_id" => $staff ? (int) $staff->id_staff : null,
                    "status_staff" => $staff ? $staff->status_staff : null,
                    "sisa_kuota_iklan" => $staff ? (int) $staff->sisa_kuota_iklan : 0,
                    "total_kuota_iklan" => $staff ? (int) $staff->total_kuota_iklan : 0,
                    "gambar" => $user->gambar,
                ],
            ],
        ], 200);
    }

    public function logout(Request $request)
    {
        $token = $request->header('token_auth');

        try {
            if (!empty($token)) {
                // Hapus token dari tabel api_tokens (jika tersimpan)
                DB::table('api_tokens')
                    ->where('tokens', $token)
                    ->delete();

                // Bersihkan storage berdasarkan token (untuk sinkronisasi perangkat)
                DB::table('storages')
                    ->where('token', $token)
                    ->delete();
            }
        } catch (\Exception $e) {
            Log::warning('Logout cleanup failed: ' . $e->getMessage());
        }

        return response()->json([
            "success" => true,
            "message" => "Logout berhasil.",
        ], 200);
    }

    public function logoutAll(Request $request)
    {
        return response()->json([
            "success" => true,
            "message" => "Logout semua berhasil.",
        ], 200);
    }

    public function forgotPassword(Request $request)
    {
        $request->validate([
            'email' => 'required|email'
        ]);

        $user = DB::table('users')->where('email', $request->email)->first();

        if (!$user) {
            return response()->json([
                'success' => false,
                'message' => 'Email tidak ditemukan.'
            ], 404);
        }

        $token = Str::random(60);

        DB::table('password_resets')->updateOrInsert(
            ['email' => $request->email],
            ['token' => $token, 'created_at' => now()]
        );

        try {
            Mail::to($request->email)->send(new \App\Mail\PasswordResetEmail($request->email, $token));
        } catch (\Exception $e) {
            Log::error('Password reset email failed: '.$e->getMessage());
        }

        return response()->json([
            'success' => true,
            'message' => 'Link reset password telah dikirim ke email.'
        ], 200);
    }

    public function resetPassword(Request $request)
    {
        $request->validate([
            'token' => 'required|string',
            'email' => 'required|email',
            'password' => 'required|string|min:6',
            'password_confirmation' => 'required|string|min:6|same:password'
        ]);

        $reset = DB::table('password_resets')
            ->where('email', $request->email)
            ->where('token', $request->token)
            ->first();

        if (!$reset) {
            return response()->json([
                'success' => false,
                'message' => 'Token reset tidak valid.'
            ], 400);
        }

        DB::table('users')
            ->where('email', $request->email)
            ->update(['password' => Hash::make($request->password)]);

        DB::table('password_resets')
            ->where('email', $request->email)
            ->delete();

        return response()->json([
            'success' => true,
            'message' => 'Password berhasil direset.'
        ], 200);
    }
}

=== END OF FILE: Http\Controllers\Api\MobileLoginController.php ===


=== START OF FILE: Http\Controllers\Api\MobilePackageController.php ===
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class MobilePackageController extends Controller
{
    // Method untuk mendapatkan paket yang tersedia
    public function getAvailablePackages()
    {
        $packages = DB::table('paket_iklan')
            ->where('is_active', 1)
            ->orderBy('harga', 'asc')
            ->get();

        // Transform data untuk konsistensi dengan mobile app
        $transformedPackages = $packages->map(function($package) {
            return [
                'id' => (int) $package->id,
                'nama_paket' => $package->nama_paket,
                'harga' => (int) $package->harga,
                'kuota_iklan' => (int) $package->kuota_iklan,
                'deskripsi' => $package->deskripsi,
                'is_active' => (bool) $package->is_active
            ];
        });

        return response()->json([
            'success' => true,
            'message' => 'Daftar paket berhasil diambil',
            'data' => $transformedPackages
        ], 200);
    }

    // Method untuk mendapatkan paket yang dibeli user
    //  Fixed: Changed to accept $id parameter from route instead of Request body (Fix #3)
    public function getMyPackages($id)
    {
        $userId = $id;
        
        // Get staff quota info
        $staff = DB::table('staff')
            ->where('id_user', $userId)
            ->select('total_kuota_iklan', 'sisa_kuota_iklan', 'status_staff')
            ->first();
        
        $packages = DB::table('transaksi_paket as tp')
            ->join('paket_iklan as p', 'tp.paket_id', '=', 'p.id')
            ->where('tp.id_user', $userId)
            ->select('tp.*', 'p.nama_paket', 'p.harga', 'p.kuota_iklan')
            ->orderBy('tp.created_at', 'desc')
            ->get();

        // Transform data untuk konsistensi dengan mobile app
        $transformedPackages = $packages->map(function ($package) use ($staff) {
            return [
                'id' => (int) $package->id,
                'id_user' => (int) $package->id_user,
                'id_staff' => (int) $package->id_staff,
                'paket_id' => (int) $package->paket_id,
                'kode_transaksi' => $package->kode_transaksi,
                'status_pembayaran' => $package->status_pembayaran,
                'bukti_pembayaran' => $package->bukti_pembayaran,
                'keterangan' => $package->keterangan,
                'created_at' => $package->created_at,
                'updated_at' => $package->updated_at,
                'nama_paket' => $package->nama_paket,
                'harga' => (int) $package->harga,
                'kuota_iklan' => (int) $package->kuota_iklan,
                'sisa_kuota_iklan' => $staff ? (int) $staff->sisa_kuota_iklan : 0,
                'total_kuota_iklan' => $staff ? (int) $staff->total_kuota_iklan : 0,
                'status_staff' => $staff ? $staff->status_staff : 'Tidak'
            ];
        });

        return response()->json([
            'success' => true,
            'message' => 'Daftar paket user berhasil diambil',
            'data' => $transformedPackages
        ], 200);
    }

    // Method untuk membeli paket
    public function buyPackage(Request $request)
    {
        $request->validate([
            'id_user' => 'required|integer',
            'paket_id' => 'required|exists:paket_iklan,id',
            'bukti_pembayaran' => 'nullable|file|image|mimes:jpeg,png,jpg|max:2048'
        ]);

        $userId = $request->id_user;
        
        // Get staff ID from user
        $staff = DB::table('staff')->where('id_user', $userId)->first();
        if (!$staff) {
            return response()->json([
                'success' => false,
                'message' => 'Staff tidak ditemukan untuk user ini.'
            ], 404);
        }
        $staffId = $staff->id_staff;

        // Upload bukti pembayaran (optional)
        $filename = null;
        if ($request->hasFile('bukti_pembayaran')) {
            $file = $request->file('bukti_pembayaran');
            $filename = Str::slug($userId . '-' . time()) . '.' . $file->getClientOriginalExtension();
            $file->move(public_path('assets/upload/bukti/'), $filename);
        }

        // Buat transaksi
        //  Fixed: Added required 'keterangan' field (Fix #4)
        $transactionId = DB::table('transaksi_paket')->insertGetId([
            'id_user' => $userId,
            'id_staff' => $staffId,
            'paket_id' => $request->paket_id,
            'kode_transaksi' => 'WPM-' . strtoupper(Str::random(8)),
            'status_pembayaran' => 'pending',
            'bukti_pembayaran' => $filename,
            'keterangan' => $request->keterangan ?? 'Pembelian paket iklan',  //  Added
            'created_at' => now(),
            'updated_at' => now()
        ]);

        return response()->json([
            'success' => true,
            'message' => 'Pembelian paket berhasil. Menunggu konfirmasi admin.',
            'data' => [
                'transaction_id' => (int) $transactionId
            ]
        ], 200);
    }

    // Method untuk reupload bukti pembayaran
    public function reuploadPaymentProof(Request $request)
    {
        $request->validate([
            'id_user' => 'required|integer',
            'transaction_id' => 'required|exists:transaksi_paket,id',
            'bukti_pembayaran' => 'required|file|image|mimes:jpeg,png,jpg|max:2048'
        ]);

        $userId = $request->id_user;
        
        // Cek apakah transaksi milik user
        $transaction = DB::table('transaksi_paket')
            ->where('id', $request->transaction_id)
            ->where('id_user', $userId)
            ->first();

        if (!$transaction) {
            return response()->json([
                'success' => false,
                'message' => 'Transaksi tidak ditemukan.'
            ], 404);
        }

        // Upload bukti pembayaran baru
        $file = $request->file('bukti_pembayaran');
        $filename = Str::slug($userId . '-' . time()) . '.' . $file->getClientOriginalExtension();
        $file->move(public_path('assets/upload/bukti/'), $filename);

        // Update transaksi
        DB::table('transaksi_paket')
            ->where('id', $request->transaction_id)
            ->update([
                'bukti_pembayaran' => $filename,
                'status_pembayaran' => 'pending',
                'updated_at' => now()
            ]);

        return response()->json([
            'success' => true,
            'message' => 'Bukti pembayaran berhasil diupload ulang.'
        ], 200);
    }

    // Method untuk mendapatkan transaksi user
    public function getTransactions(Request $request)
    {
        $request->validate([
            'id_user' => 'required|integer'
        ]);

        $userId = $request->id_user;
        
        $transactions = DB::table('transaksi_paket as tp')
            ->join('paket_iklan as p', 'tp.paket_id', '=', 'p.id')
            ->where('tp.id_user', $userId)
            ->select('tp.*', 'p.nama_paket', 'p.harga', 'p.kuota_iklan')
            ->orderBy('tp.created_at', 'desc')
            ->get();

        // Transform data untuk konsistensi dengan mobile app
        $transformedTransactions = $transactions->map(function($transaction) {
            return [
                'id' => (int) $transaction->id,
                'id_user' => (int) $transaction->id_user,
                'id_staff' => (int) $transaction->id_staff,
                'paket_id' => (int) $transaction->paket_id,
                'kode_transaksi' => $transaction->kode_transaksi,
                'status_pembayaran' => $transaction->status_pembayaran,
                'bukti_pembayaran' => $transaction->bukti_pembayaran,
                'keterangan' => $transaction->keterangan,
                'created_at' => $transaction->created_at,
                'updated_at' => $transaction->updated_at,
                'nama_paket' => $transaction->nama_paket,
                'harga' => (int) $transaction->harga,
                'kuota_iklan' => (int) $transaction->kuota_iklan
            ];
        });

        return response()->json([
            'success' => true,
            'message' => 'Daftar transaksi berhasil diambil',
            'data' => $transformedTransactions
        ], 200);
    }

    // Method untuk update transaction
    public function updateTransaction(Request $request, $id)
    {
        try {
            $request->validate([
                'id_user' => 'required|integer',
                'paket_id' => 'required|integer',
                'kode_transaksi' => 'required|string|max:255',
                'keterangan' => 'nullable|string',
                'bukti_pembayaran' => 'nullable|file|image|mimes:jpeg,png,jpg|max:2048'
            ]);

            $userId = $request->id_user;
            
            // Check if transaction exists and belongs to user
            $transaction = DB::table('transaksi_paket')
                ->where('id', $id)
                ->where('id_user', $userId)
                ->first();

            if (!$transaction) {
                return response()->json([
                    'success' => false,
                    'message' => 'Transaksi tidak ditemukan atau tidak memiliki akses'
                ], 404);
            }

            // Prepare update data
            $updateData = [
                'paket_id' => $request->paket_id,
                'kode_transaksi' => $request->kode_transaksi,
                'keterangan' => $request->keterangan,
                'updated_at' => now()
            ];

            // Upload bukti pembayaran jika ada
            if ($request->hasFile('bukti_pembayaran')) {
                $file = $request->file('bukti_pembayaran');
                $filename = Str::slug($userId . '-' . time()) . '.' . $file->getClientOriginalExtension();
                $file->move(public_path('assets/upload/bukti/'), $filename);
                $updateData['bukti_pembayaran'] = $filename;
            }

            // Update transaction
            DB::table('transaksi_paket')
                ->where('id', $id)
                ->update($updateData);

            return response()->json([
                'success' => true,
                'message' => 'Transaksi berhasil diperbarui'
            ], 200);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal memperbarui transaksi',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    // ========================================
    // PUBLIC ROUTES (No Authentication Required)
    // ========================================

    /**
     * Menampilkan daftar paket iklan untuk public
     */
    public function index()
    {
        try {
            $packages = DB::table('paket_iklan')
                ->where('is_active', 1)
                ->orderBy('harga', 'asc')
                ->get();

            // Transform data untuk konsistensi dengan mobile app
            $transformedPackages = $packages->map(function($package) {
                return [
                    'id' => (int) $package->id,
                    'nama_paket' => $package->nama_paket,
                    'harga' => (int) $package->harga,
                    'kuota_iklan' => (int) $package->kuota_iklan,
                    'deskripsi' => $package->deskripsi,
                    'is_active' => (bool) $package->is_active
                ];
            });

            return response()->json([
                'success' => true,
                'message' => 'Daftar paket iklan berhasil diambil',
                'data' => $transformedPackages
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil daftar paket iklan',
                'error' => $e->getMessage()
            ], 500);
        }
    }
}

=== END OF FILE: Http\Controllers\Api\MobilePackageController.php ===


=== START OF FILE: Http\Controllers\Api\MobilePropertyController.php ===
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;
use Carbon\Carbon;
use App\Services\WaisakaAiService;

class MobilePropertyController extends Controller
{
    /**
     * Helper function untuk mengecek apakah user sudah memiliki transaksi paket yang dikonfirmasi
     */
    private function checkConfirmedTransaction($userId)
    {
        return DB::table('transaksi_paket')
            ->where('id_user', $userId)
            ->where('status_pembayaran', 'confirmed')
            ->exists();
    }

    /**
     * Helper function untuk transformasi data properti yang konsisten
     */
    private function transformPropertyData($property, $images = null)
    {
        $propertyImages = [];
        if ($images) {
            $propertyImages = $images->get($property->id_property, collect())->map(function($img) {
                return [
                    'gambar' => asset('assets/upload/property/' . $img->gambar),
                    'index_img' => (int) $img->index_img
                ];
            })->toArray();
        }

        // Parse peta_map dari JSON string ke object
        $petaMapData = null;
        if (!empty($property->peta_map ?? '')) {
            $decoded = json_decode($property->peta_map, true);
            if (json_last_error() === JSON_ERROR_NONE && is_array($decoded)) {
                $petaMapData = [
                    'latitude' => $decoded['latitude'] ?? null,
                    'longitude' => $decoded['longitude'] ?? null,
                    'maps_query' => $decoded['maps_query'] ?? ''
                ];
            }
        }

        return [
            'id_property' => (int) $property->id_property,
            'kode' => $property->kode ?? '',
            'nama_property' => $property->nama_property ?? '',
            'tipe' => $property->tipe ?? '',
            'harga' => (int) ($property->harga ?? 0),
            'lt' => $property->lt ? (int) $property->lt : null,
            'lb' => $property->lb ? (int) $property->lb : null,
            'kamar_tidur' => (int) ($property->kamar_tidur ?? 0),
            'kamar_mandi' => (int) ($property->kamar_mandi ?? 0),
            'alamat' => $property->alamat ?? '',
            'view_count' => (int) ($property->view_count ?? 0),
            'created_at' => $property->created_at ?? $property->tanggal ?? null,
            'updated_at' => $property->updated_at ?? $property->tanggal ?? null,
            'id_kategori_property' => isset($property->id_kategori_property) ? (int) $property->id_kategori_property : null,
            'id_provinsi' => isset($property->id_provinsi) ? (int) $property->id_provinsi : null,
            'id_kabupaten' => isset($property->id_kabupaten) ? (int) $property->id_kabupaten : null,
            'id_kecamatan' => isset($property->id_kecamatan) ? (int) $property->id_kecamatan : null,
            'nama_kategori_property' => $property->nama_kategori_property ?? '',
            'nama_provinsi' => $property->nama_provinsi ?? '',
            'nama_kabupaten' => $property->nama_kabupaten ?? '',
            'nama_kecamatan' => $property->nama_kecamatan ?? '',
            'images' => $propertyImages,
            // Field tambahan dari database property_db
            'slug_property' => $property->slug_property ?? '',
            'surat' => $property->surat ?? 'SHM',
            'lantai' => $property->lantai ? (int) $property->lantai : 1,
            'jenis_sewa' => $property->jenis_sewa ?? '',
            'status' => (int) ($property->status ?? 0),
            'isi' => $property->isi ?? '',
            'keywords' => $property->keywords ?? '',
            'nama_staff' => $property->nama_staff ?? null,
            'telepon_staff' => $property->telepon_staff ?? null,
            // AI Insights dari Waisaka AI
            'harga_rata' => $property->harga_rata ?? null,
            'fasilitas_terdekat' => $property->fasilitas_terdekat ?? null,
            'peta_map' => $petaMapData
        ];
    }

    // ========================================
    // PUBLIC ROUTES (No Authentication Required)
    // ========================================

    /**
     * Menampilkan daftar properti untuk public (home screen)
     * Disesuaikan dengan data yang sama seperti Home Controller Web
     */
    public function index(Request $request)
    {
        try {
            $page = $request->query('page', 1);
            $perPage = 10;
            $offset = ($page - 1) * $perPage;

            // Gunakan query yang sama seperti Home Controller Web
            $properties = DB::table('property_db')
                ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property', 'LEFT')
                ->join('staff', 'staff.id_staff', '=', 'property_db.id_staff', 'LEFT')
                ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi', 'LEFT')
                ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten', 'LEFT')
                ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan', 'LEFT')
                ->select(
                    'property_db.*',
                    'kategori_property.slug_kategori_property',
                    'kategori_property.nama_kategori_property',
                    'staff.nama_staff',
                    'provinsi.nama as nama_provinsi',
                    'kabupaten.nama as nama_kabupaten',
                    'kecamatan.nama as nama_kecamatan',
                    'property_db.tanggal as created_at'
                )
                ->selectRaw("(CASE WHEN property_db.status = 0 THEN CONCAT('belum ter',property_db.tipe) ELSE CONCAT('sudah ter',property_db.tipe) END) AS nama_status")
                ->selectRaw("property_db.tanggal as updated_at")
                ->where('property_db.status', 1)
                ->orderBy('property_db.tanggal', 'DESC')
                ->offset($offset)
                ->limit($perPage)
                ->get();

            // Group images for each property
            $propertyIds = $properties->pluck('id_property')->toArray();
            $images = DB::table('property_img')
                ->whereIn('id_property', $propertyIds)
                ->orderBy('id_property')
                ->orderBy('index_img')
                ->get()
                ->groupBy('id_property');

            // Transform data menggunakan helper function
            $properties = $properties->map(function($property) use ($images) {
                $transformedProperty = $this->transformPropertyData($property, $images);
                if (!empty($transformedProperty['images'])) {
                    $transformedProperty['main_image_url'] = $transformedProperty['images'][0]['gambar'];
                } else {
                    $transformedProperty['main_image_url'] = null;
                }
                return $transformedProperty;
            });

            $total = DB::table('property_db')
                ->where('status', 1)
                ->count();

            return response()->json([
                'success' => true,
                'message' => 'Daftar properti berhasil diambil',
                'data' => $properties,
                'current_page' => (int) $page,
                'last_page' => (int) ceil($total / $perPage),
                'total' => (int) $total,
                'per_page' => (int) $perPage,
                'next_page_url' => $page < ceil($total / $perPage) ? $page + 1 : null
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil daftar properti',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Menampilkan detail properti untuk public
     */
    public function show(Request $request, $id)
    {
        try {
            if (!$id || $id <= 0) {
                return response()->json([
                    'success' => false,
                    'message' => 'ID properti tidak valid.'
                ], 400);
            }

            $queryBuilder = function () use ($id) {
                return DB::table('property_db')
                    ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property', 'LEFT')
                    ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi', 'LEFT')
                    ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten', 'LEFT')
                    ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan', 'LEFT')
                    ->join('staff', 'staff.id_staff', '=', 'property_db.id_staff', 'LEFT')
                    ->select(
                        'property_db.*',
                        'kategori_property.nama_kategori_property',
                        'provinsi.nama as nama_provinsi',
                        'kabupaten.nama as nama_kabupaten',
                        'kecamatan.nama as nama_kecamatan',
                        'staff.nama_staff',
                        'staff.telepon as telepon_staff',
                        'staff.gambar as gambar_staff',
                        'property_db.tanggal as created_at',
                        'property_db.tanggal as updated_at'
                    )
                    ->where('property_db.id_property', $id)
                    ->where('property_db.status', 1);
            };

            $property = $queryBuilder()->first();

            if (!$property) {
                return response()->json([
                    'success' => false,
                    'message' => 'Properti tidak ditemukan atau belum aktif'
                ], 404);
            }

            $needsAiInsights = empty(trim($property->harga_rata ?? '')) ||
                               empty(trim($property->fasilitas_terdekat ?? '')) ||
                               empty(trim($property->peta_map ?? ''));

            if ($needsAiInsights) {
                try {
                    $this->generateAiInsights($property->id_property);
                    $property = $queryBuilder()->first();
                } catch (\Exception $e) {
                    Log::warning("AI insights generation failed for public property {$property->id_property}: " . $e->getMessage());
                }
            }

            try {
                DB::table('property_db')
                    ->where('id_property', $id)
                    ->increment('view_count');
            } catch (\Exception $e) {
                \Log::warning('Failed to increment view count for property ' . $id . ': ' . $e->getMessage());
            }

            $images = collect();
            try {
                $images = DB::table('property_img')
                    ->where('id_property', $property->id_property)
                    ->orderBy('index_img')
                    ->get()
                    ->groupBy('id_property');
            } catch (\Exception $e) {
                \Log::warning('Failed to fetch images for property ' . $id . ': ' . $e->getMessage());
            }

            $propertyData = $this->transformPropertyData($property, $images);
            $propertyData['isi'] = $property->isi ?? '';
            $propertyData['keywords'] = $property->keywords ?? '';
            $propertyData['nama_staff'] = $property->nama_staff ?? '';
            $propertyData['telepon_staff'] = $property->telepon_staff ?? '';
            $propertyData['gambar_staff'] = $property->gambar_staff ? asset('assets/upload/staff/' . $property->gambar_staff) : null;
            $propertyData['surat'] = $property->surat ?? '';
            $propertyData['jenis_sewa'] = $property->jenis_sewa ?? '';
            $propertyData['lantai'] = (int) ($property->lantai ?? 1);
            $propertyData['view_count'] = (int) ($property->view_count + 1);

            return response()->json([
                'success' => true,
                'message' => 'Detail properti berhasil diambil',
                'data' => $propertyData
            ], 200);
        } catch (\Exception $e) {
            \Log::error('Error in show method: ' . $e->getMessage());
            \Log::error('Stack trace: ' . $e->getTraceAsString());

            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil detail properti',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Mencari properti untuk public
     */
    public function search(Request $request)
    {
        try {
            $page = $request->query('page', 1);
            $perPage = 10;
            $offset = ($page - 1) * $perPage;

            $query = DB::table('property_db')
                ->where('status', 1);

            if ($request->has('tipe') && $request->tipe) {
                $query->where('tipe', $request->tipe);
            }
            if ($request->has('id_kategori_property') && $request->id_kategori_property) {
                $query->where('id_kategori_property', $request->id_kategori_property);
            }
            if ($request->has('id_provinsi') && $request->id_provinsi) {
                $query->where('id_provinsi', $request->id_provinsi);
            }
            if ($request->has('id_kabupaten') && $request->id_kabupaten) {
                $query->where('id_kabupaten', $request->id_kabupaten);
            }
            if ($request->has('id_kecamatan') && $request->id_kecamatan) {
                $query->where('id_kecamatan', $request->id_kecamatan);
            }
            if ($request->has('min_price') && $request->min_price) {
                $query->where('harga', '>=', $request->min_price);
            }
            if ($request->has('max_price') && $request->max_price) {
                $query->where('harga', '<=', $request->max_price);
            }
            if ($request->has('kamar_tidur') && $request->kamar_tidur) {
                $query->where('kamar_tidur', '>=', $request->kamar_tidur);
            }
            if ($request->has('kamar_mandi') && $request->kamar_mandi) {
                $query->where('kamar_mandi', '>=', $request->kamar_mandi);
            }
            if ($request->has('keywords') && $request->keywords) {
                $keywords = $request->keywords;
                $query->where(function($q) use ($keywords) {
                    $q->where('nama_property', 'LIKE', '%' . $keywords . '%')
                      ->orWhere('kode', 'LIKE', '%' . $keywords . '%')
                      ->orWhere('isi', 'LIKE', '%' . $keywords . '%')
                      ->orWhere('alamat', 'LIKE', '%' . $keywords . '%');
                });
            }

            $total = $query->count();

            $properties = $query->orderBy('id_property', 'DESC')
                ->offset($offset)
                ->limit($perPage)
                ->get();

            $propertyIds = $properties->pluck('id_property')->toArray();
            $images = DB::table('property_img')
                ->whereIn('id_property', $propertyIds)
                ->orderBy('id_property')
                ->orderBy('index_img')
                ->get()
                ->groupBy('id_property');

            $properties = $properties->map(function($property) use ($images) {
                return $this->transformPropertyData($property, $images);
            });

            return response()->json([
                'success' => true,
                'message' => 'Pencarian properti berhasil',
                'data' => $properties,
                'current_page' => $page,
                'last_page' => ceil($total / $perPage),
                'total' => $total,
                'per_page' => $perPage,
                'next_page_url' => $page < ceil($total / $perPage) ? $page + 1 : null
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mencari properti',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Mendapatkan kategori properti untuk public
     */
    public function getCategories()
    {
        try {
            $categories = DB::table('kategori_property')
                ->orderBy('urutan', 'ASC')
                ->get();

            return response()->json([
                'success' => true,
                'message' => 'Daftar kategori berhasil diambil',
                'data' => $categories
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil daftar kategori',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Helper function untuk mendapatkan query properti dengan join yang optimal
     */
    private function getPropertyQuery($staffId = null)
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property', 'LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi', 'LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten', 'LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan', 'LEFT')
            ->select(
                'property_db.*',
                'property_db.id_kategori_property',
                'property_db.id_provinsi',
                'property_db.id_kabupaten',
                'property_db.id_kecamatan',
                'kategori_property.nama_kategori_property',
                'provinsi.nama as nama_provinsi',
                'kabupaten.nama as nama_kabupaten',
                'kecamatan.nama as nama_kecamatan'
            );

        if ($staffId) {
            $query->where('property_db.id_staff', $staffId);
        }

        return $query;
    }

    /**
     * Menampilkan daftar properti milik user dengan pagination
     */
    public function getPropertiesPaginated(Request $request, $id)
    {
        try {
            // Ambil data staff user
            $staff = DB::table('staff')->where('id_user', $id)->first();
            if (!$staff) {
                return response()->json([
                    'success' => false,
                    'message' => 'Profil staff tidak ditemukan'
                ], 404);
            }

            // Ambil parameter pagination
            $page = $request->input('page', 1);
            $perPage = $request->input('per_page', 10);
            $tipe = $request->input('tipe');

            // Query properti dengan pagination menggunakan helper function
            $query = $this->getPropertyQuery($staff->id_staff);

            // Filter berdasarkan tipe jika ada
            if ($tipe) {
                $query->where('property_db.tipe', $tipe);
            }

            // Hitung total data
            $total = $query->count();

            // Ambil data dengan pagination
            $properties = $query->orderBy('property_db.id_property', 'DESC')
                ->offset(($page - 1) * $perPage)
                ->limit($perPage)
                ->get();

            // Group images for each property
            $propertyIds = $properties->pluck('id_property')->toArray();
            $images = DB::table('property_img')
                ->whereIn('id_property', $propertyIds)
                ->orderBy('id_property')
                ->orderBy('index_img')
                ->get()
                ->groupBy('id_property');

            // Transform data menggunakan helper function
            $properties = $properties->map(function($property) use ($images) {
                return $this->transformPropertyData($property, $images);
            });

            return response()->json([
                'success' => true,
                'message' => 'Daftar properti berhasil diambil',
                'data' => $properties,
                'pagination' => [
                    'current_page' => (int) $page,
                    'per_page' => (int) $perPage,
                    'total' => (int) $total,
                    'last_page' => (int) ceil($total / $perPage),
                    'from' => (int) (($page - 1) * $perPage + 1),
                    'to' => (int) min($page * $perPage, $total)
                ]
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil daftar properti',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Menampilkan detail properti
     */
    public function getPropertyDetail(Request $request, int $id)
    {
        try {
            // Validate property ID
            if (!$id || $id <= 0) {
                return response()->json([
                    'success' => false,
                    'message' => 'ID properti tidak valid.'
                ], 400);
            }

            // Ambil id_user dari request body atau query parameter (optional untuk marketing view)
            $userId = $request->input('id_user')
                ?? $request->input('id_user')
                ?? $request->query('id_user')
                ?? $request->query('id_user');

            // Ambil data staff user jika tersedia
            $staff = null;
            if ($userId) {
                $staff = DB::table('staff')->where('id_user', $userId)->first();
            }

            // Ambil detail properti menggunakan helper function
            $query = $this->getPropertyQuery($staff->id_staff ?? null)
                ->where('property_db.id_property', $id);

            $property = $query->first();

            if (!$property) {
                return response()->json([
                    'success' => false,
                    'message' => 'Properti tidak ditemukan'
                ], 404);
            }

            // AUTO-GENERATE AI INSIGHTS jika belum ada (background process)
            // Cek apakah ada field AI yang kosong
            $needsAiInsights = empty(trim($property->harga_rata ?? '')) ||
                               empty(trim($property->fasilitas_terdekat ?? '')) ||
                               empty(trim($property->peta_map ?? ''));

            if ($needsAiInsights) {
                // Generate AI insights di background (tidak menunggu hasil)
                // Agar response tetap cepat untuk user
                try {
                    $this->generateAiInsights($property->id_property);

                    // Refresh data property setelah AI insights di-generate
                    $property = $query->first();
                } catch (\Exception $e) {
                    // Log error tapi jangan ganggu response
                    Log::warning("AI insights generation failed for property {$property->id_property}: " . $e->getMessage());
                }
            }

            // Ambil gambar properti
            $images = DB::table('property_img')
                ->where('id_property', $property->id_property)
                ->orderBy('index_img')
                ->get()
                ->groupBy('id_property');

            // Transform data menggunakan helper function
            $propertyData = $this->transformPropertyData($property, $images);

            // Tambahkan field tambahan untuk detail
            $propertyData['nama_staff'] = $property->nama_staff ?? null;
            $propertyData['telepon_staff'] = $property->telepon_staff ?? null;

            return response()->json([
                'success' => true,
                'message' => 'Detail properti berhasil diambil',
                'property' => $propertyData
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil detail properti',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Menambah properti baru
     */
    public function createProperty(Request $request)
    {
        try {
            // Ambil id_user dari request body atau query parameter
            $userId = $request->input('id_user') ?? $request->query('id_user');
            
            if (!$userId) {
                return response()->json([
                    'success' => false,
                    'message' => 'User ID diperlukan.'
                ], 400);
            }

            // Ambil data staff user
            $staff = DB::table('staff')->where('id_user', $userId)->first();
            if (!$staff) {
                return response()->json([
                    'success' => false,
                    'message' => 'Profil staff tidak ditemukan'
                ], 404);
            }

            // Cek apakah user sudah memiliki transaksi paket yang dikonfirmasi
            if (!$this->checkConfirmedTransaction($userId)) {
                return response()->json([
                    'success' => false,
                    'message' => 'Anda belum dapat menggunakan fitur ini. Silakan tunggu konfirmasi pembelian paket iklan Anda.'
                ], 403);
            }

            // Cek apakah staff aktif
            if ($staff->status_staff !== 'Ya') {
                return response()->json([
                    'success' => false,
                    'message' => 'Akun Anda belum aktif. Silakan tunggu konfirmasi admin.'
                ], 403);
            }

            // Cek kuota iklan
            if ($staff->sisa_kuota_iklan <= 0) {
                return response()->json([
                    'success' => false,
                    'message' => 'Kuota iklan Anda telah habis. Silakan beli paket iklan baru.'
                ], 403);
            }

            // Validasi input
            $validator = Validator::make($request->all(), [
                'nama_property' => 'required|string|max:255',
                'tipe' => 'required|in:jual,sewa',
                'harga' => 'required|numeric|min:0',
                'lt' => 'required|numeric|min:0',
                'lb' => 'required|numeric|min:0',
                'kamar_tidur' => 'nullable|integer|min:0',
                'kamar_mandi' => 'nullable|integer|min:0',
                'lantai' => 'nullable|integer|min:0',
                'id_kategori_property' => 'required|exists:kategori_property,id_kategori_property',
                'id_provinsi' => 'required|exists:provinsi,id',
                'id_kabupaten' => 'required|exists:kabupaten,id',
                'id_kecamatan' => 'required|exists:kecamatan,id',
                'alamat' => 'required|string|max:500',
                'isi' => 'nullable|string',
                'keywords' => 'nullable|string|max:255',
                'surat' => 'nullable|string|max:50',
                'jenis_sewa' => 'nullable|string|max:50',
                'gambar' => 'nullable|array|max:10',
                'gambar.*' => 'image|mimes:jpeg,png,jpg|max:2048'
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Validasi gagal',
                    'errors' => $validator->errors()
                ], 422);
            }

            // Generate kode dan slug
            $kode = 'WPS' . str_pad(DB::table('property_db')->count() + 1, 3, '0', STR_PAD_LEFT);
            $slug_property = Str::slug($request->nama_property);

            // Simpan properti
            $propertyId = DB::table('property_db')->insertGetId([
                'id_kategori_property' => $request->id_kategori_property,
                'kode' => $kode,
                'slug_property' => $slug_property,
                'nama_property' => $request->nama_property,
                'tipe' => $request->tipe,
                'jenis_sewa' => $request->jenis_sewa ?? 'tahun',
                'harga' => $request->harga,
                'status' => 0,
                'surat' => $request->surat ?? 'SHM',
                'lt' => $request->lt,
                'lb' => $request->lb,
                'isi' => $request->isi ?? '',
                'kamar_tidur' => $request->kamar_tidur ?? 0,
                'kamar_mandi' => $request->kamar_mandi ?? 0,
                'lantai' => $request->lantai ?? 1,
                'id_staff' => $staff->id_staff,
                'alamat' => $request->alamat,
                'id_provinsi' => $request->id_provinsi,
                'id_kabupaten' => $request->id_kabupaten,
                'id_kecamatan' => $request->id_kecamatan,
                'keywords' => $request->keywords ?? ''
            ]);

            // Upload gambar (optional)
            $images = $request->file('gambar');
            if ($images && is_array($images)) {
                foreach ($images as $key => $image) {
                    if (!empty($image)) {
                    $filename = Str::slug(pathinfo($image->getClientOriginalName(), PATHINFO_FILENAME), '-') . '-' . time() . $key . '.' . $image->getClientOriginalExtension();
                    $destinationPath = public_path('assets/upload/property/');
                    $image->move($destinationPath, $filename);

                    DB::table('property_img')->insert([
                        'id_property' => $propertyId,
                        'gambar' => $filename,
                        'index_img' => $key
                    ]);
                    }
                }
            }

            // Kurangi kuota iklan
            DB::table('staff')
                ->where('id_staff', $staff->id_staff)
                ->update([
                    'sisa_kuota_iklan' => DB::raw('sisa_kuota_iklan - 1')
                ]);

            // AUTO-GENERATE AI INSIGHTS (Harga Rata, Fasilitas Terdekat, Peta Map)
            $this->generateAiInsights($propertyId);

            return response()->json([
                'success' => true,
                'message' => 'Properti berhasil ditambahkan',
                'data' => [
                    'property_id' => $propertyId,
                    'kode' => $request->kode,
                    'nama_property' => $request->nama_property,
                    'sisa_kuota_iklan' => $staff->sisa_kuota_iklan - 1
                ]
            ], 201);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal menambah properti',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Mengupdate properti
     */
    public function updateProperty(Request $request, $id)
    {
        try {
            // Ambil id_user dari request body atau query parameter
            $userId = $request->input('id_user') ?? $request->query('id_user');
            
            if (!$userId) {
                return response()->json([
                    'success' => false,
                    'message' => 'User ID diperlukan.'
                ], 400);
            }

            // Ambil data staff user
            $staff = DB::table('staff')->where('id_user', $userId)->first();
            if (!$staff) {
                return response()->json([
                    'success' => false,
                    'message' => 'Profil staff tidak ditemukan'
                ], 404);
            }

            // Cek apakah user sudah memiliki transaksi paket yang dikonfirmasi
            if (!$this->checkConfirmedTransaction($userId)) {
                return response()->json([
                    'success' => false,
                    'message' => 'Anda belum dapat menggunakan fitur ini. Silakan tunggu konfirmasi pembelian paket iklan Anda.'
                ], 403);
            }

            // Cek apakah properti milik staff
            $property = DB::table('property_db')
                ->where('id_property', $id)
                ->where('id_staff', $staff->id_staff)
                ->first();

            if (!$property) {
                return response()->json([
                    'success' => false,
                    'message' => 'Properti tidak ditemukan'
                ], 404);
            }

            // Validasi input
            $validator = Validator::make($request->all(), [
                'nama_property' => 'nullable|string|max:255',
                'tipe' => 'nullable|in:jual,sewa',
                'harga' => 'nullable|numeric|min:0',
                'lt' => 'nullable|numeric|min:0',
                'lb' => 'nullable|numeric|min:0',
                'kamar_tidur' => 'nullable|integer|min:0',
                'kamar_mandi' => 'nullable|integer|min:0',
                'lantai' => 'nullable|integer|min:0',
                'id_kategori_property' => 'nullable|exists:kategori_property,id_kategori_property',
                'id_provinsi' => 'nullable|exists:provinsi,id',
                'id_kabupaten' => 'nullable|exists:kabupaten,id',
                'id_kecamatan' => 'nullable|exists:kecamatan,id',
                'alamat' => 'nullable|string|max:500',
                'isi' => 'nullable|string',
                'keywords' => 'nullable|string|max:255',
                'surat' => 'nullable|string|max:50',
                'jenis_sewa' => 'nullable|string|max:50',
                'gambar' => 'nullable|array|max:10',
                'gambar.*' => 'image|mimes:jpeg,png,jpg|max:2048'
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Validasi gagal',
                    'errors' => $validator->errors()
                ], 422);
            }

            // Update properti - hanya field yang diisi
            $updateData = [];
            
            if ($request->filled('nama_property')) {
                $updateData['nama_property'] = $request->nama_property;
                $updateData['slug_property'] = Str::slug($request->nama_property);
            }
            if ($request->filled('tipe')) {
                $updateData['tipe'] = $request->tipe;
            }
            if ($request->filled('harga')) {
                $updateData['harga'] = $request->harga;
            }
            if ($request->filled('lt')) {
                $updateData['lt'] = $request->lt;
            }
            if ($request->filled('lb')) {
                $updateData['lb'] = $request->lb;
            }
            if ($request->filled('kamar_tidur')) {
                $updateData['kamar_tidur'] = $request->kamar_tidur;
            }
            if ($request->filled('kamar_mandi')) {
                $updateData['kamar_mandi'] = $request->kamar_mandi;
            }
            if ($request->filled('lantai')) {
                $updateData['lantai'] = $request->lantai;
            }
            if ($request->filled('id_kategori_property')) {
                $updateData['id_kategori_property'] = $request->id_kategori_property;
            }
            if ($request->filled('id_provinsi')) {
                $updateData['id_provinsi'] = $request->id_provinsi;
            }
            if ($request->filled('id_kabupaten')) {
                $updateData['id_kabupaten'] = $request->id_kabupaten;
            }
            if ($request->filled('id_kecamatan')) {
                $updateData['id_kecamatan'] = $request->id_kecamatan;
            }
            if ($request->filled('alamat')) {
                $updateData['alamat'] = $request->alamat;
            }
            if ($request->filled('isi')) {
                $updateData['isi'] = $request->isi;
            }
            if ($request->filled('keywords')) {
                $updateData['keywords'] = $request->keywords;
            }
            if ($request->filled('surat')) {
                $updateData['surat'] = $request->surat;
            }
            if ($request->filled('jenis_sewa')) {
                $updateData['jenis_sewa'] = $request->jenis_sewa;
            }

            if (!empty($updateData)) {
                DB::table('property_db')
                    ->where('id_property', $id)
                    ->update($updateData);
            }

            // Update gambar jika ada
            if ($request->hasFile('gambar')) {
                $images = $request->file('gambar');
                foreach ($images as $key => $image) {
                    if (!empty($image)) {
                        $filename = Str::slug(pathinfo($image->getClientOriginalName(), PATHINFO_FILENAME), '-') . '-' . time() . $key . '.' . $image->getClientOriginalExtension();
                        $destinationPath = public_path('assets/upload/property/');
                        $image->move($destinationPath, $filename);

                        DB::table('property_img')->updateOrInsert([
                            'id_property' => $id,
                            'index_img' => $key
                        ], [
                            'gambar' => $filename
                        ]);
                    }
                }
            }

            // AUTO-GENERATE AI INSIGHTS (Harga Rata, Fasilitas Terdekat, Peta Map)
            // Hanya generate jika field masih kosong
            $this->generateAiInsights($id);

            return response()->json([
                'success' => true,
                'message' => 'Properti berhasil diperbarui',
                'data' => [
                    'property_id' => $id,
                    'kode' => $request->kode,
                    'nama_property' => $request->nama_property
                ]
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal memperbarui properti',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Menghapus properti
     */
    public function deleteProperty(Request $request, $id)
    {
        try {
            // Ambil id_user dari request body atau query parameter
            $userId = $request->input('id_user') ?? $request->query('id_user');
            
            if (!$userId) {
                return response()->json([
                    'success' => false,
                    'message' => 'User ID diperlukan.'
                ], 400);
            }

            // Ambil data staff user
            $staff = DB::table('staff')->where('id_user', $userId)->first();
            if (!$staff) {
                return response()->json([
                    'success' => false,
                    'message' => 'Profil staff tidak ditemukan'
                ], 404);
            }

            // Cek apakah user sudah memiliki transaksi paket yang dikonfirmasi
            if (!$this->checkConfirmedTransaction($userId)) {
                return response()->json([
                    'success' => false,
                    'message' => 'Anda belum dapat menggunakan fitur ini. Silakan tunggu konfirmasi pembelian paket iklan Anda.'
                ], 403);
            }

            // Cek apakah properti milik staff
            $property = DB::table('property_db')
                ->where('id_property', $id)
                ->where('id_staff', $staff->id_staff)
                ->first();

            if (!$property) {
                return response()->json([
                    'success' => false,
                    'message' => 'Properti tidak ditemukan'
                ], 404);
            }

            // Hapus gambar
            $images = DB::table('property_img')->where('id_property', $id)->get();
            foreach ($images as $image) {
                $filePath = public_path('assets/upload/property/' . $image->gambar);
                if (file_exists($filePath)) {
                    unlink($filePath);
                }
            }

            // Hapus data
            DB::table('property_img')->where('id_property', $id)->delete();
            DB::table('property_db')->where('id_property', $id)->delete();

            // Tambah kembali kuota iklan
            DB::table('staff')
                ->where('id_staff', $staff->id_staff)
                ->update([
                    'sisa_kuota_iklan' => DB::raw('sisa_kuota_iklan + 1')
                ]);

            return response()->json([
                'success' => true,
                'message' => 'Properti berhasil dihapus',
                'data' => [
                    'property_id' => $id,
                    'sisa_kuota_iklan' => $staff->sisa_kuota_iklan + 1
                ]
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal menghapus properti',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Mencari properti
     */
    public function searchProperties(Request $request)
    {
        try {
            // Ambil id_user dari request body atau query parameter
            $userId = $request->input('id_user') ?? $request->query('id_user');
            
            if (!$userId) {
                return response()->json([
                    'success' => false,
                    'message' => 'User ID diperlukan.'
                ], 400);
            }

            // Ambil data staff user
            $staff = DB::table('staff')->where('id_user', $userId)->first();
            if (!$staff) {
                return response()->json([
                    'success' => false,
                    'message' => 'Profil staff tidak ditemukan'
                ], 404);
            }

            $keywords = $request->keywords ?? '';
            $tipe = $request->tipe ?? '';

            // Query properti menggunakan helper function
            $query = $this->getPropertyQuery($staff->id_staff);

            if ($keywords) {
                $query->where(function($q) use ($keywords) {
                    $q->where('property_db.nama_property', 'LIKE', '%' . $keywords . '%')
                      ->orWhere('property_db.kode', 'LIKE', '%' . $keywords . '%')
                      ->orWhere('property_db.isi', 'LIKE', '%' . $keywords . '%');
                });
            }

            if ($tipe && $tipe !== 'all') {
                $query->where('property_db.tipe', $tipe);
            }

            $properties = $query->orderBy('property_db.id_property', 'DESC')->get();

            // Group images for each property
            $propertyIds = $properties->pluck('id_property')->toArray();
                $images = DB::table('property_img')
                ->whereIn('id_property', $propertyIds)
                ->orderBy('id_property')
                    ->orderBy('index_img')
                ->get()
                ->groupBy('id_property');

            // Transform data menggunakan helper function
            $properties = $properties->map(function($property) use ($images) {
                $transformedProperty = $this->transformPropertyData($property, $images);
                if (!empty($transformedProperty['images'])) {
                    $transformedProperty['main_image_url'] = $transformedProperty['images'][0]['gambar'];
                } else {
                    $transformedProperty['main_image_url'] = null;
                }
                return $transformedProperty;
            });

            return response()->json([
                'success' => true,
                'message' => 'Pencarian properti berhasil',
                'data' => $properties
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mencari properti',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Mendapatkan data master untuk form
     */
    public function getMasterData(Request $request)
    {
        try {
            $kategori_property = DB::table('kategori_property')->orderBy('urutan', 'ASC')->get();
            $provinsi = DB::table('provinsi')->orderBy('nama', 'ASC')->get();

            return response()->json([
                'success' => true,
                'message' => 'Data master berhasil diambil',
                'data' => [
                    'kategori_property' => $kategori_property,
                    'provinsi' => $provinsi
                ]
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil data master',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Mendapatkan kabupaten berdasarkan provinsi
     */
    public function getKabupaten(Request $request, $provinsiId)
    {
        try {
            $kabupaten = DB::table('kabupaten')
                ->where('id_provinsi', $provinsiId)
                ->orderBy('nama', 'ASC')
                ->get();

            return response()->json([
                'success' => true,
                'message' => 'Daftar kabupaten berhasil diambil',
                'data' => $kabupaten
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil daftar kabupaten',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Mendapatkan kecamatan berdasarkan kabupaten
     */
    public function getKecamatan(Request $request, $kabupatenId)
    {
        try {
            $kecamatan = DB::table('kecamatan')
                ->where('id_kabupaten', $kabupatenId)
                ->orderBy('nama', 'ASC')
                ->get();

            return response()->json([
                'success' => true,
                'message' => 'Daftar kecamatan berhasil diambil',
                'data' => $kecamatan
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil daftar kecamatan',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Generate AI insights untuk property (Harga Rata, Fasilitas Terdekat, Peta Map)
     * Dipanggil saat tambah atau edit property dari Flutter app
     */
    protected function generateAiInsights($id_property)
    {
        try {
            // Ambil data property lengkap
            $property = DB::table('property_db')
                ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property', 'LEFT')
                ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi', 'LEFT')
                ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten', 'LEFT')
                ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan', 'LEFT')
                ->select(
                    'property_db.*',
                    'kategori_property.nama_kategori_property',
                    'provinsi.nama as nama_provinsi',
                    'kabupaten.nama as nama_kabupaten',
                    'kecamatan.nama as nama_kecamatan'
                )
                ->where('property_db.id_property', $id_property)
                ->first();

            if (!$property) {
                Log::warning("Property tidak ditemukan untuk AI insights: ID {$id_property}");
                return;
            }

            $aiService = app(WaisakaAiService::class);
            $updateData = [];

            // 1. Generate Harga Rata-rata (jika belum ada)
            if (empty(trim($property->harga_rata ?? ''))) {
                $hargaRata = $this->getHargaRata($property, $aiService);
                if ($hargaRata) {
                    $updateData['harga_rata'] = $hargaRata;
                    Log::info("AI Harga Rata generated untuk property ID {$id_property}");
                }
            }

            // 2. Generate Fasilitas Terdekat (jika belum ada)
            if (empty(trim($property->fasilitas_terdekat ?? ''))) {
                $fasilitasTerdekat = $this->getFasilitasTerdekat($property, $aiService);
                if ($fasilitasTerdekat) {
                    $updateData['fasilitas_terdekat'] = $fasilitasTerdekat;
                    Log::info("AI Fasilitas Terdekat generated untuk property ID {$id_property}");
                }
            }

            // 3. Generate Peta Map (jika belum ada)
            if (empty(trim($property->peta_map ?? ''))) {
                $petaMap = $this->getPetaMap($property, $aiService);
                if ($petaMap) {
                    $updateData['peta_map'] = $petaMap;
                    Log::info("AI Peta Map generated untuk property ID {$id_property}");
                }
            }

            // Update database jika ada data yang di-generate
            if (!empty($updateData)) {
                DB::table('property_db')
                    ->where('id_property', $id_property)
                    ->update($updateData);

                Log::info("AI Insights berhasil disimpan untuk property ID {$id_property}", $updateData);
            }

        } catch (\Exception $e) {
            // Log error tapi jangan stop proses utama
            Log::error("Error generating AI insights untuk property ID {$id_property}: " . $e->getMessage(), [
                'exception' => $e,
                'trace' => $e->getTraceAsString()
            ]);
        }
    }

    /**
     * Get Harga Rata-rata dari AI Waisaka
     */
    protected function getHargaRata($property, WaisakaAiService $aiService)
    {
        try {
            $tipe = $property->tipe ?? 'Jual';
            $kategori = $property->nama_kategori_property ?? 'Properti';

            // Susun alamat lengkap
            $addressParts = array_filter([
                $property->alamat,
                $property->nama_kecamatan,
                $property->nama_kabupaten,
                $property->nama_provinsi
            ]);
            $alamatLengkap = implode(', ', $addressParts);

            if (empty($alamatLengkap)) {
                return null;
            }

            $hargaListing = is_numeric($property->harga ?? null) ? (float) $property->harga : null;
            $luasTanah = is_numeric($property->lt ?? null) ? (int) $property->lt : null;
            $luasBangunan = is_numeric($property->lb ?? null) ? (int) $property->lb : null;

            // Panggil AI Service
            $priceSummary = $aiService->getAveragePriceSummary(
                $tipe,
                $kategori,
                $alamatLengkap,
                $hargaListing,
                $luasTanah,
                $luasBangunan
            );

            if (empty($priceSummary)) {
                return null;
            }

            // Bersihkan hasil
            $cleanPriceSummary = trim(strip_tags($priceSummary));

            // Jangan simpan jika data tidak tersedia
            if (Str::startsWith($cleanPriceSummary, 'Data harga pasar untuk lokasi ini belum tersedia') ||
                Str::startsWith($cleanPriceSummary, 'Data pasar untuk lokasi ini belum tersedia')) {
                return null;
            }

            return $cleanPriceSummary;

        } catch (\Exception $e) {
            Log::error("Error getHargaRata: " . $e->getMessage());
            return null;
        }
    }

    /**
     * Get Fasilitas Terdekat dari AI Waisaka
     */
    protected function getFasilitasTerdekat($property, WaisakaAiService $aiService)
    {
        try {
            // Susun alamat lengkap
            $addressParts = array_filter([
                $property->alamat,
                $property->nama_kecamatan,
                $property->nama_kabupaten,
                $property->nama_provinsi
            ]);
            $alamatLengkap = implode(', ', $addressParts);

            if (empty($alamatLengkap)) {
                return null;
            }

            // Panggil AI Service
            $summary = $aiService->getNearbyFacilitiesSummary($alamatLengkap);

            if (empty($summary)) {
                return null;
            }

            // Format to HTML list jika belum HTML
            if (stripos($summary, '<ul') === false) {
                $lines = array_filter(array_map('trim', preg_split('/\r\n|\r|\n/', strip_tags($summary))));
                if (!empty($lines)) {
                    $items = array_map(fn($line) => '<li>' . htmlspecialchars($line) . '</li>', $lines);
                    $summary = "<ul>" . implode('', $items) . "</ul>";
                }
            }

            // Jangan simpan jika data tidak tersedia
            if (stripos($summary, 'Data fasilitas untuk area ini sedang tidak tersedia') !== false ||
                stripos($summary, 'tidak tersedia') !== false) {
                return null;
            }

            return $summary;

        } catch (\Exception $e) {
            Log::error("Error getFasilitasTerdekat: " . $e->getMessage());
            return null;
        }
    }

    /**
     * Get Peta Map (koordinat) dari AI Waisaka
     */
    protected function getPetaMap($property, WaisakaAiService $aiService)
    {
        try {
            $address = $property->alamat ?? '';
            $kecamatan = $property->nama_kecamatan ?? null;
            $kabupaten = $property->nama_kabupaten ?? null;
            $provinsi = $property->nama_provinsi ?? null;

            if (empty($address)) {
                return null;
            }

            // Panggil AI Service untuk mendapatkan koordinat
            $coordinates = $aiService->getMapCoordinateSummary($address, $kecamatan, $kabupaten, $provinsi);

            if (!$coordinates || !isset($coordinates['latitude'], $coordinates['longitude'])) {
                return null;
            }

            // Format sebagai JSON string untuk disimpan di database
            return json_encode([
                'latitude' => $coordinates['latitude'],
                'longitude' => $coordinates['longitude'],
                'maps_query' => $coordinates['maps_query'] ?? ''
            ]);

        } catch (\Exception $e) {
            Log::error("Error getPetaMap: " . $e->getMessage());
            return null;
        }
    }

}

=== END OF FILE: Http\Controllers\Api\MobilePropertyController.php ===


=== START OF FILE: Http\Controllers\Api\MobileSignupController.php ===
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Carbon\Carbon;
use Illuminate\Support\Facades\Mail;
use App\Mail\VerificationEmail;

class MobileSignupController extends Controller
{
    // Method untuk signup mobile tanpa token auth
    public function signup(Request $request)
    {
        // Validasi input
        $request->validate([
            'nama'     => 'required|string|max:255',
            'username' => 'nullable|string|unique:users,username|unique:users_verification,username',
            'password' => 'required|string|min:6',
            'password_confirmation' => 'required|string|min:6|same:password',
            'email'    => 'required|email|unique:users,email|unique:users_verification,email',
            'no_hp'    => 'nullable|string|max:20',
            'telepon'  => 'nullable|string|max:20',
        ]);

        $token = Str::random(60);
        
        // Simpan ke users_verification
        $verificationId = DB::table('users_verification')->insertGetId([
            'nama'            => $request->nama,
            'email'           => $request->email,
            'username'        => $request->username ?? $request->email, // Use email as username if not provided
            'password'        => sha1($request->password),
            'telepon'         => $request->telepon ?? $request->no_hp ?? '0', // Simpan telepon dari request
            'gambar'          => null,
            'paket_id'        => 0,
            'token'           => $token,
            'tanggal_expired' => Carbon::now()->addDays(3),
            'created_at'      => now(),
            'updated_at'      => now()
        ]);

        // Kirim email verifikasi
        try {
            $user = new \stdClass();
            $user->nama = $request->nama;
            $user->email = $request->email;
            
            Mail::to($request->email)->send(new VerificationEmail($user, $token));
        } catch (\Exception $e) {
            \Log::error('Email verification failed: '.$e->getMessage());
        }

        return response()->json([
            'success' => true,
            'message' => 'Pendaftaran berhasil. Silakan cek email untuk verifikasi.',
            'data' => [
                'verification_id' => (int) $verificationId,
                'email' => $request->email
            ]
        ], 200);
    }

    // Method untuk verifikasi email
    public function verifyEmail(Request $request)
    {
        $token = $request->get('token');
        $verification_data = DB::table('users_verification')->where('token', $token)->first();

        if(!$verification_data) {
            return response()->json([
                'success' => false,
                'message' => 'Token verifikasi tidak valid.'
            ], 400);
        }

        if(Carbon::now()->gt($verification_data->tanggal_expired)) {
            DB::table('users_verification')->where('token', $token)->delete();
            return response()->json([
                'success' => false,
                'message' => 'Waktu pendaftaran sudah berakhir. Silakan daftar kembali.'
            ], 400);
        }

        // Buat user baru
        $newUserId = DB::table('users')->insertGetId([
            'nama'          => $verification_data->nama,
            'email'         => $verification_data->email,
            'username'      => $verification_data->username,
            'password'      => $verification_data->password,
            'akses_level'   => 'User',
            'tanggal'       => now()
        ]);

        // Buat data staff
        $newStaffId = DB::table('staff')->insertGetId([
            'id_user'           => $newUserId,
            'nama_staff'        => $verification_data->nama,
            'email'             => $verification_data->email,
            'telepon'           => $verification_data->telepon ?? '0',
            'status_staff'      => 'Tidak',
            'slug_staff'        => Str::slug($verification_data->nama, '-'),
            'id_kategori_staff' => 1,
            'nickname_staff'    => $verification_data->nama,
            'id_provinsi'       => 1,
            'id_kabupaten'      => 1,
            'id_kecamatan'      => 1,
            'total_kuota_iklan' => 0,
            'sisa_kuota_iklan'  => 0,
            'tanggal'           => now()
        ]);

        // Hapus data verifikasi
        DB::table('users_verification')->where('token', $token)->delete();

        return response()->json([
            'success' => true,
            'message' => 'Verifikasi berhasil! Akun Anda sudah aktif.',
            'data' => [
                'id_user' => (int) $newUserId,
                'staff_id' => (int) $newStaffId
            ]
        ], 200);
    }

    // Method untuk resend verification
    public function resendVerification(Request $request)
    {
        $request->validate([
            'email' => 'required|email'
        ]);

        $verification = DB::table('users_verification')
            ->where('email', $request->email)
            ->first();

        if(!$verification) {
            return response()->json([
                'success' => false,
                'message' => 'Email tidak ditemukan dalam data pendaftaran.'
            ], 404);
        }

        // Update token dan expired time
        $newToken = Str::random(60);
        DB::table('users_verification')
            ->where('email', $request->email)
            ->update([
                'token' => $newToken,
                'tanggal_expired' => Carbon::now()->addDays(3),
                'updated_at' => now()
            ]);

        // Kirim email ulang
        try {
            $user = new \stdClass();
            $user->nama = $verification->nama;
            $user->email = $verification->email;
            
            Mail::to($request->email)->send(new VerificationEmail($user, $newToken));
        } catch (\Exception $e) {
            \Log::error('Resend email verification failed: '.$e->getMessage());
        }

        return response()->json([
            'success' => true,
            'message' => 'Email verifikasi telah dikirim ulang.'
        ], 200);
    }

    public function resendVerificationWeb($email)
    {
        $verification = DB::table('users_verification')
            ->where('email', $email)
            ->first();

        if(!$verification) {
            return response()->json([
                'success' => false,
                'message' => 'Email tidak ditemukan dalam data pendaftaran.'
            ], 404);
        }

        $newToken = Str::random(60);
        DB::table('users_verification')
            ->where('email', $email)
            ->update([
                'token' => $newToken,
                'tanggal_expired' => Carbon::now()->addDays(3),
                'updated_at' => now()
            ]);

        try {
            $user = new \stdClass();
            $user->nama = $verification->nama;
            $user->email = $verification->email;
            Mail::to($email)->send(new VerificationEmail($user, $newToken));
        } catch (\Exception $e) {
            \Log::error('Resend email verification failed: '.$e->getMessage());
        }

        return response()->json([
            'success' => true,
            'message' => 'Email verifikasi telah dikirim ulang.'
        ], 200);
    }

    public function verifyEmailWeb(Request $request)
    {
        return $this->verifyEmail($request);
    }
}

=== END OF FILE: Http\Controllers\Api\MobileSignupController.php ===


=== START OF FILE: Http\Controllers\Api\MobileStaffController.php ===
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class MobileStaffController extends Controller
{
    /**
     * Get staff profile by ID
     */
    public function getProfile(Request $request, $id)
    {
        try {
            $staff = DB::table('staff')
                ->join('users', 'users.id_user', '=', 'staff.id_user')
                ->where('staff.id_staff', $id)
                ->select(
                    'staff.*',
                    'users.nama as user_nama',
                    'users.email as user_email',
                    'users.username as user_username'
                )
                ->first();

            if (!$staff) {
                return response()->json([
                    'success' => false,
                    'message' => 'Staff tidak ditemukan'
                ], 404);
            }

            // Transform data untuk mengembalikan URL lengkap gambar
            $staffData = (array) $staff;
            if ($staffData['gambar']) {
                $staffData['gambar'] = asset('assets/upload/staff/' . $staffData['gambar']);
            }

            return response()->json([
                'success' => true,
                'message' => 'Profil staff berhasil diambil',
                'data' => $staffData
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil profil staff: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Update staff profile
     * Menggunakan POST karena Laravel tidak support PUT multipart secara native
     */
    public function updateProfile(Request $request, $id)
    {
        try {
            // Cek apakah staff ada
            $staff = DB::table('staff')->where('id_staff', $id)->first();
            if (!$staff) {
                return response()->json([
                    'success' => false,
                    'message' => 'Staff tidak ditemukan'
                ], 404);
            }

            // Ambil data langsung dari request
            $namaStaff = trim($request->input('nama_staff', ''));
            $email = trim($request->input('email', ''));
            $telepon = trim($request->input('telepon', ''));
            $nicknameStaff = trim($request->input('nickname_staff', ''));

            // Validasi data tidak boleh kosong
            if (empty($namaStaff)) {
                return response()->json([
                    'success' => false,
                    'message' => 'Nama staff tidak boleh kosong'
                ], 400);
            }

            if (empty($email)) {
                return response()->json([
                    'success' => false,
                    'message' => 'Email tidak boleh kosong'
                ], 400);
            }

            if (empty($telepon)) {
                return response()->json([
                    'success' => false,
                    'message' => 'Telepon tidak boleh kosong'
                ], 400);
            }

            if (empty($nicknameStaff)) {
                return response()->json([
                    'success' => false,
                    'message' => 'Nickname tidak boleh kosong'
                ], 400);
            }

            // Upload gambar jika ada
            $gambarFilename = null;
            if ($request->hasFile('gambar')) {
                $gambarFile = $request->file('gambar');
                
                // Hapus gambar lama jika ada
                if ($staff->gambar && file_exists(public_path('assets/upload/staff/' . $staff->gambar))) {
                    @unlink(public_path('assets/upload/staff/' . $staff->gambar));
                }
                
                // Generate nama file yang aman
                $gambarFilename = 'staff_' . $id . '_' . time() . '.' . $gambarFile->getClientOriginalExtension();
                $gambarFile->move(public_path('assets/upload/staff/'), $gambarFilename);
            }

            // Siapkan data untuk update tabel staff
            $updateStaffData = [
                'nama_staff' => $namaStaff,
                'email' => $email,
                'telepon' => $telepon,
                'nickname_staff' => $nicknameStaff,
                'tanggal' => now()
            ];

            // Tambahkan gambar jika ada upload baru
            if ($gambarFilename) {
                $updateStaffData['gambar'] = $gambarFilename;
            }

            // Update tabel staff
            DB::table('staff')
                ->where('id_staff', $id)
                ->update($updateStaffData);

            // Sinkronisasi ke tabel users
            DB::table('users')
                ->where('id_user', $staff->id_user)
                ->update([
                    'nama' => $namaStaff,
                    'email' => $email,
                    'tanggal' => now()
                ]);

            return response()->json([
                'success' => true,
                'message' => 'Profil berhasil diperbarui'
            ], 200);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal memperbarui profil: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get staff statistics
     */
    public function getStats(Request $request, $id)
    {
        try {
            $staff = DB::table('staff')->where('id_staff', $id)->first();
            if (!$staff) {
                return response()->json([
                    'success' => false,
                    'message' => 'Staff tidak ditemukan'
                ], 404);
            }

            // Hitung statistik properti
            $totalProperties = DB::table('property_db')
                ->where('id_staff', $id)
                ->count();

            $activeProperties = DB::table('property_db')
                ->where('id_staff', $id)
                ->where('status', 1)
                ->count();

            // Hitung statistik transaksi
            $totalTransactions = DB::table('transaksi_paket')
                ->where('id_staff', $id)
                ->count();

            $confirmedTransactions = DB::table('transaksi_paket')
                ->where('id_staff', $id)
                ->where('status_pembayaran', 'confirmed')
                ->count();

            return response()->json([
                'success' => true,
                'message' => 'Statistik staff berhasil diambil',
                'data' => [
                    'staff' => [
                        'id_staff' => $staff->id_staff,
                        'nama_staff' => $staff->nama_staff,
                        'status_staff' => $staff->status_staff,
                        'total_kuota_iklan' => $staff->total_kuota_iklan,
                        'sisa_kuota_iklan' => $staff->sisa_kuota_iklan
                    ],
                    'statistics' => [
                        'total_properties' => $totalProperties,
                        'active_properties' => $activeProperties,
                        'total_transactions' => $totalTransactions,
                        'confirmed_transactions' => $confirmedTransactions
                    ]
                ]
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Gagal mengambil statistik staff: ' . $e->getMessage()
            ], 500);
        }
    }
}

=== END OF FILE: Http\Controllers\Api\MobileStaffController.php ===


=== START OF FILE: Http\Controllers\Api\MobileStorageController.php ===
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Validator;

class MobileStorageController extends Controller
{
    /**
     * Create or Update storage record
     * Jika user sudah punya storage dengan token yang sama, maka update
     * Jika belum, maka create baru
     */
    public function createOrUpdate(Request $request)
    {
        try {
            // Validasi input
            $validator = Validator::make($request->all(), [
                'id_user' => 'required|integer',
                'token' => 'required|string|max:250',
                'device_info' => 'required|string|max:250',
                'ip_address' => 'required|string|max:250',
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Validasi gagal',
                    'errors' => $validator->errors()
                ], 400);
            }

            $idUser = $request->id_user;
            $token = $request->token;
            $deviceInfo = $request->device_info;
            $ipAddress = $request->ip_address;
            $date = now();

            // Cek apakah user sudah punya storage dengan token ini
            $existingStorage = DB::table('storages')
                ->where('id_user', $idUser)
                ->where('token', $token)
                ->first();

            if ($existingStorage) {
                // Update existing storage
                DB::table('storages')
                    ->where('id_storages', $existingStorage->id_storages)
                    ->update([
                        'device_info' => $deviceInfo,
                        'ip_address' => $ipAddress,
                        'date' => $date,
                    ]);

                return response()->json([
                    'success' => true,
                    'message' => 'Storage berhasil diupdate',
                    'data' => [
                        'id_storages' => $existingStorage->id_storages,
                        'id_user' => $idUser,
                        'token' => $token,
                        'device_info' => $deviceInfo,
                        'ip_address' => $ipAddress,
                        'date' => $date->format('Y-m-d H:i:s'),
                    ]
                ], 200);
            } else {
                // Create new storage
                $idStorages = DB::table('storages')->insertGetId([
                    'id_user' => $idUser,
                    'token' => $token,
                    'device_info' => $deviceInfo,
                    'ip_address' => $ipAddress,
                    'date' => $date,
                ]);

                return response()->json([
                    'success' => true,
                    'message' => 'Storage berhasil dibuat',
                    'data' => [
                        'id_storages' => $idStorages,
                        'id_user' => $idUser,
                        'token' => $token,
                        'device_info' => $deviceInfo,
                        'ip_address' => $ipAddress,
                        'date' => $date->format('Y-m-d H:i:s'),
                    ]
                ], 201);
            }
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Terjadi kesalahan: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Delete storage by token (untuk logout)
     */
    public function deleteByToken(Request $request)
    {
        try {
            // Validasi input
            $validator = Validator::make($request->all(), [
                'token' => 'required|string',
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Validasi gagal',
                    'errors' => $validator->errors()
                ], 400);
            }

            $token = $request->token;

            // Hapus storage dengan token ini
            $deleted = DB::table('storages')
                ->where('token', $token)
                ->delete();

            if ($deleted > 0) {
                return response()->json([
                    'success' => true,
                    'message' => 'Storage berhasil dihapus'
                ], 200);
            } else {
                return response()->json([
                    'success' => true,
                    'message' => 'Storage tidak ditemukan (sudah terhapus)'
                ], 200);
            }
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Terjadi kesalahan: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get all storages by id_user
     */
    public function getByUserId($userId)
    {
        try {
            $storages = DB::table('storages')
                ->where('id_user', $userId)
                ->orderBy('date', 'desc')
                ->get();

            return response()->json([
                'success' => true,
                'message' => 'Data storage berhasil diambil',
                'data' => $storages
            ], 200);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Terjadi kesalahan: ' . $e->getMessage()
            ], 500);
        }
    }
}

=== END OF FILE: Http\Controllers\Api\MobileStorageController.php ===


=== START OF FILE: Http\Middleware\AdminMiddleware.php ===
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;

class AdminMiddleware
{
    public function handle(Request $request, Closure $next)
    {
        $userId = $request->input('user_id');
        if ($userId) {
            $user = \App\Models\User::where('id_user', $userId)->first();
            if ($user && $user->akses_level == 'Admin') {
                return $next($request);
            }
        }

        return response()->json(['message' => 'Akses ditolak. Hanya untuk Admin.'], 403);
    }
}

=== END OF FILE: Http\Middleware\AdminMiddleware.php ===


=== START OF FILE: Http\Middleware\Authenticate.php ===
<?php

namespace App\Http\Middleware;

use Illuminate\Auth\Middleware\Authenticate as Middleware;

class Authenticate extends Middleware
{
    /**
     * Get the path the user should be redirected to when they are not authenticated.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return string|null
     */
    protected function redirectTo($request)
    {
        if (! $request->expectsJson()) {
            return route('login');
        }
    }
}

=== END OF FILE: Http\Middleware\Authenticate.php ===


=== START OF FILE: Http\Middleware\AuthenticateToken.php ===
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Carbon\Carbon;

class AuthenticateToken
{
    public function handle(Request $request, Closure $next)
    {
        $token = $request->header('token_auth');
        if (empty($token)) {
            return response()->json(['success' => false, 'message' => 'Token diperlukan'], 401);
        }

        $len = strlen($token);
        if ($len < 15) {
            return response()->json(['success' => false, 'message' => 'Token tidak valid'], 401);
        }

        $tsStr = substr($token, -14);
        $userIdStr = substr($token, 0, $len - 14);

        if (!ctype_digit($tsStr) || !ctype_digit($userIdStr)) {
            return response()->json(['success' => false, 'message' => 'Token tidak valid'], 401);
        }

        try {
            Carbon::createFromFormat('YmdHis', $tsStr);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'message' => 'Token tidak valid'], 401);
        }

        $userId = (int) $userIdStr;
        $user = DB::table('users')->where('id_user', $userId)->first();
        if (!$user) {
            return response()->json(['success' => false, 'message' => 'User tidak ditemukan'], 401);
        }

        if (empty($user->email_verified_at)) {
            return response()->json(['success' => false, 'message' => 'Email belum diverifikasi'], 403);
        }

        $request->attributes->set('auth_user_id', $userId);
        return $next($request);
    }
}
=== END OF FILE: Http\Middleware\AuthenticateToken.php ===


=== START OF FILE: Http\Middleware\EncryptCookies.php ===
<?php

namespace App\Http\Middleware;

use Illuminate\Cookie\Middleware\EncryptCookies as Middleware;

class EncryptCookies extends Middleware
{
    /**
     * The names of the cookies that should not be encrypted.
     *
     * @var array<int, string>
     */
    protected $except = [
        //
    ];
}

=== END OF FILE: Http\Middleware\EncryptCookies.php ===


=== START OF FILE: Http\Middleware\Localization.php ===
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;

class Localization
{
    /**
     * Handle an incoming request.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \Closure  $next
     * @return mixed
     */
    public function handle(Request $request, Closure $next)
    {
        return $next($request);
    }
}

=== END OF FILE: Http\Middleware\Localization.php ===


=== START OF FILE: Http\Middleware\MobileSessionMiddleware.php ===
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use App\Models\Session;
use App\Helpers\SessionHelper;
use App\Helpers\SessionResponseHelper;

class MobileSessionMiddleware
{
    /**
     * Handle an incoming request.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \Closure(\Illuminate\Http\Request): (\Illuminate\Http\Response|\Illuminate\Http\RedirectResponse)  $next
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function handle(Request $request, Closure $next)
    {
        // Ambil session ID dari header atau query parameter
        $sessionId = $request->header('X-Session-ID') 
                    ?? $request->query('id_session') 
                    ?? $request->input('id_session');

        if (!$sessionId) {
            return SessionResponseHelper::unauthorized('Session ID tidak ditemukan');
        }

        // Validasi session
        $session = Session::validateSession($sessionId);
        if (!$session) {
            return SessionResponseHelper::unauthorized('Session tidak valid atau expired');
        }

        // Ambil data user dan staff
        $user = $session->user;
        $staff = $session->staff;

        if (!$user) {
            return SessionResponseHelper::unauthorized('User tidak ditemukan');
        }

        // Tambahkan data session ke request
        $request->merge([
            'session_id' => $session->session_id,
            'user_id' => $user->id_user,
            'staff_id' => $staff ? $staff->id_staff : null,
            'session_data' => [
                'session' => $session,
                'user' => $user,
                'staff' => $staff
            ]
        ]);

        return $next($request);
    }
}

=== END OF FILE: Http\Middleware\MobileSessionMiddleware.php ===


=== START OF FILE: Http\Middleware\PreventRequestsDuringMaintenance.php ===
<?php

namespace App\Http\Middleware;

use Illuminate\Foundation\Http\Middleware\PreventRequestsDuringMaintenance as Middleware;

class PreventRequestsDuringMaintenance extends Middleware
{
    /**
     * The URIs that should be reachable while maintenance mode is enabled.
     *
     * @var array<int, string>
     */
    protected $except = [
        //
    ];
}

=== END OF FILE: Http\Middleware\PreventRequestsDuringMaintenance.php ===


=== START OF FILE: Http\Middleware\RedirectIfAuthenticated.php ===
<?php

namespace App\Http\Middleware;

use App\Providers\RouteServiceProvider;
use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class RedirectIfAuthenticated
{
    /**
     * Handle an incoming request.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \Closure(\Illuminate\Http\Request): (\Illuminate\Http\Response|\Illuminate\Http\RedirectResponse)  $next
     * @param  string|null  ...$guards
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function handle(Request $request, Closure $next, ...$guards)
    {
        $guards = empty($guards) ? [null] : $guards;

        foreach ($guards as $guard) {
            if (Auth::guard($guard)->check()) {
                return redirect(RouteServiceProvider::HOME);
            }
        }

        return $next($request);
    }
}

=== END OF FILE: Http\Middleware\RedirectIfAuthenticated.php ===


=== START OF FILE: Http\Middleware\SessionMiddleware.php ===
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use App\Helpers\SessionHelper;
use App\Helpers\SessionResponseHelper;
use Illuminate\Http\JsonResponse;

class SessionMiddleware
{
    /**
     * Handle an incoming request.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \Closure(\Illuminate\Http\Request): (\Illuminate\Http\Response|\Illuminate\Http\RedirectResponse)  $next
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function handle(Request $request, Closure $next)
    {
        // Skip session validation untuk public routes
        if ($this->isPublicRoute($request)) {
            return $next($request);
        }

        // Validate session
        $sessionData = SessionHelper::validateSession($request);
        
        if (!$sessionData) {
            // Log failed session validation
            \Illuminate\Support\Facades\Log::warning('Session validation failed in middleware', [
                'ip' => $request->ip(),
                'user_agent' => $request->userAgent(),
                'url' => $request->fullUrl(),
                'method' => $request->method(),
                'headers' => [
                    'X-Session-ID' => $request->header('X-Session-ID'),
                    'X-User-ID' => $request->header('X-User-ID'),
                ]
            ]);

            return SessionResponseHelper::unauthorized(
                'Session tidak valid atau telah expired. Silakan login kembali.',
                [
                    'session_id' => $request->header('X-Session-ID'),
                    'user_id' => $request->header('X-User-ID'),
                    'reason' => 'Session validation failed in middleware'
                ]
            );
        }

        // Add session data to request for use in controllers
        $request->merge([
            '_session_data' => $sessionData,
            '_session_info' => [
                'session_id' => $sessionData['session']->session_id,
                'user_id' => $sessionData['user_id'],
                'staf_id' => $sessionData['staf_id'],
                'expires_at' => $sessionData['session']->expires_at?->toISOString(),
                'is_valid' => true,
            ]
        ]);

        // Process request
        $response = $next($request);

        // Auto-inject session info to JSON responses
        if ($response instanceof JsonResponse) {
            $responseData = $response->getData(true);
            
            // Only inject if not already present
            if (!isset($responseData['session'])) {
                $sessionInfo = $request->get('_session_info');
                if ($sessionInfo) {
                    $responseData['session'] = $sessionInfo;
                    $response->setData($responseData);
                }
            }
        }

        return $response;
    }

    /**
     * Check if route is public (doesn't require session)
     */
    private function isPublicRoute(Request $request): bool
    {
        $publicRoutes = [
            'api/v1/mobile/auth/login',
            'api/v1/mobile/auth/register',
            'api/v1/mobile/auth/verify-email',
            'api/v1/mobile/auth/forgot-password',
            'api/v1/mobile/auth/reset-password',
            'api/v1/mobile/auth/packages',
            'api/v1/mobile/properties',
            'api/v1/mobile/properties/search',
            'api/v1/mobile/properties/categories',
        ];

        $path = $request->path();
        
        foreach ($publicRoutes as $route) {
            if (str_starts_with($path, $route)) {
                return true;
            }
        }

        return false;
    }

    /**
     * Get session info for logging
     */
    private function getSessionInfo(Request $request): array
    {
        return [
            'session_id' => $request->header('X-Session-ID'),
            'user_id' => $request->header('X-User-ID'),
            'staf_id' => $request->header('X-Staf-ID'),
            'ip' => $request->ip(),
            'user_agent' => $request->userAgent(),
        ];
    }
}

=== END OF FILE: Http\Middleware\SessionMiddleware.php ===


=== START OF FILE: Http\Middleware\TrimStrings.php ===
<?php

namespace App\Http\Middleware;

use Illuminate\Foundation\Http\Middleware\TrimStrings as Middleware;

class TrimStrings extends Middleware
{
    /**
     * The names of the attributes that should not be trimmed.
     *
     * @var array<int, string>
     */
    protected $except = [
        'current_password',
        'password',
        'password_confirmation',
    ];
}

=== END OF FILE: Http\Middleware\TrimStrings.php ===


=== START OF FILE: Http\Middleware\TrustHosts.php ===
<?php

namespace App\Http\Middleware;

use Illuminate\Http\Middleware\TrustHosts as Middleware;

class TrustHosts extends Middleware
{
    /**
     * Get the host patterns that should be trusted.
     *
     * @return array<int, string|null>
     */
    public function hosts()
    {
        return [
            $this->allSubdomainsOfApplicationUrl(),
        ];
    }
}

=== END OF FILE: Http\Middleware\TrustHosts.php ===


=== START OF FILE: Http\Middleware\TrustProxies.php ===
<?php

namespace App\Http\Middleware;

use Illuminate\Http\Middleware\TrustProxies as Middleware;
use Illuminate\Http\Request;

class TrustProxies extends Middleware
{
    /**
     * The trusted proxies for this application.
     *
     * @var array<int, string>|string|null
     */
    protected $proxies;

    /**
     * The headers that should be used to detect proxies.
     *
     * @var int
     */
    protected $headers =
        Request::HEADER_X_FORWARDED_FOR |
        Request::HEADER_X_FORWARDED_HOST |
        Request::HEADER_X_FORWARDED_PORT |
        Request::HEADER_X_FORWARDED_PROTO |
        Request::HEADER_X_FORWARDED_AWS_ELB;
}

=== END OF FILE: Http\Middleware\TrustProxies.php ===


=== START OF FILE: Http\Middleware\ValidateSignature.php ===
<?php

namespace App\Http\Middleware;

use Illuminate\Routing\Middleware\ValidateSignature as Middleware;

class ValidateSignature extends Middleware
{
    /**
     * The names of the query string parameters that should be ignored.
     *
     * @var array<int, string>
     */
    protected $except = [
        // 'fbclid',
        // 'utm_campaign',
        // 'utm_content',
        // 'utm_medium',
        // 'utm_source',
        // 'utm_term',
    ];
}

=== END OF FILE: Http\Middleware\ValidateSignature.php ===


=== START OF FILE: Http\Middleware\VerifyCsrfToken.php ===
<?php

namespace App\Http\Middleware;

use Illuminate\Foundation\Http\Middleware\VerifyCsrfToken as Middleware;

class VerifyCsrfToken extends Middleware
{
    /**
     * The URIs that should be excluded from CSRF verification.
     *
     * @var array<int, string>
     */
    protected $except = [
        'api/*',
        'mobile/*',
        'admin/*',
        'login/check',
        'signup/proses',
        'forgot-password',
        'reset-password',
    ];
}

=== END OF FILE: Http\Middleware\VerifyCsrfToken.php ===


=== START OF FILE: Mail\PasswordResetEmail.php ===
<?php

namespace App\Mail;

use Illuminate\Bus\Queueable;
use Illuminate\Mail\Mailable;
use Illuminate\Queue\SerializesModels;

class PasswordResetEmail extends Mailable
{
    use Queueable, SerializesModels;

    public $resetToken;
    public $userEmail;

    public function __construct($userEmail, $resetToken)
    {
        $this->userEmail = $userEmail;
        $this->resetToken = $resetToken;
    }

    public function build()
    {
        $resetUrl = config('app.url') . '/reset-password?token=' . $this->resetToken . '&email=' . $this->userEmail;

        return $this->subject('Reset Password - Waisaka Property')
                    ->view('emails.password-reset-link')
                    ->with([
                        'resetUrl' => $resetUrl,
                        'token' => $this->resetToken
                    ]);
    }
}

=== END OF FILE: Mail\PasswordResetEmail.php ===


=== START OF FILE: Mail\VerificationEmail.php ===
<?php

namespace App\Mail;

use Illuminate\Bus\Queueable;
use Illuminate\Mail\Mailable;
use Illuminate\Queue\SerializesModels;

class VerificationEmail extends Mailable
{
    use Queueable, SerializesModels;

    public $user;
    public $verificationToken;

    public function __construct($user, $verificationToken)
    {
        $this->user = $user;
        $this->verificationToken = $verificationToken;
    }

    public function build()
    {
        $verificationUrl = config('app.url') . '/api/v1/mobile/verify-email?token=' . $this->verificationToken;

        return $this->subject('Verify Your Email - Waisaka Property')
                    ->view('emails.verification')
                    ->with([
                        'userName' => $this->user->nama ?? $this->user->name ?? 'User',
                        'verificationUrl' => $verificationUrl
                    ]);
    }
}

=== END OF FILE: Mail\VerificationEmail.php ===


=== START OF FILE: Models\ActivityLog.php ===
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class ActivityLog extends Model
{
    protected $fillable = [
        'user_id',
        'action',
        'description',
        'ip_address'
    ];

    public function user()
    {
        return $this->belongsTo(User::class, 'user_id', 'id_user');
    }
}

=== END OF FILE: Models\ActivityLog.php ===


=== START OF FILE: Models\Agenda.php ===
<?php

namespace App\Models;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

class Agenda extends Model
{

	protected $table 		= "agenda";
	protected $primaryKey 	= 'id_agenda';

     // listing
    public function semua()
    {
        $query = DB::table('agenda')
            ->join('kategori_agenda', 'kategori_agenda.id_kategori_agenda', '=', 'agenda.id_kategori_agenda','LEFT')
            ->join('users', 'users.id_user', '=', 'agenda.id_user','LEFT')
            ->select('agenda.*', 'kategori_agenda.slug_kategori_agenda', 'kategori_agenda.nama_kategori_agenda','users.nama')
            ->orderBy('id_agenda','DESC')
            ->paginate(25);
        return $query;
    }

    // author
    public function author($id_user)
    {
        $query = DB::table('agenda')
            ->join('kategori_agenda', 'kategori_agenda.id_kategori_agenda', '=', 'agenda.id_kategori_agenda','LEFT')
            ->join('users', 'users.id_user', '=', 'agenda.id_user','LEFT')
            ->select('agenda.*', 'kategori_agenda.slug_kategori_agenda', 'kategori_agenda.nama_kategori_agenda','users.nama')
            ->where('agenda.id_user',$id_user)
            ->orderBy('id_agenda','DESC')
            ->paginate(25);
        return $query;
    }

    // listing
    public function cari($keywords)
    {
        $query = DB::table('agenda')
            ->join('kategori_agenda', 'kategori_agenda.id_kategori_agenda', '=', 'agenda.id_kategori_agenda','LEFT')
            ->join('users', 'users.id_user', '=', 'agenda.id_user','LEFT')
            ->select('agenda.*', 'kategori_agenda.slug_kategori_agenda', 'kategori_agenda.nama_kategori_agenda','users.nama')
            ->where('agenda.judul_agenda', 'LIKE', "%{$keywords}%") 
            ->orWhere('agenda.isi', 'LIKE', "%{$keywords}%") 
            ->orderBy('id_agenda','DESC')
           ->paginate(25);
        return $query;
    }

    // kategori_agenda
    public function all_kategori_agenda($id_kategori_agenda)
    {
        $query = DB::table('agenda')
            ->join('kategori_agenda', 'kategori_agenda.id_kategori_agenda', '=', 'agenda.id_kategori_agenda','LEFT')
            ->join('users', 'users.id_user', '=', 'agenda.id_user','LEFT')
            ->select('agenda.*', 'kategori_agenda.slug_kategori_agenda', 'kategori_agenda.nama_kategori_agenda','users.nama')
            ->where(array(  'agenda.id_kategori_agenda'    => $id_kategori_agenda))
            ->orderBy('id_agenda','DESC')
            ->paginate(25);
        return $query;
    }

    // kategori_agenda
    public function status_agenda($status_agenda)
    {
        $query = DB::table('agenda')
             ->join('kategori_agenda', 'kategori_agenda.id_kategori_agenda', '=', 'agenda.id_kategori_agenda','LEFT')
            ->join('users', 'users.id_user', '=', 'agenda.id_user','LEFT')
            ->select('agenda.*', 'kategori_agenda.slug_kategori_agenda', 'kategori_agenda.nama_kategori_agenda','users.nama')
            ->where(array(  'agenda.status_agenda'         => $status_agenda))
            ->orderBy('id_agenda','DESC')
            ->paginate(25);
        return $query;
    }

    // kategori_agenda
    public function jenis_agenda($jenis_agenda)
    {
        $query = DB::table('agenda')
             ->join('kategori_agenda', 'kategori_agenda.id_kategori_agenda', '=', 'agenda.id_kategori_agenda','LEFT')
            ->join('users', 'users.id_user', '=', 'agenda.id_user','LEFT')
            ->select('agenda.*', 'kategori_agenda.slug_kategori_agenda', 'kategori_agenda.nama_kategori_agenda','users.nama')
            ->where(array(  'agenda.jenis_agenda'         => $jenis_agenda))
            ->orderBy('id_agenda','DESC')
            ->paginate(25);
        return $query;
    }

    // listing
    public function listing()
    {
    	$query = DB::table('agenda')
             ->join('kategori_agenda', 'kategori_agenda.id_kategori_agenda', '=', 'agenda.id_kategori_agenda','LEFT')
            ->join('users', 'users.id_user', '=', 'agenda.id_user','LEFT')
            ->select('agenda.*', 'kategori_agenda.slug_kategori_agenda', 'kategori_agenda.nama_kategori_agenda','users.nama')
            ->where('agenda.status_agenda','Publish')
            ->orderBy('id_agenda','DESC')
            ->paginate(25);
        return $query;
    }

    // listing
    public function home()
    {
        $query = DB::table('agenda')
             ->join('kategori_agenda', 'kategori_agenda.id_kategori_agenda', '=', 'agenda.id_kategori_agenda','LEFT')
            ->join('users', 'users.id_user', '=', 'agenda.id_user','LEFT')
            ->select('agenda.*', 'kategori_agenda.slug_kategori_agenda', 'kategori_agenda.nama_kategori_agenda','users.nama')
            ->orderBy('id_agenda','DESC')
            ->limit(3)
            ->get();
        return $query;
    }

    // detail
    public function read($slug_agenda)
    {
        $query = DB::table('agenda')
             ->join('kategori_agenda', 'kategori_agenda.id_kategori_agenda', '=', 'agenda.id_kategori_agenda','LEFT')
            ->join('users', 'users.id_user', '=', 'agenda.id_user','LEFT')
            ->select('agenda.*', 'kategori_agenda.slug_kategori_agenda', 'kategori_agenda.nama_kategori_agenda','users.nama')
            ->where('agenda.slug_agenda',$slug_agenda)
            ->orderBy('id_agenda','DESC')
            ->first();
        return $query;
    }

     // detail
    public function detail($id_agenda)
    {
        $query = DB::table('agenda')
             ->join('kategori_agenda', 'kategori_agenda.id_kategori_agenda', '=', 'agenda.id_kategori_agenda','LEFT')
            ->join('users', 'users.id_user', '=', 'agenda.id_user','LEFT')
            ->select('agenda.*', 'kategori_agenda.slug_kategori_agenda', 'kategori_agenda.nama_kategori_agenda','users.nama')
            ->where('agenda.id_agenda',$id_agenda)
            ->orderBy('id_agenda','DESC')
            ->first();
        return $query;
    }
}

=== END OF FILE: Models\Agenda.php ===


=== START OF FILE: Models\Berita.php ===
<?php

namespace App\Models;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

class Berita extends Model
{

	protected $table 		= "berita";
	protected $primaryKey 	= 'id_berita';

     // listing
    public function semua()
    {
        $query = DB::table('berita')
            ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->orderBy('id_berita','DESC')
            ->paginate(25);
        return $query;
    }

    // listing
    public function berita_update()
    {
        $query = DB::table('berita')
            ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->where('jenis_berita','Berita')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->orderBy('id_berita','DESC')
            ->paginate(25);
        return $query;
    }

    // author
    public function author($id_user)
    {
        $query = DB::table('berita')
            ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->where('berita.id_user',$id_user)
            ->orderBy('id_berita','DESC')
            ->paginate(25);
        return $query;
    }

    // listing
    public function cari($keywords)
    {
        $query = DB::table('berita')
            ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->where('berita.judul_berita', 'LIKE', "%{$keywords}%") 
            ->orWhere('berita.isi', 'LIKE', "%{$keywords}%") 
            ->orderBy('id_berita','DESC')
           ->paginate(25);
        return $query;
    }

    // kategori
    public function all_kategori($id_kategori)
    {
        $query = DB::table('berita')
            ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->where(array(  'berita.id_kategori'    => $id_kategori))
            ->orderBy('id_berita','DESC')
            ->paginate(25);
        return $query;
    }

    // kategori
    public function status_berita($status_berita)
    {
        $query = DB::table('berita')
             ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->where(array(  'berita.status_berita'         => $status_berita))
            ->orderBy('id_berita','DESC')
            ->paginate(25);
        return $query;
    }

    // kategori
    public function jenis_berita($jenis_berita)
    {
        $query = DB::table('berita')
             ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->where(array(  'berita.jenis_berita'         => $jenis_berita))
            ->orderBy('id_berita','DESC')
            ->paginate(25);
        return $query;
    }

    // kategori
    public function kategori_depan($id_kategori)
    {
        $query = DB::table('berita')
             ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->where(array(  'berita.id_kategori'         => $id_kategori,
                            'berita.jenis_berita'       => 'Berita',
                            'berita.status_berita'      => 'Publish'))
            ->orderBy('id_berita','DESC')
            ->paginate(10);
        return $query;
    }

    // listing
    public function listing()
    {
    	$query = DB::table('berita')
             ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->where(array('berita.status_berita'=>'Publish','berita.jenis_berita' => 'Berita'))
            ->orderBy('id_berita','DESC')
            ->paginate(2);
        return $query;
    }

    // listing
    public function home()
    {
        $query = DB::table('berita')
             ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->where(array('berita.status_berita'=>'Publish','berita.jenis_berita' => 'Berita'))
            ->orderBy('id_berita','DESC')
            ->limit(6)
            ->get();
        return $query;
    }

    // detail
    public function read($slug_berita)
    {
        $query = DB::table('berita')
             ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->where('berita.slug_berita',$slug_berita)
            ->orderBy('id_berita','DESC')
            ->first();
        return $query;
    }

     // detail
    public function detail($id_berita)
    {
        $query = DB::table('berita')
             ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->where('berita.id_berita',$id_berita)
            ->orderBy('id_berita','DESC')
            ->first();
        return $query;
    }
	
	
	   // ===================================================================
    // FUNGSI KHUSUS UNTUK MOBILE API
    // ===================================================================

    /**
     * FUNGSI BARU: Mengambil data detail properti KHUSUS untuk API.
     * Fungsi ini menyertakan semua data yang relevan dari tabel staff.
     */
	 
	 
	 // listing
    public function api_listing()
    {
    	$query = DB::table('berita')
             ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->where(array('berita.status_berita'=>'Publish','berita.jenis_berita' => 'Berita'))
            ->orderBy('id_berita','DESC')
            ->paginate(10);
        return $query;
    }
	
	
	public function api_detail($id_berita)
    {
        $query = DB::table('berita')
             ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->join('users', 'users.id_user', '=', 'berita.id_user','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori','users.nama')
            ->where('berita.id_berita',$id_berita)
            ->orderBy('id_berita','DESC')
            ->first();
        return $query;
    }
}

=== END OF FILE: Models\Berita.php ===


=== START OF FILE: Models\Download.php ===
<?php
namespace App\Models;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

class Download extends Model
{

	protected $table 		= "download";
	protected $primaryKey 	= 'id_download';

    // listing
    public function semua()
    {
        $query = DB::table('download')
            ->join('kategori_download', 'kategori_download.id_kategori_download', '=', 'download.id_kategori_download','LEFT')
            ->select('download.*', 'kategori_download.slug_kategori_download', 'kategori_download.nama_kategori_download')
            ->orderBy('download.id_download','DESC')
            ->get();
        return $query;
    }

    // listing
    public function cari($keywords)
    {
        $query = DB::table('download')
            ->join('kategori_download', 'kategori_download.id_kategori_download', '=', 'download.id_kategori_download','LEFT')
            ->select('download.*', 'kategori_download.slug_kategori_download', 'kategori_download.nama_kategori_download')
            ->where('download.judul_download', 'LIKE', "%{$keywords}%") 
            ->orWhere('download.isi', 'LIKE', "%{$keywords}%") 
            ->orderBy('id_download','DESC')
            ->get();
        return $query;
    }

    // listing
    public function listing()
    {
    	$query = DB::table('download')
            ->join('kategori_download', 'kategori_download.id_kategori_download', '=', 'download.id_kategori_download','LEFT')
            ->select('download.*', 'kategori_download.slug_kategori_download', 'kategori_download.nama_kategori_download')
            ->where('status_download','Publish')
            ->orderBy('id_download','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function kategori_download($id_kategori_download)
    {
        $query = DB::table('download')
            ->join('kategori_download', 'kategori_download.id_kategori_download', '=', 'download.id_kategori_download','LEFT')
            ->select('download.*', 'kategori_download.slug_kategori_download', 'kategori_download.nama_kategori_download')
            ->where(array(  'download.status_download'         => 'Publish',
                            'download.id_kategori_download'    => $id_kategori_download))
            ->orderBy('id_download','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function all_kategori_download($id_kategori_download)
    {
        $query = DB::table('download')
            ->join('kategori_download', 'kategori_download.id_kategori_download', '=', 'download.id_kategori_download','LEFT')
            ->select('download.*', 'kategori_download.slug_kategori_download', 'kategori_download.nama_kategori_download')
            ->where(array(  'download.id_kategori_download'    => $id_kategori_download))
            ->orderBy('id_download','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function status_download($status_download)
    {
        $query = DB::table('download')
            ->join('kategori_download', 'kategori_download.id_kategori_download', '=', 'download.id_kategori_download','LEFT')
            ->select('download.*', 'kategori_download.slug_kategori_download', 'kategori_download.nama_kategori_download')
            ->where(array(  'download.status_download'         => $status_download))
            ->orderBy('id_download','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function detail_kategori_download($id_kategori_download)
    {
        $query = DB::table('download')
            ->join('kategori_download', 'kategori_download.id_kategori_download', '=', 'download.id_kategori_download','LEFT')
            ->select('download.*', 'kategori_download.slug_kategori_download', 'kategori_download.nama_kategori_download')
            ->where(array(  'download.status_download'         => 'Publish',
                            'download.id_kategori_download'    => $id_kategori_download))
            ->orderBy('id_download','DESC')
            ->first();
        return $query;
    }

    // kategori
    public function detail_slug_kategori_download($slug_kategori_download)
    {
        $query = DB::table('download')
            ->join('kategori_download', 'kategori_download.id_kategori_download', '=', 'download.id_kategori_download','LEFT')
            ->select('download.*', 'kategori_download.slug_kategori_download', 'kategori_download.nama_kategori_download')
            ->where(array(  'download.status_download'                  => 'Publish',
                            'kategori_download.slug_kategori_download'  => $slug_kategori_download))
            ->orderBy('id_download','DESC')
            ->first();
        return $query;
    }


    // kategori
    public function slug_kategori_download($slug_kategori_download)
    {
        $query = DB::table('download')
            ->join('kategori_download', 'kategori_download.id_kategori_download', '=', 'download.id_kategori_download','LEFT')
            ->select('download.*', 'kategori_download.slug_kategori_download', 'kategori_download.nama_kategori_download')
            ->where(array(  'download.status_download'                  => 'Publish',
                            'kategori_download.slug_kategori_download'  => $slug_kategori_download))
            ->orderBy('id_download','DESC')
            ->get();
        return $query;
    }

    // detail
    public function read($slug_download)
    {
        $query = DB::table('download')
            ->join('kategori_download', 'kategori_download.id_kategori_download', '=', 'download.id_kategori_download','LEFT')
            ->select('download.*', 'kategori_download.slug_kategori_download', 'kategori_download.nama_kategori_download')
            ->where('download.slug_download',$slug_download)
            ->orderBy('id_download','DESC')
            ->first();
        return $query;
    }

     // detail
    public function detail($id_download)
    {
        $query = DB::table('download')
            ->join('kategori_download', 'kategori_download.id_kategori_download', '=', 'download.id_kategori_download','LEFT')
            ->select('download.*', 'kategori_download.slug_kategori_download', 'kategori_download.nama_kategori_download')
            ->where('download.id_download',$id_download)
            ->orderBy('id_download','DESC')
            ->first();
        return $query;
    }

    // Gambar
    public function gambar($id_download)
    {
        $query = DB::table('gambar_download')
            ->select('*')
            ->where('gambar_download.id_download',$id_download)
            ->orderBy('id_download','DESC')
            ->get();
        return $query;
    }
}

=== END OF FILE: Models\Download.php ===


=== START OF FILE: Models\Galeri.php ===
<?php
namespace App\Models;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

class Galeri extends Model
{

	protected $table 		= "galeri";
	protected $primaryKey 	= 'id_galeri';

    // listing
    public function semua()
    {
        $query = DB::table('galeri')
            ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
            ->select('galeri.*', 'kategori_galeri.slug_kategori_galeri', 'kategori_galeri.nama_kategori_galeri')
            ->orderBy('galeri.id_galeri','DESC')
            ->get();
        return $query;
    }

    // listing
    public function cari($keywords)
    {
        $query = DB::table('galeri')
            ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
            ->select('galeri.*', 'kategori_galeri.slug_kategori_galeri', 'kategori_galeri.nama_kategori_galeri')
            ->where('galeri.judul_galeri', 'LIKE', "%{$keywords}%") 
            ->orWhere('galeri.isi', 'LIKE', "%{$keywords}%") 
            ->orderBy('id_galeri','DESC')
            ->get();
        return $query;
    }

    // listing
    public function listing()
    {
    	$query = DB::table('galeri')
            ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
            ->select('galeri.*', 'kategori_galeri.slug_kategori_galeri', 'kategori_galeri.nama_kategori_galeri')
            ->where('status_galeri','Publish')
            ->orderBy('id_galeri','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function kategori_galeri($id_kategori_galeri)
    {
        $query = DB::table('galeri')
            ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
            ->select('galeri.*', 'kategori_galeri.slug_kategori_galeri', 'kategori_galeri.nama_kategori_galeri')
            ->where(array(  'galeri.status_galeri'         => 'Publish',
                            'galeri.id_kategori_galeri'    => $id_kategori_galeri))
            ->orderBy('id_galeri','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function all_kategori_galeri($id_kategori_galeri)
    {
        $query = DB::table('galeri')
            ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
            ->select('galeri.*', 'kategori_galeri.slug_kategori_galeri', 'kategori_galeri.nama_kategori_galeri')
            ->where(array(  'galeri.id_kategori_galeri'    => $id_kategori_galeri))
            ->orderBy('id_galeri','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function status_galeri($status_galeri)
    {
        $query = DB::table('galeri')
            ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
            ->select('galeri.*', 'kategori_galeri.slug_kategori_galeri', 'kategori_galeri.nama_kategori_galeri')
            ->where(array(  'galeri.jenis_galeri'         => $status_galeri))
            ->orderBy('id_galeri','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function detail_kategori_galeri($id_kategori_galeri)
    {
        $query = DB::table('galeri')
            ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
            ->select('galeri.*', 'kategori_galeri.slug_kategori_galeri', 'kategori_galeri.nama_kategori_galeri')
            ->where(array(  'galeri.status_galeri'         => 'Publish',
                            'galeri.id_kategori_galeri'    => $id_kategori_galeri))
            ->orderBy('id_galeri','DESC')
            ->first();
        return $query;
    }

    // kategori
    public function detail_slug_kategori_galeri($slug_kategori_galeri)
    {
        $query = DB::table('galeri')
            ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
            ->select('galeri.*', 'kategori_galeri.slug_kategori_galeri', 'kategori_galeri.nama_kategori_galeri')
            ->where(array(  'galeri.status_galeri'                  => 'Publish',
                            'kategori_galeri.slug_kategori_galeri'  => $slug_kategori_galeri))
            ->orderBy('id_galeri','DESC')
            ->first();
        return $query;
    }


    // kategori
    public function slug_kategori_galeri($slug_kategori_galeri)
    {
        $query = DB::table('galeri')
            ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
            ->select('galeri.*', 'kategori_galeri.slug_kategori_galeri', 'kategori_galeri.nama_kategori_galeri')
            ->where(array(  'galeri.status_galeri'                  => 'Publish',
                            'kategori_galeri.slug_kategori_galeri'  => $slug_kategori_galeri))
            ->orderBy('id_galeri','DESC')
            ->get();
        return $query;
    }

    // detail
    public function read($slug_galeri)
    {
        $query = DB::table('galeri')
            ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
            ->select('galeri.*', 'kategori_galeri.slug_kategori_galeri', 'kategori_galeri.nama_kategori_galeri')
            ->where('galeri.slug_galeri',$slug_galeri)
            ->orderBy('id_galeri','DESC')
            ->first();
        return $query;
    }

     // detail
    public function detail($id_galeri)
    {
        $query = DB::table('galeri')
            ->join('kategori_galeri', 'kategori_galeri.id_kategori_galeri', '=', 'galeri.id_kategori_galeri','LEFT')
            ->select('galeri.*', 'kategori_galeri.slug_kategori_galeri', 'kategori_galeri.nama_kategori_galeri')
            ->where('galeri.id_galeri',$id_galeri)
            ->orderBy('id_galeri','DESC')
            ->first();
        return $query;
    }

    // Gambar
    public function gambar($id_galeri)
    {
        $query = DB::table('gambar_galeri')
            ->select('*')
            ->where('gambar_galeri.id_galeri',$id_galeri)
            ->orderBy('id_galeri','DESC')
            ->get();
        return $query;
    }
}

=== END OF FILE: Models\Galeri.php ===


=== START OF FILE: Models\KategoriStaff.php ===
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class KategoriStaff extends Model
{
    use HasFactory;

    protected $table = 'kategori_staff';
    protected $primaryKey = 'id_kategori_staff';
    public $timestamps = false;

    /**
     * Relasi one-to-many ke StaffModel.
     */
    public function staff()
    {
        return $this->hasMany(StaffModel::class, 'id_kategori_staff', 'id_kategori_staff');
    }
}

=== END OF FILE: Models\KategoriStaff.php ===


=== START OF FILE: Models\Konfigurasi.php ===
<?php

namespace App\Models;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

class Konfigurasi extends Model
{
    // Main Setting
    public function listing()
    {
    	 $query = DB::table('konfigurasi')
            ->select('*')
            ->orderBy('id_konfigurasi','DESC')
            ->first();
        return $query;
    }
}

=== END OF FILE: Models\Konfigurasi.php ===


=== START OF FILE: Models\Nav.php ===
<?php
namespace App\Models;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

class Nav extends Model
{

   
    // Main page
    public function nav_profil()
    {
    	$query = DB::table('berita')
            ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori')
            ->where(array(	'berita.status_berita'	=> 'Publish',
                            'berita.jenis_berita'  => 'Profil'))
            ->orderBy('berita.id_berita','DESC')
            ->get();
        return $query;
    }

    // Main page
    public function nav_berita()
    {
        $query = DB::table('kategori')
            ->orderBy('kategori.urutan','DESC')
            ->get();
        return $query;
    }

    // Main page
    public function nav_materi()
    {
        $query = DB::table('kategori_download')
            ->orderBy('kategori_download.urutan','ASC')
            ->get();
        return $query;
    }

    // Main page
    public function nav_layanan()
    {
        $query = DB::table('berita')
            ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori')
            ->where(array(  'berita.status_berita'  => 'Publish',
                            'berita.jenis_berita'  => 'Layanan'))
            ->orderBy('berita.urutan','ASC')
            ->get();
        return $query;
    }

    // Main page
    public function nav_terjadi()
    {
        $query = DB::table('berita')
            ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori')
            ->where(array(  'berita.status_berita'  => 'Publish',
                            'berita.jenis_berita'  => 'Terjadi'))
            ->orderBy('berita.urutan','ASC')
            ->get();
        return $query;
    }

    // Main page
    public function nav_jenis($jenis_berita)
    {
        $query = DB::table('berita')
            ->join('kategori', 'kategori.id_kategori', '=', 'berita.id_kategori','LEFT')
            ->select('berita.*', 'kategori.slug_kategori', 'kategori.nama_kategori')
            ->where(array(  'berita.status_berita'  => 'Publish',
                            'berita.jenis_berita'  => $jenis_berita))
            ->orderBy('berita.urutan','ASC')
            ->get();
        return $query;
    }
}

=== END OF FILE: Models\Nav.php ===


=== START OF FILE: Models\PaketIklan.php ===
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class PaketIklan extends Model
{
    protected $table = 'paket_iklan';
    protected $primaryKey = 'id';
    public $timestamps = true;

    protected $fillable = [
        'nama_paket',
        'harga',
        'kuota_iklan',
        'deskripsi',
        'is_active'
    ];

    protected $casts = [
        'harga' => 'decimal:2',
        'is_active' => 'boolean',
    ];

    // Relationship dengan transaksi paket
    public function transaksiPaket()
    {
        return $this->hasMany('App\Models\TransaksiPaket', 'paket_id', 'id');
    }

    // Scope untuk paket aktif
    public function scopeActive($query)
    {
        return $query->where('is_active', 1);
    }
}

=== END OF FILE: Models\PaketIklan.php ===


=== START OF FILE: Models\Promosi.php ===
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Promosi extends Model
{
    use HasFactory;

    protected $table = 'promosi';
    protected $primaryKey = 'id_promosi';
    
    protected $fillable = [
        'judul_promosi',
        'deskripsi',
        'gambar',
        'link_url',
        'status_promosi',
        'urutan',
        'tanggal_mulai',
        'tanggal_selesai',
    ];

    protected $casts = [
        'tanggal_mulai' => 'date',
        'tanggal_selesai' => 'date',
    ];

    /**
     * Scope untuk promosi aktif
     */
    public function scopeAktif($query)
    {
        return $query->where('status_promosi', 'Aktif');
    }

    /**
     * Scope untuk promosi yang sedang berlangsung
     */
    public function scopeBerlangsung($query)
    {
        $today = now()->format('Y-m-d');
        return $query->where('status_promosi', 'Aktif')
                     ->where(function($q) use ($today) {
                         $q->whereNull('tanggal_mulai')
                           ->orWhere('tanggal_mulai', '<=', $today);
                     })
                     ->where(function($q) use ($today) {
                         $q->whereNull('tanggal_selesai')
                           ->orWhere('tanggal_selesai', '>=', $today);
                     });
    }

    /**
     * Get promosi untuk slideshow
     */
    public static function getSlideshow()
    {
        return self::berlangsung()
                   ->orderBy('urutan', 'ASC')
                   ->get();
    }
}


=== END OF FILE: Models\Promosi.php ===


=== START OF FILE: Models\Property.php ===
<?php
namespace App\Models;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

class Property extends Model
{

	protected $table 		= "property_db";
	protected $primaryKey 	= 'id_property';

    // listing
    public function semua()
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->join('staff', 'staff.id_staff', '=', 'property_db.id_staff','LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property', 'staff.nama_staff', 
                'kategori_property.nama_kategori_property', 'provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->selectRaw("(CASE WHEN property_db.status = 0 THEN CONCAT('belum ter',property_db.tipe) ELSE CONCAT('sudah ter',property_db.tipe) END) AS nama_status")
            ->orderBy('property_db.id_property','DESC')
            ->get();
        return $query;
    }

    public function semua_raw($where = [])
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->join('staff', 'staff.id_staff', '=', 'property_db.id_staff','LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property', 'staff.nama_staff', 
                'kategori_property.nama_kategori_property', 'provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->where($where);
        return $query;
    }

    // listing
    public function cari($keywords, $tipe = '')
    {
        if($tipe != '' && $tipe != 'all') {
            $whereTipe = " AND property_db.tipe = '".$tipe."' ";
        } else {
            $whereTipe = "";
        }

        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->join('staff', 'staff.id_staff', '=', 'property_db.id_staff','LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property', 'staff.nama_staff', 
                'kategori_property.nama_kategori_property', 'provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
                ->selectRaw("(CASE WHEN property_db.status = 0 THEN CONCAT('belum ter',property_db.tipe) ELSE CONCAT('sudah ter',property_db.tipe) END) AS nama_status")
            ->whereRaw("(property_db.nama_property LIKE '%".$keywords."%' OR property_db.kode LIKE '%".$keywords."%' OR property_db.isi LIKE '%".$keywords."%') ".$whereTipe) 
            ->orderBy('id_property','DESC')
            ->get();
        return $query;
    }
	

    public function listing()
    {
    	$query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->join('staff', 'staff.id_staff', '=', 'property_db.id_staff','LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property', 'staff.nama_staff', 
                'kategori_property.nama_kategori_property', 'provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->where('status_property','Publish')
            ->orderBy('id_property','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function kategori_property($id_kategori_property)
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->join('staff', 'staff.id_staff', '=', 'property_db.id_staff','LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property', 'staff.nama_staff', 
                'kategori_property.nama_kategori_property', 'provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->where(array(  'property_db.status_property'         => 'Publish',
                            'property_db.id_kategori_property'    => $id_kategori_property))
            ->orderBy('id_property','DESC')
            ->get();
        return $query;
    }

    // Kategori
    public function kategori()
    {
         $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property')
            ->join('staff', 'staff.id_staff', '=', 'property_db.id_staff','LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property', 'staff.nama_staff', 
                'kategori_property.nama_kategori_property', 'provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->where(array(  'property_db.status_property'         => 'Publish'))
            ->groupBy('property_db.id_kategori_property')
            ->orderBy('kategori_property.urutan','ASC')
            ->get();
        return $query;
    }

    // kategori
    public function all_kategori_property($id_kategori_property)
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->join('staff', 'staff.id_staff', '=', 'property_db.id_staff','LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property', 'staff.nama_staff', 
                'kategori_property.nama_kategori_property', 'provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->where(array(  'property_db.id_kategori_property'    => $id_kategori_property))
            ->orderBy('id_property','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function status_property($status_property)
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property')
            ->where(array(  'property_db.status_property'         => $status_property))
            ->orderBy('id_property','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function detail_kategori_property($id_kategori_property)
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property')
            ->where(array(  'property_db.status_property'         => 'Publish',
                            'property_db.id_kategori_property'    => $id_kategori_property))
            ->orderBy('id_property','DESC')
            ->first();
        return $query;
    }

    // kategori
    public function detail_slug_kategori_property($slug_kategori_property)
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property')
            ->where(array(  'property_db.status_property'                  => 'Publish',
                            'kategori_property.slug_kategori_property'  => $slug_kategori_property))
            ->orderBy('id_property','DESC')
            ->first();
        return $query;
    }


    // kategori
    public function slug_kategori_property($slug_kategori_property)
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property')
            ->where(array(  'property_db.status_property'                  => 'Publish',
                            'kategori_property.slug_kategori_property'  => $slug_kategori_property))
            ->orderBy('id_property','DESC')
            ->get();
        return $query;
    }

    // detail
    public function read($slug_property)
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property')
            ->where('property_db.slug_property',$slug_property)
            ->orderBy('id_property','DESC')
            ->first();
        return $query;
    }


    public function detail($id_property)
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->join('staff', 'staff.id_staff', '=', 'property_db.id_staff','LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan','LEFT')
            ->select('property_db.*', 'kategori_property.slug_kategori_property', 'kategori_property.nama_kategori_property', 'staff.nama_staff', 
                'kategori_property.nama_kategori_property', 'provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->where('property_db.id_property',$id_property)
            ->orderBy('id_property','DESC')
            ->first();
        return $query;
    }

    // Gambar
    public function gambar($id_property)
    {
        $query = DB::table('property_img')
            ->select('*')
            ->where('property_img.id_property',$id_property)
            ->orderBy('id_property_img')
            ->get();
        return $query;
    }

 
    // ===================================================================
    // FUNGSI KHUSUS UNTUK MOBILE API
    // ===================================================================

    /**
     * FUNGSI BARU: Mengambil data detail properti KHUSUS untuk API.
     * Fungsi ini menyertakan semua data yang relevan dari tabel staff.
     */
	 
    public function api_detail($id_property)
    {
        $query = DB::table('property_db')
            ->join('kategori_property', 'kategori_property.id_kategori_property', '=', 'property_db.id_kategori_property','LEFT')
            ->join('staff', 'staff.id_staff', '=', 'property_db.id_staff','LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'property_db.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'property_db.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'property_db.id_kecamatan','LEFT')
            ->select(
                'property_db.*', 
                'kategori_property.nama_kategori_property', 
                'staff.nama_staff', 
                'staff.telepon as telepon_staff', // Alias kolom telepon
                'staff.gambar as gambar_staff'    // Alias kolom gambar staff
            )
            ->where('property_db.id_property', $id_property)
            ->first();
        return $query;
    }
}

=== END OF FILE: Models\Property.php ===


=== START OF FILE: Models\Proyek.php ===
<?php
namespace App\Models;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

class Proyek extends Model
{

	protected $table 		= "proyek";
	protected $primaryKey 	= 'id_proyek';

    // listing
    public function semua()
    {
        $query = DB::table('proyek')
            ->join('provinsi', 'provinsi.id', '=', 'proyek.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'proyek.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'proyek.id_kecamatan','LEFT')
            ->select('proyek.*','provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->orderBy('proyek.id_proyek','DESC')
            ->get();
        return $query;
    }

    public function semua_raw($where)
    {
        $query = DB::table('proyek')
            ->join('provinsi', 'provinsi.id', '=', 'proyek.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'proyek.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'proyek.id_kecamatan','LEFT')
            ->select('proyek.*','provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->where($where);
        return $query;
    }

    // listing
    public function cari($keywords, $tipe = '')
    {
        if($tipe != '' && $tipe != 'all') {
            $whereTipe = " AND proyek.tipe = '".$tipe."' ";
        } else {
            $whereTipe = "";
        }

        $query = DB::table('proyek')
            ->join('provinsi', 'provinsi.id', '=', 'proyek.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'proyek.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'proyek.id_kecamatan','LEFT')
            ->select('proyek.*','provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->whereRaw("(proyek.nama_proyek LIKE '%".$keywords."%' OR proyek.kode LIKE '%".$keywords."%' OR proyek.isi LIKE '%".$keywords."%') ".$whereTipe) 
            ->orderBy('id_proyek','DESC')
            ->get();
        return $query;
    }

    // listing
    public function listing()
    {
    	$query = DB::table('proyek')
            ->join('provinsi', 'provinsi.id', '=', 'proyek.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'proyek.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'proyek.id_kecamatan','LEFT')
            ->select('proyek.*','provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->where('status_proyek','Publish')
            ->orderBy('id_proyek','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function kategori_proyek($id_kategori_proyek)
    {
        $query = DB::table('proyek')
            ->join('provinsi', 'provinsi.id', '=', 'proyek.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'proyek.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'proyek.id_kecamatan','LEFT')
            ->select('proyek.*','provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->where(array(  'proyek.status_proyek'         => 'Publish',
                            'proyek.id_kategori_proyek'    => $id_kategori_proyek))
            ->orderBy('id_proyek','DESC')
            ->get();
        return $query;
    }

    // Kategori
    public function kategori()
    {
         $query = DB::table('proyek')
            ->join('provinsi', 'provinsi.id', '=', 'proyek.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'proyek.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'proyek.id_kecamatan','LEFT')
            ->select('proyek.*','provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->where(array(  'proyek.status_proyek'         => 'Publish'))
            ->groupBy('proyek.id_kategori_proyek')
            ->orderBy('kategori_proyek.urutan','ASC')
            ->get();
        return $query;
    }

    // kategori
    public function all_kategori_proyek($id_kategori_proyek)
    {
        $query = DB::table('proyek')
            ->join('provinsi', 'provinsi.id', '=', 'proyek.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'proyek.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'proyek.id_kecamatan','LEFT')
            ->select('proyek.*','provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->where(array(  'proyek.id_kategori_proyek'    => $id_kategori_proyek))
            ->orderBy('id_proyek','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function status_proyek($status_proyek)
    {
        $query = DB::table('proyek')
            ->join('kategori_proyek', 'kategori_proyek.id_kategori_proyek', '=', 'proyek.id_kategori_proyek','LEFT')
            ->select('proyek.*', 'kategori_proyek.slug_kategori_proyek', 'kategori_proyek.nama_kategori_proyek')
            ->where(array(  'proyek.status_proyek'         => $status_proyek))
            ->orderBy('id_proyek','DESC')
            ->get();
        return $query;
    }

    // kategori
    public function detail_kategori_proyek($id_kategori_proyek)
    {
        $query = DB::table('proyek')
            ->join('kategori_proyek', 'kategori_proyek.id_kategori_proyek', '=', 'proyek.id_kategori_proyek','LEFT')
            ->select('proyek.*', 'kategori_proyek.slug_kategori_proyek', 'kategori_proyek.nama_kategori_proyek')
            ->where(array(  'proyek.status_proyek'         => 'Publish',
                            'proyek.id_kategori_proyek'    => $id_kategori_proyek))
            ->orderBy('id_proyek','DESC')
            ->first();
        return $query;
    }

    // kategori
    public function detail_slug_kategori_proyek($slug_kategori_proyek)
    {
        $query = DB::table('proyek')
            ->join('kategori_proyek', 'kategori_proyek.id_kategori_proyek', '=', 'proyek.id_kategori_proyek','LEFT')
            ->select('proyek.*', 'kategori_proyek.slug_kategori_proyek', 'kategori_proyek.nama_kategori_proyek')
            ->where(array(  'proyek.status_proyek'                  => 'Publish',
                            'kategori_proyek.slug_kategori_proyek'  => $slug_kategori_proyek))
            ->orderBy('id_proyek','DESC')
            ->first();
        return $query;
    }


    // kategori
    public function slug_kategori_proyek($slug_kategori_proyek)
    {
        $query = DB::table('proyek')
            ->join('kategori_proyek', 'kategori_proyek.id_kategori_proyek', '=', 'proyek.id_kategori_proyek','LEFT')
            ->select('proyek.*', 'kategori_proyek.slug_kategori_proyek', 'kategori_proyek.nama_kategori_proyek')
            ->where(array(  'proyek.status_proyek'                  => 'Publish',
                            'kategori_proyek.slug_kategori_proyek'  => $slug_kategori_proyek))
            ->orderBy('id_proyek','DESC')
            ->get();
        return $query;
    }

    // detail
    public function read($slug_proyek)
    {
        $query = DB::table('proyek')
            ->join('kategori_proyek', 'kategori_proyek.id_kategori_proyek', '=', 'proyek.id_kategori_proyek','LEFT')
            ->select('proyek.*', 'kategori_proyek.slug_kategori_proyek', 'kategori_proyek.nama_kategori_proyek')
            ->where('proyek.slug_proyek',$slug_proyek)
            ->orderBy('id_proyek','DESC')
            ->first();
        return $query;
    }

     // detail
    public function detail($id_proyek)
    {
        $query = DB::table('proyek')
            ->join('provinsi', 'provinsi.id', '=', 'proyek.id_provinsi','LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'proyek.id_kabupaten','LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'proyek.id_kecamatan','LEFT')
            ->select('proyek.*','provinsi.nama as nama_provinsi', 'kabupaten.nama as nama_kabupaten', 'kecamatan.nama as nama_kecamatan')
            ->where('proyek.id_proyek',$id_proyek)
            ->orderBy('id_proyek','DESC')
            ->first();
        return $query;
    }

    // Gambar
    public function gambar($id_proyek)
    {
        $query = DB::table('proyek_img')
            ->select('*')
            ->where('proyek_img.id_proyek',$id_proyek)
            ->orderBy('id_proyek_img')
            ->get();
        return $query;
    }
}

=== END OF FILE: Models\Proyek.php ===


=== START OF FILE: Models\Rekening.php ===
<?php
namespace App\Models;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

class Rekening extends Model
{
    public function listing()
    {
    	$query = DB::table('rekening')
            ->select('*')
            ->orderBy('id_rekening','DESC')
            ->get();
        return $query;
    }
}

=== END OF FILE: Models\Rekening.php ===


=== START OF FILE: Models\Session.php ===
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Support\Facades\DB;
use Carbon\Carbon;

class Session extends Model
{
    protected $table = 'sessions';
    
    protected $primaryKey = 'id';
    
    protected $fillable = [
        'session_id',
        'user_id',
        'staf_id',
        'expires_at',
        'device_info',
        'ip_address',
        'is_active',
        'created_at',
        'updated_at'
    ];

    protected $casts = [
        'user_id' => 'integer',
        'staf_id' => 'integer',
        'expires_at' => 'datetime',
        'is_active' => 'boolean',
        'created_at' => 'datetime',
        'updated_at' => 'datetime'
    ];

    /**
     * Relationship dengan User
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class, 'user_id', 'id_user');
    }

    /**
     * Relationship dengan Staff (melalui user)
     */
    public function staff(): BelongsTo
    {
        return $this->belongsTo(Staff::class, 'user_id', 'id_user');
    }

    /**
     * Generate unique session ID
     */
    public static function generateSessionId(): string
    {
        return bin2hex(random_bytes(30)); // 60 karakter
    }

    /**
     * Create new session
     */
    public static function createSession(array $data): self
    {
        return self::create([
            'session_id' => self::generateSessionId(),
            'user_id' => $data['user_id'],
            'staf_id' => $data['staf_id'] ?? null,
            'expires_at' => now()->addDays(7), // Session berlaku 7 hari
            'device_info' => $data['device_info'] ?? null,
            'ip_address' => $data['ip_address'] ?? null,
            'is_active' => true,
            'created_at' => now(),
            'updated_at' => now()
        ]);
    }

    /**
     * Validate session
     */
    public static function validateSession(string $sessionId): ?self
    {
        $session = self::where('session_id', $sessionId)
            ->where('is_active', true)
            ->where('expires_at', '>', now()) // Session belum expired
            ->first();

        if ($session) {
            // Update last activity (update updated_at)
            $session->update(['updated_at' => now()]);
        }

        return $session;
    }

    /**
     * Invalidate session (Hard Delete)
     */
    public function invalidate(): bool
    {
        $sessionId = $this->session_id;
        $userId = $this->user_id;
        
        // Log before deletion for security monitoring
        \Log::info("Session hard deleted: {$sessionId} for user {$userId}");
        
        // Hard delete - hapus data dari database
        $result = $this->delete();
        
        return $result;
    }

    /**
     * Invalidate all sessions for user (Hard Delete)
     */
    public static function invalidateUserSessions(int $userId): int
    {
        $sessions = self::where('user_id', $userId)
            ->where('is_active', true)
            ->where('expires_at', '>', now())
            ->get();
            
        $count = $sessions->count();
        
        if ($count > 0) {
            // Log before deletion for security monitoring
            \Log::info("All sessions hard deleted for user {$userId}, count: {$count}");
            
            // Hard delete - hapus semua session user dari database
            self::where('user_id', $userId)
                ->where('is_active', true)
                ->where('expires_at', '>', now())
                ->delete();
        }
        
        return $count;
    }

    /**
     * Clean expired sessions (Hard Delete)
     */
    public static function cleanExpiredSessions(): int
    {
        $expiredSessions = self::where('expires_at', '<', now())
            ->get();
            
        $count = $expiredSessions->count();
        
        if ($count > 0) {
            // Log before deletion
            \Log::info("Expired sessions hard deleted, count: {$count}");
            
            // Hard delete expired sessions
            self::where('expires_at', '<', now())
                ->delete();
        }
        
        return $count;
    }

    /**
     * Check if session is valid
     */
    public function isValid(): bool
    {
        return $this->is_active && $this->expires_at->isAfter(now());
    }

    /**
     * Get session data for mobile app
     */
    public function getMobileData(): array
    {
        // Get purchased packages for this user
        $purchasedPackages = DB::table('transaksi_paket as tp')
            ->join('paket_iklan as pk', 'tp.paket_id', '=', 'pk.id')
            ->where('tp.user_id', $this->user_id)
            ->where('tp.status_pembayaran', 'confirmed')
            ->select([
                'tp.id as transaction_id',
                'tp.paket_id',
                'tp.kode_transaksi',
                'tp.status_pembayaran',
                'tp.created_at as purchase_date',
                'pk.nama_paket',
                'pk.harga',
                'pk.kuota_iklan',
                'pk.deskripsi'
            ])
            ->orderBy('tp.created_at', 'desc')
            ->get()
            ->map(function ($package) {
                return [
                    'transaction_id' => $package->transaction_id,
                    'paket_id' => $package->paket_id,
                    'kode_transaksi' => $package->kode_transaksi,
                    'status_pembayaran' => $package->status_pembayaran,
                    'purchase_date' => $package->purchase_date,
                    'nama_paket' => $package->nama_paket,
                    'harga' => (float) $package->harga,
                    'kuota_iklan' => $package->kuota_iklan,
                    'deskripsi' => $package->deskripsi
                ];
            });

        return [
            'session_id' => $this->session_id,
            'user_id' => $this->user_id,
            'staf_id' => $this->staf_id,
            'device_info' => $this->device_info,
            'expires_at' => $this->expires_at->format('Y-m-d H:i:s'),
            'is_active' => $this->isValid(),
            'purchased_packages' => $purchasedPackages->toArray()
        ];
    }
}

=== END OF FILE: Models\Session.php ===


=== START OF FILE: Models\Staff.php ===
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

class Staff extends Model
{
    protected $table = 'staff';
    protected $primaryKey = 'id_staff';
    public $timestamps = false;

    protected $fillable = [
        'id_user',
        'id_kategori_staff',
        'slug_staff',
        'nama_staff',
        'jabatan',
        'pendidikan',
        'expertise',
        'email',
        'telepon',
        'isi',
        'gambar',
        'status_staff',
        'keywords',
        'urutan',
        'nickname_staff',
        'id_provinsi',
        'id_kabupaten',
        'id_kecamatan',
        'total_kuota_iklan',
        'sisa_kuota_iklan'
    ];

    // Method untuk mengambil semua data staff
    public function semua()
    {
        $query = DB::table('staff')
            ->join('kategori_staff', 'kategori_staff.id_kategori_staff', '=', 'staff.id_kategori_staff', 'LEFT')
            ->join('users', 'users.id_user', '=', 'staff.id_user', 'LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'staff.id_provinsi', 'LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'staff.id_kabupaten', 'LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'staff.id_kecamatan', 'LEFT')
            ->select(
                'staff.*', 
                'kategori_staff.nama_kategori_staff', 
                'users.nama as nama_user',
                'users.email as email_user',
                'provinsi.nama as nama_provinsi', 
                'kabupaten.nama as nama_kabupaten', 
                'kecamatan.nama as nama_kecamatan'
            )
            ->orderBy('staff.urutan', 'ASC')
            ->orderBy('staff.id_staff', 'DESC')
            ->get();
        return $query;
    }

    // Method untuk mengambil detail staff berdasarkan ID
    public function detail($id_staff)
    {
        $query = DB::table('staff')
            ->join('kategori_staff', 'kategori_staff.id_kategori_staff', '=', 'staff.id_kategori_staff', 'LEFT')
            ->join('users', 'users.id_user', '=', 'staff.id_user', 'LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'staff.id_provinsi', 'LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'staff.id_kabupaten', 'LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'staff.id_kecamatan', 'LEFT')
            ->select(
                'staff.*', 
                'kategori_staff.nama_kategori_staff', 
                'users.nama as nama_user',
                'users.email as email_user',
                'provinsi.nama as nama_provinsi', 
                'kabupaten.nama as nama_kabupaten', 
                'kecamatan.nama as nama_kecamatan'
            )
            ->where('staff.id_staff', $id_staff)
            ->first();
        return $query;
    }

    // Method untuk mencari staff berdasarkan keywords
    public function cari($keywords)
    {
        $query = DB::table('staff')
            ->join('kategori_staff', 'kategori_staff.id_kategori_staff', '=', 'staff.id_kategori_staff', 'LEFT')
            ->join('users', 'users.id_user', '=', 'staff.id_user', 'LEFT')
            ->join('provinsi', 'provinsi.id', '=', 'staff.id_provinsi', 'LEFT')
            ->join('kabupaten', 'kabupaten.id', '=', 'staff.id_kabupaten', 'LEFT')
            ->join('kecamatan', 'kecamatan.id', '=', 'staff.id_kecamatan', 'LEFT')
            ->select(
                'staff.*', 
                'kategori_staff.nama_kategori_staff', 
                'users.nama as nama_user',
                'users.email as email_user',
                'provinsi.nama as nama_provinsi', 
                'kabupaten.nama as nama_kabupaten', 
                'kecamatan.nama as nama_kecamatan'
            )
            ->whereRaw("(staff.nama_staff LIKE '%".$keywords."%' OR staff.jabatan LIKE '%".$keywords."%' OR staff.expertise LIKE '%".$keywords."%' OR staff.isi LIKE '%".$keywords."%')")
            ->orderBy('staff.urutan', 'ASC')
            ->orderBy('staff.id_staff', 'DESC')
            ->get();
        return $query;
    }

    // Relationship dengan user
    public function user()
    {
        return $this->belongsTo('App\Models\User', 'id_user', 'id_user');
    }

    // Relationship dengan transaksi paket
    public function transaksiPaket()
    {
        return $this->hasMany('App\Models\TransaksiPaket', 'id_staff', 'id_staff');
    }
}

=== END OF FILE: Models\Staff.php ===


=== START OF FILE: Models\TransaksiPaket.php ===
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class TransaksiPaket extends Model
{
    protected $table = 'transaksi_paket';
    protected $primaryKey = 'id';
    public $timestamps = true;

    protected $fillable = [
        'id_user',  //  FIXED: Changed from 'user_id' to 'id_user' (sesuai database)
        'id_staff',
        'paket_id',
        'kode_transaksi',
        'status_pembayaran',
        'bukti_pembayaran',
        'keterangan',  //  ADDED: Missing field from database
        'dikonfirmasi_oleh',
        'tanggal_konfirmasi'
    ];

    protected $casts = [
        'tanggal_konfirmasi' => 'datetime',
    ];

    // Relationship dengan user
    //  FIXED: Changed foreign key from 'user_id' to 'id_user'
    public function user()
    {
        return $this->belongsTo('App\Models\User', 'id_user', 'id_user');
    }

    // Relationship dengan staff
    public function staff()
    {
        return $this->belongsTo('App\Models\Staff', 'id_staff', 'id_staff');
    }

    // Relationship dengan paket iklan
    public function paketIklan()
    {
        return $this->belongsTo('App\Models\PaketIklan', 'paket_id', 'id');
    }
}

=== END OF FILE: Models\TransaksiPaket.php ===


=== START OF FILE: Models\User.php ===
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;


class User extends Model
{
    protected $table = 'users';
    protected $primaryKey = 'id_user';
    protected $fillable = [
        'nama',
        'email', 
        'username',
        'password',
        'akses_level',
        'gambar',
        'paket_id',
        'approved_by'
    ];

    // kategori
    public function login($username,$password)
    {
        $query = DB::table('users')
            ->select('*')
            ->where(array(  'users.username'	=> $username,
                            'users.password'    => sha1($password)))
            ->orderBy('id_user','DESC')
            ->first();
        return $query;
    }

    // Relationship dengan staff
    public function staff()
    {
        return $this->hasOne('App\Models\Staff', 'id_user', 'id_user');
    }

    // Relationship dengan transaksi paket
    //  FIXED: Changed foreign key from 'user_id' to 'id_user' (sesuai database)
    public function transaksiPaket()
    {
        return $this->hasMany('App\Models\TransaksiPaket', 'id_user', 'id_user');
    }
}

=== END OF FILE: Models\User.php ===


=== START OF FILE: Models\UserVerification.php ===
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class UserVerification extends Model
{
    protected $fillable = [
        'user_id',
        'token',
        'expired_at'
    ];

    protected $casts = [
        'expired_at' => 'datetime'
    ];

    public function user()
    {
        return $this->belongsTo(User::class, 'user_id', 'id_user');
    }

    public function isExpired()
    {
        return $this->expired_at->isPast();
    }

    public static function generateToken()
    {
        return bin2hex(random_bytes(32));
    }
}

=== END OF FILE: Models\UserVerification.php ===


=== START OF FILE: Providers\AppServiceProvider.php ===
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;

class AppServiceProvider extends ServiceProvider
{
    /**
     * Register any application services.
     *
     * @return void
     */
    public function register()
    {
        //
    }

    /**
     * Bootstrap any application services.
     *
     * @return void
     */
    public function boot()
    {
        //
    }
}

=== END OF FILE: Providers\AppServiceProvider.php ===


=== START OF FILE: Providers\AuthServiceProvider.php ===
<?php

namespace App\Providers;

// use Illuminate\Support\Facades\Gate;
use Illuminate\Foundation\Support\Providers\AuthServiceProvider as ServiceProvider;

class AuthServiceProvider extends ServiceProvider
{
    /**
     * The model to policy mappings for the application.
     *
     * @var array<class-string, class-string>
     */
    protected $policies = [
        // 'App\Models\Model' => 'App\Policies\ModelPolicy',
    ];

    /**
     * Register any authentication / authorization services.
     *
     * @return void
     */
    public function boot()
    {
        $this->registerPolicies();

        //
    }
}

=== END OF FILE: Providers\AuthServiceProvider.php ===


=== START OF FILE: Providers\BroadcastServiceProvider.php ===
<?php

namespace App\Providers;

use Illuminate\Support\Facades\Broadcast;
use Illuminate\Support\ServiceProvider;

class BroadcastServiceProvider extends ServiceProvider
{
    /**
     * Bootstrap any application services.
     *
     * @return void
     */
    public function boot()
    {
        Broadcast::routes();

        require base_path('routes/channels.php');
    }
}

=== END OF FILE: Providers\BroadcastServiceProvider.php ===


=== START OF FILE: Providers\EventServiceProvider.php ===
<?php

namespace App\Providers;

use Illuminate\Auth\Events\Registered;
use Illuminate\Auth\Listeners\SendEmailVerificationNotification;
use Illuminate\Foundation\Support\Providers\EventServiceProvider as ServiceProvider;
use Illuminate\Support\Facades\Event;

class EventServiceProvider extends ServiceProvider
{
    /**
     * The event to listener mappings for the application.
     *
     * @var array<class-string, array<int, class-string>>
     */
    protected $listen = [
        Registered::class => [
            SendEmailVerificationNotification::class,
        ],
    ];

    /**
     * Register any events for your application.
     *
     * @return void
     */
    public function boot()
    {
        //
    }

    /**
     * Determine if events and listeners should be automatically discovered.
     *
     * @return bool
     */
    public function shouldDiscoverEvents()
    {
        return false;
    }
}

=== END OF FILE: Providers\EventServiceProvider.php ===


=== START OF FILE: Providers\RouteServiceProvider.php ===
<?php

namespace App\Providers;

use Illuminate\Cache\RateLimiting\Limit;
use Illuminate\Foundation\Support\Providers\RouteServiceProvider as ServiceProvider;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\RateLimiter;
use Illuminate\Support\Facades\Route;

class RouteServiceProvider extends ServiceProvider
{
    /**
     * The path to the "home" route for your application.
     *
     * Typically, users are redirected here after authentication.
     *
     * @var string
     */
    public const HOME = '/home';

    /**
     * Define your route model bindings, pattern filters, and other route configuration.
     *
     * @return void
     */
    public function boot()
    {
        $this->configureRateLimiting();

        $this->routes(function () {
            Route::middleware('api')
                ->prefix('api')
                ->group(base_path('routes/api.php'));

            Route::middleware('web')
                ->group(base_path('routes/web.php'));
        });
    }

    /**
     * Configure the rate limiters for the application.
     *
     * @return void
     */
    protected function configureRateLimiting()
    {
        RateLimiter::for('api', function (Request $request) {
            return Limit::perMinute(60)->by($request->user()?->id ?: $request->ip());
        });
    }
}

=== END OF FILE: Providers\RouteServiceProvider.php ===


=== START OF FILE: Services\WaisakaAiService.php ===
<?php

namespace App\Services;

use Illuminate\Http\Client\RequestException;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;

class WaisakaAiService
{
    protected string $apiKey;
    protected string $baseUrl;
    protected string $model;
    protected int $timeout;
    protected int $retries;

    public function __construct()
    {
        $config = config('services.gemini', []);

        $this->apiKey = (string) ($config['key'] ?? '');
        $this->baseUrl = rtrim((string) ($config['base'] ?? 'https://generativelanguage.googleapis.com/v1beta'), '/');
        $this->model = (string) ($config['model'] ?? 'gemini-2.5-flash-lite');
        $this->timeout = (int) ($config['timeout'] ?? 40);
        $this->retries = max(0, (int) ($config['retries'] ?? 3));
    }


    public function getMapCoordinateSummary(string $address, ?string $kecamatan = null, ?string $kabupaten = null, ?string $provinsi = null): ?array
    {
        $addressParts = array_filter([$address, $kecamatan, $kabupaten, $provinsi]);
        $alamatLengkap = implode(', ', $addressParts);
        
        $prompt = <<<PROMPT
Anda adalah AI Expert Geocoding Specialist yang bertugas mencari koordinat maps (latitude, longitude) dengan akurat.

 Tugas anda adalah mencari koordinat (latitude, longitude) paling relevan dan akurat dari {$address} dengan teliti:
    Jangan cari koordinat di luar {$alamatLengkap}
    Jangan cari koordinat perkiraan
    Jika tidak ditemukan resultnya maka cari dengan berdasarkan wilayah kecamatan atau kota atau kabupaten dari {$alamatLengkap}
    Pilih hasil pencarian yang menampilkan koordinat yang akurat dengan {$alamatLengkap}
    Verifikasi hasil pencarian dengan google maps
    Jika BENAR-BENAR tidak ditemukan, return: {}



 CONTOH FORMAT OUTPUT (JSON MURNI):


{
  "latitude": -6.9174639,
  "longitude": 107.6191228,
  "maps_query": "Perumahan Grand Wisata, Kalimantan"
}

PROMPT;

        $raw = $this->generateContent($prompt);
        if (empty($raw)) {
            return null;
        }

        $decoded = $this->decodeJson($raw);
        if (!$decoded) {
            Log::warning('WaisakaAiService: gagal mengurai koordinat Gemini', ['raw' => $raw]);
            return null;
        }

        if (!isset($decoded['latitude'], $decoded['longitude'])) {
            Log::warning('WaisakaAiService: respon koordinat tidak lengkap', ['decoded' => $decoded]);
            return null;
        }

        // Validasi numerik dan rentang Indonesia
        $lat = is_numeric($decoded['latitude']) ? (float) $decoded['latitude'] : null;
        $lng = is_numeric($decoded['longitude']) ? (float) $decoded['longitude'] : null;

        if ($lat === null || $lng === null) {
            Log::warning('WaisakaAiService: koordinat bukan numerik', ['decoded' => $decoded]);
            return null;
        }

        if ($lat < -11.5 || $lat > 6.5 || $lng < 95.0 || $lng > 145.0) {
            Log::warning('WaisakaAiService: koordinat di luar rentang Indonesia', ['lat' => $lat, 'lng' => $lng, 'decoded' => $decoded]);
            return null;
        }

        return [
            'latitude' => $lat,
            'longitude' => $lng,
            'maps_query' => isset($decoded['maps_query']) && is_string($decoded['maps_query']) && trim($decoded['maps_query']) !== ''
                ? trim($decoded['maps_query'])
                : $alamatLengkap,
        ];
    }

    public function getAveragePriceSummary(string $tipe, string $kategori, string $alamat, ?float $hargaListing = null, ?int $luasTanah = null, ?int $luasBangunan = null): ?string
    {
        $hargaText = $hargaListing !== null ? number_format($hargaListing, 0, ',', '.') : 'tidak diketahui';
        $tipeText = strtolower($tipe) === 'sewa' ? 'sewa' : 'jual';
        $ltText = $luasTanah !== null && $luasTanah > 0 ? $luasTanah . ' m' : 'tidak diketahui';
        $lbText = $luasBangunan !== null && $luasBangunan > 0 ? $luasBangunan . ' m' : 'tidak diketahui';

        $prompt = <<<PROMPT
Anda adalah AI Expert Analis Properti yang bertugas mencari harga pasar rata-rata properti dengan DATA SPESIFIK.


 DATA PROPERTI:


 Tipe Transaksi: {$tipeText}
 Kategori: {$kategori}
 Lokasi: {$alamat}
 Luas Tanah: {$ltText}
 Luas Bangunan: {$lbText}
 Harga Listing: Rp {$hargaText}


 TUGAS PENCARIAN:


Cari harga pasar rata-rata {$tipeText} untuk {$kategori} dengan spesifikasi:
 Lokasi: {$alamat}
 Luas tanah: {$ltText}
 Luas bangunan: {$lbText}

Sumber Data (Prioritas):
1. Rumah123.com - cari properti serupa dengan LT/LB yang mirip
2. 99.co - filter berdasarkan lokasi dan ukuran
3. Google Search - query: "harga {$kategori} {$alamat} LT {$ltText} LB {$lbText}"
4. OLX Properti - cari listing sejenis

Fokus: Cari properti dengan LUAS TANAH dan LUAS BANGUNAN yang SERUPA (20%)


 FORMAT OUTPUT (WAJIB):


 MAKSIMAL 28 KATA (bukan 28 kalimat)
 Format Rupiah: Rp 500 juta, Rp 1,2 miliar, Rp 850 juta
 1 kalimat ringkas dan informatif
 Sebutkan rentang harga berdasarkan ukuran properti

CONTOH OUTPUT YANG BENAR (tepat 18 kata):
"Harga rata-rata rumah untuk dijual di Bandung dengan LT 100 m LB 160 m berkisar Rp 800 juta hingga 1,5 miliar."

Jika data tidak tersedia:
"Data harga pasar untuk lokasi ini belum tersedia."

 PENTING: Hitung kata Anda! Maksimal 28 KATA!
PROMPT;

        return $this->generateContent($prompt);
    }

    public function getNearbyFacilitiesSummary(string $address): ?string
    {
        $prompt = <<<PROMPT
Anda adalah AI Expert Property yang bertugas mencari infrastruktur dan fasilitas di dalam area perumahan atau kompleks properti.


 AREA PERUMAHAN: "{$address}"


 ATURAN PENCARIAN KRITIS:


 CARI infrastruktur dan fasilitas di dalam area perumahan "{$address}" dengan akurat.
 JANGAN CARI di luar area perumahan "{$address}".
 Cantumkan 8-12 fasilitas/infrastruktur yang terbaik di dalam area perumahan "{$address}".

 JANGAN cari fasilitas di:
    Kecamatan 
    Kabupaten   
    Provinsi 
    Area di luar perumahan.


 KATEGORI FASILITAS (Prioritas yang terbaik):


1.  Internet Providers (dalam area)
2.  Transportasi Terdekat (halte, stasiun, terminal yang terdekat)
3.  Pendidikan (SD, SMP, SMA yang terbaik dan terdekat)
4.  Kesehatan (RS, Klinik, Puskesmas terbaik dan terdekat)
5.  Tempat Ibadah (Masjid, Gereja, dll dalam area)
6.  Komersial (Mall , Pasar, Kuliner, Minimarket di area perumahan)
7.  Keuangan (Bank, ATM di area perumahan)
8.  Rekreasi (Taman, Kolam Renang, GOR di area perumahan)
9.  Layanan Publik (Kantor Pos, Kelurahan di area perumahan)


 FORMAT OUTPUT (HTML List):


CONTOH OUTPUT YANG BENAR:
<ul>
<li>Internet: Myrepublic, FirstMedia, IndiHome</li>
<li>Transportasi: Halte Transjakarta, Stasiun KRL 2km</li>
<li>Pendidikan: BPK Penabur, SD Negeri 1 (500m), SMP Negeri 5 (1.2km)</li>
<li>Kesehatan: RS Hermina, RS Standard (1km), klinik Keluarga (400m)</li>
<li>Tempat Ibadah: Masjid Al-Ikhlas, Gereja HKBP (1km)</li>
<li>Komersial: Mall Laguboti, Alfamart (150m), Indomaret (300m), Giant (2km)</li>
<li>Keuangan: ATM BCA, Bank Standard Charter (1.5km)</li>
<li>Rekreasi: Taman Kota (600m), Lapangan Futsal (800m)</li>
<li>Layanan Publik: Kantor Pos (2.5km)</li>
</ul>

 ATURAN OUTPUT:


 LANGSUNG mulai dengan <ul>
 JANGAN tambahkan kata sambutan
 JANGAN tambahkan penjelasan
 Setiap <li> harus memiliki kategori dan nama fasilitas
 Pilih yang terbaik
 Cantumkan jarak jika tersedia

Jika tidak ada data:
<ul><li>Data fasilitas untuk area ini sedang tidak tersedia</li></ul>

PROMPT;

        return $this->generateContent($prompt);
    }

    public function askQuestion(string $prompt): ?string
    {
        return $this->generateContent($prompt);
    }

    protected function generateContent(string $prompt): ?string
    {
        if (empty($this->apiKey)) {
            Log::error('WaisakaAiService: GEMINI_API_KEY belum dikonfigurasi.');
            return null;
        }

        try {
            $response = Http::asJson()
                ->timeout($this->timeout > 0 ? $this->timeout : 60)
                ->retry($this->retries, 300)
                ->post($this->buildEndpoint(), [
                    'contents' => [
                        [
                            'parts' => [
                                ['text' => $prompt],
                            ],
                        ],
                    ],
                    'generationConfig' => [
                        'temperature' => 0.1,
                        'topP' => 0.8,
                        'maxOutputTokens' => 2048,
                    ],
                ])
                ->throw();
        } catch (RequestException $e) {
            Log::error('WaisakaAiService: Gemini API error', [
                'status' => optional($e->response)->status(),
                'body' => optional($e->response)->body(),
                'prompt_length' => strlen($prompt),
            ]);
            return null;
        } catch (\Throwable $e) {
            Log::error('WaisakaAiService: gagal terhubung ke Gemini', [
                'error' => $e->getMessage(),
                'timeout' => $this->timeout,
            ]);
            return null;
        }

        $data = $response->json();
        $text = $data['candidates'][0]['content']['parts'][0]['text'] ?? null;

        if (!$text) {
            Log::warning('WaisakaAiService: tidak ada teks yang dikembalikan', [
                'response' => $data,
                'model' => $this->model,
            ]);
            return null;
        }

        return trim($text);
    }

    protected function buildEndpoint(): string
    {
        return sprintf(
            '%s/models/%s:generateContent?key=%s',
            $this->baseUrl,
            $this->model,
            urlencode($this->apiKey)
        );
    }

    protected function decodeJson(string $raw): ?array
    {
        $raw = trim($raw);

        if (Str::startsWith($raw, '```')) {
            $raw = preg_replace('/^```[a-zA-Z0-9]*\n|\n```$/', '', $raw);
            $raw = trim((string) $raw);
        }

        if (!Str::startsWith($raw, '{')) {
            $start = strpos($raw, '{');
            $end = strrpos($raw, '}');
            if ($start === false || $end === false || $end <= $start) {
                return null;
            }
            $raw = substr($raw, $start, $end - $start + 1);
        }

        $decoded = json_decode($raw, true);

        return json_last_error() === JSON_ERROR_NONE ? $decoded : null;
    }
}

=== END OF FILE: Services\WaisakaAiService.php ===


=== TOTAL FILE DIGABUNGKAN: 93 ===